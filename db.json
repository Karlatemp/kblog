{"meta":{"version":1,"warehouse":"4.0.0"},"models":{"Asset":[{"_id":"node_modules/hexo-theme-butterfly/source/css/index.styl","path":"css/index.styl","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-butterfly/source/css/var.styl","path":"css/var.styl","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-butterfly/source/img/404.jpg","path":"img/404.jpg","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-butterfly/source/img/favicon.png","path":"img/favicon.png","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-butterfly/source/img/friend_404.gif","path":"img/friend_404.gif","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-butterfly/source/js/main.js","path":"js/main.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-butterfly/source/js/tw_cn.js","path":"js/tw_cn.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-butterfly/source/js/utils.js","path":"js/utils.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-butterfly/source/js/search/algolia.js","path":"js/search/algolia.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-butterfly/source/js/search/local-search.js","path":"js/search/local-search.js","modified":0,"renderable":1},{"_id":"source/static/imgs/loading.gif","path":"static/imgs/loading.gif","modified":0,"renderable":0},{"_id":"source/static/imgs/favicon.png","path":"static/imgs/favicon.png","modified":0,"renderable":0}],"Cache":[{"_id":"source/_data/link.yml","hash":"5b2dcd0e9ae680097837e7e182fd7e1e102dbb69","modified":1645625238638},{"_id":"source/_posts/hello-world.md","hash":"7e13919740de690f51cb2aa0022e8dbc5609af74","modified":1647093161943},{"_id":"source/about/about.md","hash":"4ff848c61247965e298a00046eaccae159cc137d","modified":1645625238638},{"_id":"source/categories/index.md","hash":"691c4a8008ef07b5c1871d82fb66a2cd1df2e283","modified":1645625238638},{"_id":"source/link/index.md","hash":"9026a064bf3d4b57249b216c11e40c36d48719d3","modified":1646843982997},{"_id":"source/tags/index.md","hash":"b118f8247d2b2a6a9e3a225a69b320fd21696140","modified":1645625238642},{"_id":"source/_posts/gh/autoreview.md","hash":"b5f032424952658391c4a12c662a44e56282458b","modified":1647093161943},{"_id":"source/_posts/jvm/dynmodule.md","hash":"1a80577522bf2767d80db5a8b6fb48612b6670b7","modified":1647093161943},{"_id":"source/_posts/jvm-root/unsafe.md","hash":"68a4578945d8fd7b555e4110c81fbfbc429fb37b","modified":1647093161943},{"_id":"source/static/css/no-rotate.css","hash":"b1faeaa28ca65173f3db842c5f337d6d7eb89fd5","modified":1645625238642},{"_id":"node_modules/hexo-theme-butterfly/LICENSE","hash":"1128f8f91104ba9ef98d37eea6523a888dcfa5de","modified":1645625246974},{"_id":"node_modules/hexo-theme-butterfly/README.md","hash":"6ee27baf95a5741abbc224ef8938d679b6597665","modified":1645625249014},{"_id":"node_modules/hexo-theme-butterfly/README_CN.md","hash":"49ace5208f98783344f17a00adab7641cda43280","modified":1645625248994},{"_id":"node_modules/hexo-theme-butterfly/_config.yml","hash":"8239544985a87481bf4c6c4775e8a3b4745d0bcb","modified":1645625249434},{"_id":"node_modules/hexo-theme-butterfly/package.json","hash":"4577d39a6d79a18b5c4f57bf68f68edefbf407ab","modified":1645625248954},{"_id":"node_modules/hexo-theme-butterfly/.github/stale.yml","hash":"05a55a87fa7f122c59683e41c8b2e37e79f688f0","modified":1645625249446},{"_id":"node_modules/hexo-theme-butterfly/languages/default.yml","hash":"7fd2950554e99a6f15232267621f36f026a85380","modified":1645625249438},{"_id":"node_modules/hexo-theme-butterfly/languages/en.yml","hash":"4b2c351f2b5fd4f8497e806085364928e1af0b5b","modified":1645625249438},{"_id":"node_modules/hexo-theme-butterfly/languages/zh-CN.yml","hash":"6c35255c196ea8e9817b85b6d7729d00cf18f231","modified":1645625249446},{"_id":"node_modules/hexo-theme-butterfly/languages/zh-TW.yml","hash":"ef035065ebb37fce3e56e51f8b56deb596db78b2","modified":1645625249450},{"_id":"node_modules/hexo-theme-butterfly/layout/archive.pug","hash":"bd62286afb64a51c97e800c5945620d51605d5fa","modified":1645625249118},{"_id":"node_modules/hexo-theme-butterfly/layout/category.pug","hash":"710708cfdb436bc875602abf096c919ccdf544db","modified":1645625249166},{"_id":"node_modules/hexo-theme-butterfly/layout/index.pug","hash":"e1c3146834c16e6077406180858add0a8183875a","modified":1645625249230},{"_id":"node_modules/hexo-theme-butterfly/layout/page.pug","hash":"baf469784aef227e4cc840550888554588e87a13","modified":1645625249250},{"_id":"node_modules/hexo-theme-butterfly/layout/post.pug","hash":"fc9f45252d78fcd15e4a82bfd144401cba5b169a","modified":1645625249270},{"_id":"node_modules/hexo-theme-butterfly/layout/tag.pug","hash":"0440f42569df2676273c026a92384fa7729bc4e9","modified":1645625249294},{"_id":"node_modules/hexo-theme-butterfly/.github/ISSUE_TEMPLATE/bug_report.md","hash":"476802922b774b679225102ac30a9d9183394701","modified":1645625248966},{"_id":"node_modules/hexo-theme-butterfly/.github/ISSUE_TEMPLATE/custom.md","hash":"eff495eb1584cf4586e33c76e8b2fa6a469a179b","modified":1645625248966},{"_id":"node_modules/hexo-theme-butterfly/.github/ISSUE_TEMPLATE/feature_request.md","hash":"f6867a2f0417fe89a0f2008730ee19dd38422021","modified":1645625248974},{"_id":"node_modules/hexo-theme-butterfly/.github/workflows/publish.yml","hash":"05857c2f265246d8de00e31037f2720709540c09","modified":1645625249438},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/404.pug","hash":"cb49f737aca272ccfeb62880bd651eccee72a129","modified":1645625249038},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/additional-js.pug","hash":"ab3bdeb6e0acd3d58091698c1335afb069eea7e5","modified":1645625249058},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/footer.pug","hash":"02390a5b6ae1f57497b22ba2e6be9f13cfb7acac","modified":1645625249202},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/head.pug","hash":"847a5cbc13db1a435a4f762a7c0007d9bcbb79a2","modified":1645625249214},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/layout.pug","hash":"6f2608c4d93d3d10ae6b2cd7f8918f303f024321","modified":1645625249234},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/pagination.pug","hash":"0b80f04950bd0fe5e6c4e7b7559adf4d0ce28436","modified":1645625249254},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/rightside.pug","hash":"699d0d2cff233628752956c4434125c8203f7d63","modified":1645625249286},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/sidebar.pug","hash":"f093ab771257a6a939b194f68607a2038c8d7da3","modified":1645625249290},{"_id":"node_modules/hexo-theme-butterfly/scripts/events/404.js","hash":"83cd7f73225ccad123afbd526ce1834eb1eb6a6d","modified":1645625248006},{"_id":"node_modules/hexo-theme-butterfly/scripts/events/config.js","hash":"a72c2020c87c4998aa124a16e9f8560875b9f86d","modified":1645625248614},{"_id":"node_modules/hexo-theme-butterfly/scripts/events/init.js","hash":"a7f567b3d3110afe2f99c967b8e15351a7f5bd6d","modified":1645625248670},{"_id":"node_modules/hexo-theme-butterfly/scripts/events/stylus.js","hash":"9819f0996234fbd80d6c50a9e526c56ebf22588d","modified":1645625248890},{"_id":"node_modules/hexo-theme-butterfly/scripts/events/welcome.js","hash":"3cfc46c749e2fd7ae9c2a17206238ed0e0e17e7d","modified":1645625248946},{"_id":"node_modules/hexo-theme-butterfly/scripts/filters/post_lazyload.js","hash":"932df912976261929f809b7dbd4eb473e7787345","modified":1645625248874},{"_id":"node_modules/hexo-theme-butterfly/scripts/filters/random_cover.js","hash":"21379ed2dccb69c43b893895c9d56238c11e5f43","modified":1645625248886},{"_id":"node_modules/hexo-theme-butterfly/scripts/helpers/aside_archives.js","hash":"2ec66513d5322f185d2071acc052978ba9415a8e","modified":1645625248390},{"_id":"node_modules/hexo-theme-butterfly/scripts/helpers/aside_categories.js","hash":"e00efdb5d02bc5c6eb4159e498af69fa61a7dbb9","modified":1645625248478},{"_id":"node_modules/hexo-theme-butterfly/scripts/helpers/inject_head_js.js","hash":"6a103a2472903289bdecd5240eb89cac0b9e13d9","modified":1645625248690},{"_id":"node_modules/hexo-theme-butterfly/scripts/helpers/page.js","hash":"c6611d97087c51845cb1ab4821696a62fa33daeb","modified":1645625248842},{"_id":"node_modules/hexo-theme-butterfly/scripts/helpers/related_post.js","hash":"21556f9cb412ddc500ad12ecfd419f3ea6c9f663","modified":1645625248890},{"_id":"node_modules/hexo-theme-butterfly/scripts/tag/button.js","hash":"91d954f6e9fe6e571eb8ec9f8996294b2dc3688e","modified":1645625248594},{"_id":"node_modules/hexo-theme-butterfly/scripts/tag/flink.js","hash":"ab62919fa567b95fbe14889517abda649991b1ee","modified":1645625248630},{"_id":"node_modules/hexo-theme-butterfly/scripts/tag/gallery.js","hash":"f79c99f6c5b626c272dc2bed2b0250d6b91bb28a","modified":1645625248658},{"_id":"node_modules/hexo-theme-butterfly/scripts/tag/hide.js","hash":"396c3ab1bcf1c7693ad7e506eadd13016c6769b6","modified":1645625248662},{"_id":"node_modules/hexo-theme-butterfly/scripts/tag/inlineImg.js","hash":"a43ee2c7871bdd93cb6beb804429e404570f7929","modified":1645625248706},{"_id":"node_modules/hexo-theme-butterfly/scripts/tag/label.js","hash":"03b2afef41d02bd1045c89578a02402c28356006","modified":1645625248726},{"_id":"node_modules/hexo-theme-butterfly/scripts/tag/mermaid.js","hash":"531808a290b8bdd66bac2faab211ada8e9646a37","modified":1645625248830},{"_id":"node_modules/hexo-theme-butterfly/scripts/tag/note.js","hash":"c16c6eb058af2b36bcd583b2591076c7ebdd51ad","modified":1645625248834},{"_id":"node_modules/hexo-theme-butterfly/scripts/tag/tabs.js","hash":"6c6e415623d0fd39da016d9e353bb4f5cca444f5","modified":1645625248898},{"_id":"node_modules/hexo-theme-butterfly/scripts/tag/timeline.js","hash":"300eb779588bf35a1b687d9f829d866074b707e3","modified":1645625248914},{"_id":"node_modules/hexo-theme-butterfly/source/css/index.styl","hash":"861998e4ac67a59529a8245a9130d68f826c9c12","modified":1645625249422},{"_id":"node_modules/hexo-theme-butterfly/source/css/var.styl","hash":"4890a40366d6443f8b8942a4e9a6dce9fe3494f5","modified":1645625249434},{"_id":"node_modules/hexo-theme-butterfly/source/img/404.jpg","hash":"fb4489bc1d30c93d28f7332158c1c6c1416148de","modified":1645625247838},{"_id":"node_modules/hexo-theme-butterfly/source/img/favicon.png","hash":"3cf89864b4f6c9b532522a4d260a2e887971c92d","modified":1645625249026},{"_id":"node_modules/hexo-theme-butterfly/source/img/friend_404.gif","hash":"8d2d0ebef70a8eb07329f57e645889b0e420fa48","modified":1645625247682},{"_id":"node_modules/hexo-theme-butterfly/source/js/main.js","hash":"04efcbd28b37875cfec88eb87cab7256a9ebb327","modified":1645625248822},{"_id":"node_modules/hexo-theme-butterfly/source/js/tw_cn.js","hash":"00053ce73210274b3679f42607edef1206eebc68","modified":1645625248926},{"_id":"node_modules/hexo-theme-butterfly/source/js/utils.js","hash":"0b95daada72abb5d64a1e3236049a60120e47cca","modified":1645625248938},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/head/Open_Graph.pug","hash":"6c41f49a3e682067533dd9384e6e4511fc3a1349","modified":1645625249246},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/head/analytics.pug","hash":"15530d9ac59c576d79af75dd687efe71e8d261b0","modified":1645625249098},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/head/config.pug","hash":"9e58c80af8bbd0c66ccb4f94d3781818cebf0d66","modified":1645625249178},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/head/config_site.pug","hash":"7df90c8e432e33716517ab918b0a125bc284041b","modified":1645625249170},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/head/google_adsense.pug","hash":"95a37e92b39c44bcbea4be7e29ddb3921c5b8220","modified":1645625249214},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/head/noscript.pug","hash":"d16ad2ee0ff5751fd7f8a5ce1b83935518674977","modified":1645625249246},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/head/preconnect.pug","hash":"65a23b5170204e55b813ce13a79d799b66b7382c","modified":1645625249270},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/head/pwa.pug","hash":"3d492cfe645d37c94d30512e0b230b0a09913148","modified":1645625249286},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/head/site_verification.pug","hash":"e2e8d681f183f00ce5ee239c42d2e36b3744daad","modified":1645625249290},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/header/index.pug","hash":"65fa23680af0daf64930a399c2f2ca37809a8149","modified":1645625249218},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/header/menu_item.pug","hash":"31346a210f4f9912c5b29f51d8f659913492f388","modified":1645625249242},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/header/nav.pug","hash":"78a3abd90bb3c18cd773d3d5abac3541e7f415e5","modified":1645625249246},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/header/post-info.pug","hash":"dc3913c1a6dd207051c3d3414a33851ae8bc0a45","modified":1645625249266},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/header/social.pug","hash":"0d953e51d04a9294a64153c89c20f491a9ec42d4","modified":1645625249294},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/loading/loading-js.pug","hash":"4cfcf0100e37ce91864703cd44f1cb99cb5493ea","modified":1645625249234},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/loading/loading.pug","hash":"5276937fbcceb9d62879dc47be880cd469a27349","modified":1645625249238},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/mixins/article-sort.pug","hash":"2fb74d0b0e4b98749427c5a1a1b0acb6c85fadc4","modified":1645625249122},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/mixins/post-ui.pug","hash":"b9ebb02af8ccf43e3f73be43db19254fa913c57b","modified":1645625249270},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/page/categories.pug","hash":"5276a8d2835e05bd535fedc9f593a0ce8c3e8437","modified":1645625249158},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/page/default-page.pug","hash":"12c65c174d26a41821df9bad26cdf1087ec5b0ca","modified":1645625249186},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/page/flink.pug","hash":"fed069baa9b383f57db32bb631115071d29bdc60","modified":1645625249202},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/page/tags.pug","hash":"6311eda08e4515281c51bd49f43902a51832383c","modified":1645625249294},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/post/post-copyright.pug","hash":"88e3b611b03149665e4113cfa39595c1a3fca7e5","modified":1645625249266},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/post/reward.pug","hash":"864869c43fe5b5bb6f4ac6b13dd4bfb16ea47550","modified":1645625249286},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/aplayer.pug","hash":"292646dfab135973b09f0fa9e3931e83da2ed30e","modified":1645625249106},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/effect.pug","hash":"b9d54a01d7c2a7a183cb7209e99430ce7fea1fe3","modified":1645625249198},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/pangu.pug","hash":"d5fec7dedc52ab23865fb4db002755e9bdaadc9f","modified":1645625249258},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/pjax.pug","hash":"d4072f9ab79f4ac49aa251ae470abc45a2fddbd6","modified":1645625249258},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/prismjs.pug","hash":"1fbecfd299068f90d727f0c8c65e2a792fa6e3e2","modified":1645625249286},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/subtitle.pug","hash":"b63fd8ec48d782f51ee11226753fed1998bbf34a","modified":1645625249294},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/widget/card_ad.pug","hash":"60dc48a7b5d89c2a49123c3fc5893ab9c57dd225","modified":1645625249126},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/widget/card_announcement.pug","hash":"ae392459ad401a083ca51ee0b27526b3c1e1faed","modified":1645625249130},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/widget/card_archives.pug","hash":"86897010fe71503e239887fd8f6a4f5851737be9","modified":1645625249134},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/widget/card_author.pug","hash":"0380a1e048e6219ea4b4a8a4eadba960edf308f0","modified":1645625249134},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/widget/card_bottom_self.pug","hash":"13dc8ce922e2e2332fe6ad5856ebb5dbf9ea4444","modified":1645625249138},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/widget/card_categories.pug","hash":"d1a416d0a8a7916d0b1a41d73adc66f8c811e493","modified":1645625249138},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/widget/card_newest_comment.pug","hash":"6d93564a8bd13cb9b52ee5e178db3bcbf18b1bc6","modified":1645625249142},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/widget/card_post_toc.pug","hash":"3057a2f6f051355e35d3b205121af8735100eacf","modified":1645625249142},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/widget/card_recent_post.pug","hash":"9c1229af6ab48961021886882c473514101fba21","modified":1645625249150},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/widget/card_tags.pug","hash":"438aea3e713ed16b7559b9a80a9c5ec0221263df","modified":1645625249154},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/widget/card_top_self.pug","hash":"ae67c6d4130a6c075058a9c1faea1648bcc6f83e","modified":1645625249154},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/widget/card_webinfo.pug","hash":"0612aaee878f33ea8d3da0293c7dc3b6cd871466","modified":1645625249158},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/widget/index.pug","hash":"7fb096656c8a6c21a4b6a5100885b1081d6021ed","modified":1645625249230},{"_id":"node_modules/hexo-theme-butterfly/source/css/_global/function.styl","hash":"f7fd855593396b30932a06627287a73a407aff88","modified":1645625249394},{"_id":"node_modules/hexo-theme-butterfly/source/css/_global/index.styl","hash":"714f19e7d66df84938bd1b82b33d5667abe1f147","modified":1645625249410},{"_id":"node_modules/hexo-theme-butterfly/source/css/_highlight/highlight.styl","hash":"2f95e99b8351fbecd9037a1bbdc3fee9d6ea8a77","modified":1645625249406},{"_id":"node_modules/hexo-theme-butterfly/source/css/_highlight/theme.styl","hash":"bcd384c8b2aa0390c9eb69ac1abbfd1240ce1da4","modified":1645625249426},{"_id":"node_modules/hexo-theme-butterfly/source/css/_layout/aside.styl","hash":"2d3b0386c8b62a61734e10bab2cf86842cbb1673","modified":1645625249354},{"_id":"node_modules/hexo-theme-butterfly/source/css/_layout/chat.styl","hash":"29f48f9370f245e6e575b5836bccf47eb5688d8b","modified":1645625249362},{"_id":"node_modules/hexo-theme-butterfly/source/css/_layout/comments.styl","hash":"c61dccca690d486c3d9c29cf028d87b777385141","modified":1645625249362},{"_id":"node_modules/hexo-theme-butterfly/source/css/_layout/pagination.styl","hash":"fb9f78bfbb79579f1d752cb73fb6d25c8418e0fd","modified":1645625249422},{"_id":"node_modules/hexo-theme-butterfly/source/css/_layout/post.styl","hash":"84d4f27fde933bdf839629eb3bddcbc0f4592836","modified":1645625249422},{"_id":"node_modules/hexo-theme-butterfly/source/css/_layout/relatedposts.styl","hash":"d53de408cb27a2e704aba7f7402b7caebe0410d8","modified":1645625249426},{"_id":"node_modules/hexo-theme-butterfly/source/css/_layout/reward.styl","hash":"c5cfed620708807a48076b5ee59b0ba84e29aa80","modified":1645625249426},{"_id":"node_modules/hexo-theme-butterfly/source/css/_layout/rightside.styl","hash":"bd88ee30ebf8ca2e7b4d3a034c317fd61733921f","modified":1645625249426},{"_id":"node_modules/hexo-theme-butterfly/source/css/_layout/sidebar.styl","hash":"1bcbc80dff19cd53d0b367c3b9a3c751d3a1f10d","modified":1645625249426},{"_id":"node_modules/hexo-theme-butterfly/source/css/_layout/third-party.styl","hash":"e5008f43897d8482b4831cd4c13a0af40e496762","modified":1645625249426},{"_id":"node_modules/hexo-theme-butterfly/source/css/_mode/darkmode.styl","hash":"f67177310f5594954b25a591d186d28d5d450b18","modified":1645625249374},{"_id":"node_modules/hexo-theme-butterfly/source/css/_mode/readmode.styl","hash":"69f8e9414526dfda3af9a71c8e528fdd0ecbbfe5","modified":1645625249426},{"_id":"node_modules/hexo-theme-butterfly/source/css/_page/404.styl","hash":"50dbb9e6d98c71ffe16741b8c1b0c1b9771efd2b","modified":1645625249330},{"_id":"node_modules/hexo-theme-butterfly/source/css/_page/archives.styl","hash":"6f4b4ede52305bce9b22c8c897dcbde8af6e2ce4","modified":1645625249342},{"_id":"node_modules/hexo-theme-butterfly/source/css/_page/categories.styl","hash":"f01ee74948cedb44e53cd3bb1ef36b7d2778ede7","modified":1645625249362},{"_id":"node_modules/hexo-theme-butterfly/source/css/_page/common.styl","hash":"a58d35d698885f1034dedbe99f7dbc1a801412c6","modified":1645625249366},{"_id":"node_modules/hexo-theme-butterfly/source/css/_page/flink.styl","hash":"98d755b686ee833e9da10afaa40c4ec2bd66c19a","modified":1645625249386},{"_id":"node_modules/hexo-theme-butterfly/source/css/_page/homepage.styl","hash":"826dae759062d8f84eb2bf5ab8fdb80e0f79d58b","modified":1645625249406},{"_id":"node_modules/hexo-theme-butterfly/source/css/_page/tags.styl","hash":"580feb7e8b0822a1be48ac380f8c5c53b1523321","modified":1645625249426},{"_id":"node_modules/hexo-theme-butterfly/source/css/_search/algolia.styl","hash":"656f9007d94cf29a20532705d94fb7f22827e6fe","modified":1645625249342},{"_id":"node_modules/hexo-theme-butterfly/source/css/_search/index.styl","hash":"0290605c4984882990059eefe3ad18d2ac6a19ef","modified":1645625249414},{"_id":"node_modules/hexo-theme-butterfly/source/css/_search/local-search.styl","hash":"e4c987c0202162b50dec91e1df74665d0fa933c9","modified":1645625249422},{"_id":"node_modules/hexo-theme-butterfly/source/css/_tags/button.styl","hash":"45f0c32bdea117540f6b14ebac6450d7142bd710","modified":1645625249362},{"_id":"node_modules/hexo-theme-butterfly/source/css/_tags/gallery.styl","hash":"a310e48f826a4cacc55d8e68f43806e5085554f6","modified":1645625249402},{"_id":"node_modules/hexo-theme-butterfly/source/css/_tags/hexo.styl","hash":"d76c38adf1d9c1279ef4241835667789f5b736e0","modified":1645625249402},{"_id":"node_modules/hexo-theme-butterfly/source/css/_tags/hide.styl","hash":"ce489ca2e249e2a3cf71584e20d84bdb022e3475","modified":1645625249402},{"_id":"node_modules/hexo-theme-butterfly/source/css/_tags/inlineImg.styl","hash":"df9d405c33a9a68946b530410f64096bcb72560c","modified":1645625249422},{"_id":"node_modules/hexo-theme-butterfly/source/css/_tags/label.styl","hash":"66c59e193d794cdb02cca7bd1dc4aea5a19d7e84","modified":1645625249422},{"_id":"node_modules/hexo-theme-butterfly/source/css/_tags/note.styl","hash":"08493b66b9f31f2bd3e9a3115017a0ce16142b20","modified":1645625249422},{"_id":"node_modules/hexo-theme-butterfly/source/css/_tags/tabs.styl","hash":"bf9568444dd54e39dc59b461323dcd38942f27d9","modified":1645625249426},{"_id":"node_modules/hexo-theme-butterfly/source/css/_tags/timeline.styl","hash":"f071156d439556e7463ed4bc61ceee87170d5d08","modified":1645625249426},{"_id":"node_modules/hexo-theme-butterfly/source/css/_third-party/normalize.min.css","hash":"2c18a1c9604af475b4749def8f1959df88d8b276","modified":1645625247170},{"_id":"node_modules/hexo-theme-butterfly/source/js/search/algolia.js","hash":"aaa5e44125dcf321866bc2355a73773b11db8c9c","modified":1645625248178},{"_id":"node_modules/hexo-theme-butterfly/source/js/search/local-search.js","hash":"ec62117f38e095425f295b1170c222c7a1399425","modified":1645625248738},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/card-post-count/disqus.pug","hash":"d85c3737b5c9548553a78b757a7698df126a52cf","modified":1645625249190},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/card-post-count/fb.pug","hash":"7848ec58c6ec03243abf80a3b22b4dc10f3edf53","modified":1645625249202},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/card-post-count/index.pug","hash":"e3bf847553515174f6085df982f0623e9783db7a","modified":1645625249218},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/card-post-count/twikoo.pug","hash":"ef1b2b5b980d6aeaa5d06b97d1afc9644b155a16","modified":1645625249302},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/card-post-count/valine.pug","hash":"bba9871f446c10ffcc8fa9023f5a2eb701a86bae","modified":1645625249302},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/card-post-count/waline.pug","hash":"400ce038548d6f9ddb486150c724c87b6923a88b","modified":1645625249314},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/chat/chatra.pug","hash":"481cd5053bafb1a19f623554a27d3aa077ea59c3","modified":1645625249170},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/chat/crisp.pug","hash":"76634112c64023177260d1317ae39cef2a68e35f","modified":1645625249182},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/chat/daovoice.pug","hash":"cfe63e7d26a6665df6aa32ca90868ad48e05ec04","modified":1645625249186},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/chat/gitter.pug","hash":"d1d2474420bf4edc2e43ccdff6f92b8b082143df","modified":1645625249214},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/chat/index.pug","hash":"3f05f8311ae559d768ee3d0925e84ed767c314d3","modified":1645625249218},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/chat/tidio.pug","hash":"24a926756c2300b9c561aaab6bd3a71fdd16e16d","modified":1645625249294},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/comments/disqus.pug","hash":"a111407fdcafcf1099e26ffa69786f8822c5d9fb","modified":1645625249194},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/comments/disqusjs.pug","hash":"143236e395c18d80ab8dc794821eb337c85f6b32","modified":1645625249194},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/comments/facebook_comments.pug","hash":"fe684aaad4c99b908dc4499c85afd9a2cd893aae","modified":1645625249198},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/comments/giscus.pug","hash":"0764709381fa29778f6390d645ed137d2f91228f","modified":1645625249202},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/comments/gitalk.pug","hash":"9c96e6e67931977268b218b99084b98597c2e42b","modified":1645625249206},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/comments/index.pug","hash":"e4850f2c9ba5f6b2248808f7257662679e0fab0a","modified":1645625249222},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/comments/js.pug","hash":"9302837f1e35f153323bb4f166514c7e96e8ecdd","modified":1645625249230},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/comments/livere.pug","hash":"52ea8aa26b84d3ad38ae28cdf0f163e9ca8dced7","modified":1645625249234},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/comments/twikoo.pug","hash":"c271cacbac14ed665bbf47aa9c6e74e94c69dcef","modified":1645625249302},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/comments/utterances.pug","hash":"c1c75abe5c899618ed6699c97ac999544840098a","modified":1645625249302},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/comments/valine.pug","hash":"59c22ebf3aaee90152e7cdb17ff5841c888fcd82","modified":1645625249306},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/comments/waline.pug","hash":"7648e4cb0b224f480b5f1356d64f62c9235f6723","modified":1645625249314},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/math/index.pug","hash":"b8ae5fd7d74e1edcef21f5004fc96147e064d219","modified":1645625249222},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/math/katex.pug","hash":"f9b00ead54573ba6e6eb33481588af144aab648d","modified":1645625249230},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/math/mathjax.pug","hash":"a47d8f9f593091cc91192c0c49deaa2c0d2317fd","modified":1645625249242},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/math/mermaid.pug","hash":"0a7587a0211011b5942edba2aa80d51169561d30","modified":1645625249246},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/newest-comments/disqus-comment.pug","hash":"04b2a5882e789a988e41d45abe606f0617b08e38","modified":1645625249186},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/newest-comments/github-issues.pug","hash":"e846ddfe4a63b15d1416f6055f5756af5e3da7c6","modified":1645625249210},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/newest-comments/index.pug","hash":"f6506ccfd1ce994b9e53aa95588d0b6dbad11411","modified":1645625249222},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/newest-comments/twikoo-comment.pug","hash":"ac811c1d6e0bf08aeb933ade1b9557e0c560d0c9","modified":1645625249298},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/newest-comments/valine.pug","hash":"9028efac78e4122acd734edd5ef9110ef3f05cd1","modified":1645625249306},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/newest-comments/waline.pug","hash":"5e32d903903c76db55a625640f9417d15a3a312f","modified":1645625249314},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/search/algolia.pug","hash":"c92df4f9d0611cf44c1a4491e226f242ec80f5bb","modified":1645625249074},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/search/index.pug","hash":"da3b9437d061ee68dbc383057db5c73034c49605","modified":1645625249226},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/search/local-search.pug","hash":"8ce336a4c8cae81b58ee26ff51040ca650ff1519","modified":1645625249238},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/share/add-this.pug","hash":"2980f1889226ca981aa23b8eb1853fde26dcf89a","modified":1645625249054},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/share/addtoany.pug","hash":"309f51bc5302e72fc469d54c577fbcfe57fb07a8","modified":1645625249058},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/share/index.pug","hash":"4c4a9c15215ae8ac5eadb0e086b278f76db9ee92","modified":1645625249226},{"_id":"node_modules/hexo-theme-butterfly/layout/includes/third-party/share/share-js.pug","hash":"006acc91ce25fc7c7d778ca043e970f57dc46b83","modified":1645625249290},{"_id":"node_modules/hexo-theme-butterfly/source/css/_highlight/highlight/diff.styl","hash":"cf1fae641c927621a4df1be5ca4a853b9b526e23","modified":1645625249382},{"_id":"node_modules/hexo-theme-butterfly/source/css/_highlight/highlight/index.styl","hash":"18804c58239d95798fa86d0597f32d7f7dd30051","modified":1645625249414},{"_id":"node_modules/hexo-theme-butterfly/source/css/_highlight/prismjs/diff.styl","hash":"5972c61f5125068cbe0af279a0c93a54847fdc3b","modified":1645625249386},{"_id":"node_modules/hexo-theme-butterfly/source/css/_highlight/prismjs/index.styl","hash":"5dc2e0bcae9a54bfb9bdcc82d02ae5a3cf1ca97d","modified":1645625249414},{"_id":"node_modules/hexo-theme-butterfly/source/css/_highlight/prismjs/line-number.styl","hash":"8970cc1916c982b64a1478792b2822d1d31e276d","modified":1645625249422},{"_id":"node_modules/hexo-theme-butterfly/source/css/_layout/loading.styl","hash":"ef21990de28bd75dcd0f88b8d616e1a7a137502f","modified":1645625249422},{"_id":"node_modules/hexo-theme-butterfly/source/css/_layout/head.styl","hash":"d97c1722ce0fcc319f1f90ec2d51f9d746748e2b","modified":1645625249402},{"_id":"node_modules/hexo-theme-butterfly/source/css/_layout/footer.styl","hash":"26be2afa9d4e7016cf3c42a6cd166f01e8e4ad5c","modified":1645625249386},{"_id":"source/static/imgs/loading.gif","hash":"27765df6582fe5ce3b31a686d6016122cf23b460","modified":1645625238642},{"_id":"public/static/css/no-rotate.css","hash":"b1faeaa28ca65173f3db842c5f337d6d7eb89fd5","modified":1654160483438},{"_id":"public/about/about.html","hash":"6a35c5b25aa93a5d60423154dc961d03f37c36f6","modified":1645625250646},{"_id":"public/categories/index.html","hash":"a38f4ac2e25cdc36a93d7dee40605d68620b3fd3","modified":1654160483438},{"_id":"public/link/index.html","hash":"6f593ea136f59b4c039192507bd1e835bd21c918","modified":1654160483438},{"_id":"public/tags/index.html","hash":"e12aab62bd0e43e891803cc70b5ed073d67f46da","modified":1654160483438},{"_id":"public/p/hello-world/index.html","hash":"9a7402517358f10725bddda61c046e8b69c7b9f1","modified":1654160483438},{"_id":"public/categories/github/index.html","hash":"c4a2ec2ab4ed8c6dd856bcb7f4e328dcb7b8e21c","modified":1654160483438},{"_id":"public/categories/jvm/index.html","hash":"e9a7a612744d41d40f1f7143f6af5d8642fb065a","modified":1654160483438},{"_id":"public/tags/github/index.html","hash":"83d0555ac76cae6e5db64128f62b8968366c59f3","modified":1654160483438},{"_id":"public/tags/pr/index.html","hash":"8f964f57ced83f1eb01b9aeb17361239ff3d356e","modified":1654160483438},{"_id":"public/tags/review/index.html","hash":"1ac9fb2760fa8ef9426b1a3a866142a864409db9","modified":1654160483438},{"_id":"public/tags/jvm/index.html","hash":"870ccce7303278830eabf4a24eaa7c035548722f","modified":1654160483438},{"_id":"public/tags/jdk9/index.html","hash":"f57ff7fa536880e84ec37a8e6564f837c2708bb4","modified":1654160483438},{"_id":"public/tags/root/index.html","hash":"a3dc1ddeb02ecc6f383c777086b9850bf1d70f6b","modified":1654160483438},{"_id":"public/p/gh/autoreview/index.html","hash":"d3c425770654b1b7dfabd18a85f0c338aa2be63b","modified":1654160483438},{"_id":"public/p/jvm/dynmodule/index.html","hash":"a97189e34f528b26f025b5a41f439e56acf406ca","modified":1654160483438},{"_id":"public/p/jvm-root/unsafe/index.html","hash":"d0a39cbe53c877195c19c68ca0c3e1a0cabfaf7f","modified":1654160483438},{"_id":"public/archives/index.html","hash":"571d1360f99edb0ec30abf852d70f2aa5c83bfef","modified":1654160483438},{"_id":"public/archives/2022/index.html","hash":"45a5f357a35441366a5cb1e0ecb655912167cb55","modified":1654160483438},{"_id":"public/archives/2022/02/index.html","hash":"ab80a445182a2742ddc27dc7ac3f57b7fed9a105","modified":1654160483438},{"_id":"public/index.html","hash":"6397d00150d5f1fa6401a1cbeb7da317dc24cfe5","modified":1654160483438},{"_id":"public/img/404.jpg","hash":"fb4489bc1d30c93d28f7332158c1c6c1416148de","modified":1654160483438},{"_id":"public/img/favicon.png","hash":"3cf89864b4f6c9b532522a4d260a2e887971c92d","modified":1654160483438},{"_id":"public/img/friend_404.gif","hash":"8d2d0ebef70a8eb07329f57e645889b0e420fa48","modified":1654160483438},{"_id":"public/css/var.css","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1654160483438},{"_id":"public/js/utils.js","hash":"0b95daada72abb5d64a1e3236049a60120e47cca","modified":1654160483438},{"_id":"public/js/search/algolia.js","hash":"aaa5e44125dcf321866bc2355a73773b11db8c9c","modified":1654160483438},{"_id":"public/js/search/local-search.js","hash":"ec62117f38e095425f295b1170c222c7a1399425","modified":1654160483438},{"_id":"public/css/index.css","hash":"fdc28ae7e92a7022a5bc569c5c0c8bafcba17196","modified":1654160483438},{"_id":"public/js/main.js","hash":"04efcbd28b37875cfec88eb87cab7256a9ebb327","modified":1654160483438},{"_id":"public/js/tw_cn.js","hash":"00053ce73210274b3679f42607edef1206eebc68","modified":1654160483438},{"_id":"public/static/imgs/loading.gif","hash":"27765df6582fe5ce3b31a686d6016122cf23b460","modified":1654160483438},{"_id":"source/about/index.md","hash":"bae5581f59faa05720e0ea15bd06054470c43d50","modified":1654160463978},{"_id":"public/about/index.html","hash":"f72ac9309c734c27d2a388584a0c8337b5e59449","modified":1654160483438},{"_id":"source/static/imgs/favicon.png","hash":"c567c881284195fee23b037bcfb646e30638a60f","modified":1646843982997},{"_id":"node_modules/hexo-theme-butterfly/layout/kar/404.pug","hash":"d97ea3f2ecb0d96b70be9d359c7a5cba8f088d6d","modified":1646843983001},{"_id":"public/404.html","hash":"392b746398ac1815e6b1fadf841da5dff63e3669","modified":1654160483438},{"_id":"public/static/imgs/favicon.png","hash":"c567c881284195fee23b037bcfb646e30638a60f","modified":1654160483438},{"_id":"source/_posts/jvm/jdk-foreign.md","hash":"a338f49a4a03c500c0c0fbb5fe84c7c99b5fb018","modified":1647093161943},{"_id":"node_modules/hexo-theme-butterfly/layout/kar/raw.pug","hash":"1de6641ab02106073b24fc28d97b91b55570fc4a","modified":1647093161947},{"_id":"public/archives/2022/03/index.html","hash":"41055f19644175c8291b8964d8dfc8acc5f6c1b3","modified":1654160483438},{"_id":"public/tags/jdk-foreign/index.html","hash":"7e0a928ab591432ab10b4bd3f3b5e4b7adc96188","modified":1654160483438},{"_id":"public/p/jvm/jdk-foreign/index.html","hash":"daaa0cba5f6b7255700cd5bfac30f02407b55ac8","modified":1654160483438},{"_id":"source/_posts/tls/sub-cert-with-ca.md","hash":"8da0748b1a7b1da0dad3e645ef5ab95326f15e7c","modified":1654160463978},{"_id":"public/archives/2022/06/index.html","hash":"37e2343dbdd7ddef6791d276f9dfc1394447eefe","modified":1654160483438},{"_id":"public/p/tls/sub-cert-with-ca/index.html","hash":"50bb4466023bf812f6eb62d263f83bbfd982992e","modified":1654160483438}],"Category":[{"name":"github","_id":"ckzzmscpo0006b5oe2asi27ok"},{"name":"jvm","_id":"ckzzmscps000bb5oe1chj0is9"}],"Data":[{"_id":"link","data":[{"class_name":"友情链接","class_desc":"友情链接","link_list":[{"name":"暂无","link":"","avatar":"","descr":"暂无"}]}]}],"Page":[{"title":"Categories","date":"2022-02-22T10:23:16.000Z","type":"categories","_content":"","source":"categories/index.md","raw":"---\ntitle: Categories\ndate: 2022-02-22 18:23:16\ntype: \"categories\"\n---\n","updated":"2022-02-23T14:07:18.638Z","path":"categories/index.html","comments":1,"layout":"page","_id":"ckzzmscpk0002b5oe3sitgxam","content":"","site":{"data":{"link":[{"class_name":"友情链接","class_desc":"友情链接","link_list":[{"name":"暂无","link":"","avatar":"","descr":"暂无"}]}]}},"cover":"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7","excerpt":"","more":""},{"title":"Friend links","date":"2022-02-22T10:25:22.000Z","type":"link","aside":false,"_content":"","source":"link/index.md","raw":"---\ntitle: Friend links\ndate: 2022-02-22 18:25:22\ntype: \"link\"\naside: false\n---\n","updated":"2022-03-09T16:39:42.997Z","path":"link/index.html","_id":"ckzzmscpm0004b5oe5q45eknx","comments":1,"layout":"page","content":"","site":{"data":{"link":[{"class_name":"友情链接","class_desc":"友情链接","link_list":[{"name":"暂无","link":"","avatar":"","descr":"暂无"}]}]}},"cover":"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7","excerpt":"","more":""},{"title":"Tags","date":"2022-02-22T10:30:38.000Z","type":"tags","_content":"","source":"tags/index.md","raw":"---\ntitle: Tags\ndate: 2022-02-22 18:30:38\ntype: \"tags\"\n---\n","updated":"2022-02-23T14:07:18.642Z","path":"tags/index.html","comments":1,"layout":"page","_id":"ckzzmscpq0008b5oed02jen1k","content":"","site":{"data":{"link":[{"class_name":"友情链接","class_desc":"友情链接","link_list":[{"name":"暂无","link":"","avatar":"","descr":"暂无"}]}]}},"cover":"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7","excerpt":"","more":""},{"_content":".avatar-img img:hover,\n#vcomment .vimg:hover,\n#waline-wrap .vuser:hover {\n    -webkit-transform: rotate(0) !important;\n    -moz-transform   : rotate(0) !important;\n    -o-transform     : rotate(0) !important;\n    -ms-transform    : rotate(0) !important;\n    transform        : rotate(0) !important;\n}","source":"static/css/no-rotate.css","raw":".avatar-img img:hover,\n#vcomment .vimg:hover,\n#waline-wrap .vuser:hover {\n    -webkit-transform: rotate(0) !important;\n    -moz-transform   : rotate(0) !important;\n    -o-transform     : rotate(0) !important;\n    -ms-transform    : rotate(0) !important;\n    transform        : rotate(0) !important;\n}","date":"2022-02-23T14:07:18.642Z","updated":"2022-02-23T14:07:18.642Z","path":"static/css/no-rotate.css","layout":"false","title":"","comments":1,"_id":"ckzzmscpr000ab5oe7nenhp4o","content":".avatar-img img:hover,\n#vcomment .vimg:hover,\n#waline-wrap .vuser:hover {\n    -webkit-transform: rotate(0) !important;\n    -moz-transform   : rotate(0) !important;\n    -o-transform     : rotate(0) !important;\n    -ms-transform    : rotate(0) !important;\n    transform        : rotate(0) !important;\n}","site":{"data":{"link":[{"class_name":"友情链接","class_desc":"友情链接","link_list":[{"name":"暂无","link":"","avatar":"","descr":"暂无"}]}]}},"cover":"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7","excerpt":"","more":".avatar-img img:hover,\n#vcomment .vimg:hover,\n#waline-wrap .vuser:hover {\n    -webkit-transform: rotate(0) !important;\n    -moz-transform   : rotate(0) !important;\n    -o-transform     : rotate(0) !important;\n    -ms-transform    : rotate(0) !important;\n    transform        : rotate(0) !important;\n}"},{"title":"About","aside":false,"_content":"\n\n## Hi~\n\n你好~~~ 这里是一只可爱的女高中生\n\n喜欢摸鱼, 咕咕咕~\n\n```\n....(\\ (\\\n c(* ˃ ◡˂ )\n```\n\n## Contact\n\nE-mail: <kar@kasukusakura.com> / <k@mamoe.net> / <karlatemp@vip.qq.com>\n\nTelegram: [Karlatemp](https://t.me/Karlatemp)\n\n---------\n\n剩下的想起来再写吧~~\n","source":"about/index.md","raw":"---\ntitle: About\naside: false\n---\n\n\n## Hi~\n\n你好~~~ 这里是一只可爱的女高中生\n\n喜欢摸鱼, 咕咕咕~\n\n```\n....(\\ (\\\n c(* ˃ ◡˂ )\n```\n\n## Contact\n\nE-mail: <kar@kasukusakura.com> / <k@mamoe.net> / <karlatemp@vip.qq.com>\n\nTelegram: [Karlatemp](https://t.me/Karlatemp)\n\n---------\n\n剩下的想起来再写吧~~\n","date":"2022-06-02T09:01:03.978Z","updated":"2022-06-02T09:01:03.978Z","path":"about/index.html","_id":"cl08a2jd80000ckoq4s2rdb0b","comments":1,"layout":"page","content":"<h2 id=\"Hi\"><a href=\"#Hi\" class=\"headerlink\" title=\"Hi~\"></a>Hi~</h2><p>你好~~~ 这里是一只可爱的女高中生</p>\n<p>喜欢摸鱼, 咕咕咕~</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">....(\\ (\\</span><br><span class=\"line\"> c(* ˃ ◡˂ )</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Contact\"><a href=\"#Contact\" class=\"headerlink\" title=\"Contact\"></a>Contact</h2><p>E-mail: <a href=\"mailto:&#x6b;&#97;&#x72;&#x40;&#107;&#97;&#115;&#x75;&#x6b;&#117;&#x73;&#x61;&#107;&#x75;&#114;&#x61;&#46;&#x63;&#x6f;&#109;\">&#x6b;&#97;&#x72;&#x40;&#107;&#97;&#115;&#x75;&#x6b;&#117;&#x73;&#x61;&#107;&#x75;&#114;&#x61;&#46;&#x63;&#x6f;&#109;</a> &#x2F; <a href=\"mailto:&#x6b;&#64;&#109;&#97;&#x6d;&#x6f;&#x65;&#46;&#x6e;&#x65;&#x74;\">&#x6b;&#64;&#109;&#97;&#x6d;&#x6f;&#x65;&#46;&#x6e;&#x65;&#x74;</a> &#x2F; <a href=\"mailto:&#107;&#x61;&#114;&#x6c;&#97;&#116;&#101;&#109;&#112;&#64;&#118;&#105;&#x70;&#x2e;&#113;&#113;&#x2e;&#x63;&#111;&#109;\">&#107;&#x61;&#114;&#x6c;&#97;&#116;&#101;&#109;&#112;&#64;&#118;&#105;&#x70;&#x2e;&#113;&#113;&#x2e;&#x63;&#111;&#109;</a></p>\n<p>Telegram: <a href=\"https://t.me/Karlatemp\">Karlatemp</a></p>\n<hr>\n<p>剩下的想起来再写吧~~</p>\n","site":{"data":{"link":[{"class_name":"友情链接","class_desc":"友情链接","link_list":[{"name":"暂无","link":"","avatar":"","descr":"暂无"}]}]}},"cover":"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7","excerpt":"","more":"<h2 id=\"Hi\"><a href=\"#Hi\" class=\"headerlink\" title=\"Hi~\"></a>Hi~</h2><p>你好~~~ 这里是一只可爱的女高中生</p>\n<p>喜欢摸鱼, 咕咕咕~</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">....(\\ (\\</span><br><span class=\"line\"> c(* ˃ ◡˂ )</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Contact\"><a href=\"#Contact\" class=\"headerlink\" title=\"Contact\"></a>Contact</h2><p>E-mail: <a href=\"mailto:&#x6b;&#97;&#x72;&#x40;&#107;&#97;&#115;&#x75;&#x6b;&#117;&#x73;&#x61;&#107;&#x75;&#114;&#x61;&#46;&#x63;&#x6f;&#109;\">&#x6b;&#97;&#x72;&#x40;&#107;&#97;&#115;&#x75;&#x6b;&#117;&#x73;&#x61;&#107;&#x75;&#114;&#x61;&#46;&#x63;&#x6f;&#109;</a> &#x2F; <a href=\"mailto:&#x6b;&#64;&#109;&#97;&#x6d;&#x6f;&#x65;&#46;&#x6e;&#x65;&#x74;\">&#x6b;&#64;&#109;&#97;&#x6d;&#x6f;&#x65;&#46;&#x6e;&#x65;&#x74;</a> &#x2F; <a href=\"mailto:&#107;&#x61;&#114;&#x6c;&#97;&#116;&#101;&#109;&#112;&#64;&#118;&#105;&#x70;&#x2e;&#113;&#113;&#x2e;&#x63;&#111;&#109;\">&#107;&#x61;&#114;&#x6c;&#97;&#116;&#101;&#109;&#112;&#64;&#118;&#105;&#x70;&#x2e;&#113;&#113;&#x2e;&#x63;&#111;&#109;</a></p>\n<p>Telegram: <a href=\"https://t.me/Karlatemp\">Karlatemp</a></p>\n<hr>\n<p>剩下的想起来再写吧~~</p>\n"}],"Post":[{"title":"Hello~","date":"2022-02-22T16:00:01.000Z","_content":"\nThis is my first post.\n","source":"_posts/hello-world.md","raw":"---\ntitle: Hello~\ndate: 2022-02-23 00:00:01\n---\n\nThis is my first post.\n","slug":"hello-world","published":1,"updated":"2022-03-12T13:52:41.943Z","_id":"ckzzmscpg0001b5oe0b9x9j0y","comments":1,"layout":"post","photos":[],"link":"","content":"<p>This is my first post.</p>\n","site":{"data":{"link":[{"class_name":"友情链接","class_desc":"友情链接","link_list":[{"name":"暂无","link":"","avatar":"","descr":"暂无"}]}]}},"cover":"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7","excerpt":"","more":"<p>This is my first post.</p>\n"},{"title":"GitHub PullRequest 自动审核合并","date":"2022-02-22T16:01:00.000Z","_content":"\n\n众所周知, github actions 可以完成很多自动化任务, 比如代码持续CI, 版本发布自动化, new issue 内容检查等.\n\n当然，github actions 也可以用作 PR 自动审查合并, 不过, 要完成这些需要一些额外的配置..\n\n--------\n\n首先需要知道的是, `on: pull_request` 的 workflow 是只有 `readonly` 的权限的, 这也就意味着通过 `on: pull_request` 发起的 workflow 除了读取已公开的内容之外什么都干不了. 包括访问 `${{ secrets.XXXX }}` 也是不被允许的\n\n需要完成自动合并, 需要更高权限(也意味着更危险的) workflow, [pull_request_target](https://docs.github.com/en/actions/learn-github-actions/events-that-trigger-workflows#pull_request_target)\n\n`pull_request_target` 与 `pull_request` 的用法基本一致, 但是主要有以下的区别\n\n`actions/checkout@v2` 会签出到被 PR 的分支(也就是源仓库的内容), 而不是经过 PR 修改后的内容\n\n`pull_request_target` 拥有 write 权限, 可以写入源仓库, 访问 `${{ secrets.XXX }}` (这是 `pull_request` 所不允许的)\n\n----------\n\n知道以上的主要区别之后就可以编写 PR 自动审查了\n\n首先需要获取源仓库的内容 (当然绝对不可以直接 checkout!!!)\n\n可以选择在当前目录来获取修改，或者创建一个新文件夹来获取修改\n\n```yml\n# Way 1\n- uses: actions/checkout@v2\n  with:\n    ref: pull/${{ github.event.pull_request.number }}/head\n    path: the_pr\n\n# Way 2\n- run: git fetch origin pull/$PR_NUM/head:THE_PR\n  env:\n    PR_NUM: ${{ github.event.pull_request.number }}\n```\n\n然后是提取该 PR 的修改\n\n```shell\nBASE_SHA: ${{ github.event.pull_request.base.sha }}\n\ngit rev-list --count \"$BASE_SHA..THE_PR\" > tmp/count\ncat tmp/count\ngit --no-pager diff \"$BASE_SHA..THE_PR\" --no-color --output tmp/change-diff\ngit --no-pager diff \"$BASE_SHA..THE_PR\" --name-only --output tmp/name-changed\n```\n\n此时\n- `tmp/name-changed` 存储着该 PR 修改的全部文件的文件路径\n- `tmp/change-diff` 则为 PR 与 base 的 diff 文件\n- `tmp/count` 为一个数字, 该数字代表 base 与 pr 直接相差的 commit 数量\n\n----\n\n在进行一系列 PR 审核之后, 需要将审核结果返回出去 (`Merge` 或者 `Reject(Request change)`)\n\n需要用到的两个 REST API 为 [Create a review for a pull request](https://docs.github.com/en/rest/reference/pulls#create-a-review-for-a-pull-request), [Merge a pull request](https://docs.github.com/en/rest/reference/pulls#merge-a-pull-request)\n\n通过 `Create a review for a pull request` 可以对一个 PR 进行自动审查, 可以是 `Approve` 或者 `Reject(Request changes)`, 亦或者只是简单的评论 `Comment`\n\n然后就可以通过 `Merge a pull request` 完成全自动 PR 合并了, 唯一需要给定的参数 `sha` 为 PullRequest 的最后一个 commit 的 id, 可以通过执行 `git rev-parse THE_PR` 获得该参数的值\n\n----\n\n额外话: 使用 `${{ secrets.GITHUB_TOKEN }}` 合并后, 不会触发 workflow `on: push`\n如果需要 merge commit 也执行 `on: push` 的, 请使用 `${{ secrets.PR_REVIEWER_TOKEN }}` 代替 `GITHUB_TOKEN`\n\n----\n\n参考与应用\n\n- [auto-review-and-merge.yml](https://github.com/project-mirai/mirai-repo-mirror/blob/master/.github/workflows/auto-review-and-merge.yml)\n- [check-pr.js](https://github.com/project-mirai/mirai-repo-mirror/blob/master/.script/check-pr.js)\n","source":"_posts/gh/autoreview.md","raw":"---\ntitle: GitHub PullRequest 自动审核合并\ncategories: [github]\ntags: [github, pr, review]\ndate: 2022-02-23 00:01:00\n---\n\n\n众所周知, github actions 可以完成很多自动化任务, 比如代码持续CI, 版本发布自动化, new issue 内容检查等.\n\n当然，github actions 也可以用作 PR 自动审查合并, 不过, 要完成这些需要一些额外的配置..\n\n--------\n\n首先需要知道的是, `on: pull_request` 的 workflow 是只有 `readonly` 的权限的, 这也就意味着通过 `on: pull_request` 发起的 workflow 除了读取已公开的内容之外什么都干不了. 包括访问 `${{ secrets.XXXX }}` 也是不被允许的\n\n需要完成自动合并, 需要更高权限(也意味着更危险的) workflow, [pull_request_target](https://docs.github.com/en/actions/learn-github-actions/events-that-trigger-workflows#pull_request_target)\n\n`pull_request_target` 与 `pull_request` 的用法基本一致, 但是主要有以下的区别\n\n`actions/checkout@v2` 会签出到被 PR 的分支(也就是源仓库的内容), 而不是经过 PR 修改后的内容\n\n`pull_request_target` 拥有 write 权限, 可以写入源仓库, 访问 `${{ secrets.XXX }}` (这是 `pull_request` 所不允许的)\n\n----------\n\n知道以上的主要区别之后就可以编写 PR 自动审查了\n\n首先需要获取源仓库的内容 (当然绝对不可以直接 checkout!!!)\n\n可以选择在当前目录来获取修改，或者创建一个新文件夹来获取修改\n\n```yml\n# Way 1\n- uses: actions/checkout@v2\n  with:\n    ref: pull/${{ github.event.pull_request.number }}/head\n    path: the_pr\n\n# Way 2\n- run: git fetch origin pull/$PR_NUM/head:THE_PR\n  env:\n    PR_NUM: ${{ github.event.pull_request.number }}\n```\n\n然后是提取该 PR 的修改\n\n```shell\nBASE_SHA: ${{ github.event.pull_request.base.sha }}\n\ngit rev-list --count \"$BASE_SHA..THE_PR\" > tmp/count\ncat tmp/count\ngit --no-pager diff \"$BASE_SHA..THE_PR\" --no-color --output tmp/change-diff\ngit --no-pager diff \"$BASE_SHA..THE_PR\" --name-only --output tmp/name-changed\n```\n\n此时\n- `tmp/name-changed` 存储着该 PR 修改的全部文件的文件路径\n- `tmp/change-diff` 则为 PR 与 base 的 diff 文件\n- `tmp/count` 为一个数字, 该数字代表 base 与 pr 直接相差的 commit 数量\n\n----\n\n在进行一系列 PR 审核之后, 需要将审核结果返回出去 (`Merge` 或者 `Reject(Request change)`)\n\n需要用到的两个 REST API 为 [Create a review for a pull request](https://docs.github.com/en/rest/reference/pulls#create-a-review-for-a-pull-request), [Merge a pull request](https://docs.github.com/en/rest/reference/pulls#merge-a-pull-request)\n\n通过 `Create a review for a pull request` 可以对一个 PR 进行自动审查, 可以是 `Approve` 或者 `Reject(Request changes)`, 亦或者只是简单的评论 `Comment`\n\n然后就可以通过 `Merge a pull request` 完成全自动 PR 合并了, 唯一需要给定的参数 `sha` 为 PullRequest 的最后一个 commit 的 id, 可以通过执行 `git rev-parse THE_PR` 获得该参数的值\n\n----\n\n额外话: 使用 `${{ secrets.GITHUB_TOKEN }}` 合并后, 不会触发 workflow `on: push`\n如果需要 merge commit 也执行 `on: push` 的, 请使用 `${{ secrets.PR_REVIEWER_TOKEN }}` 代替 `GITHUB_TOKEN`\n\n----\n\n参考与应用\n\n- [auto-review-and-merge.yml](https://github.com/project-mirai/mirai-repo-mirror/blob/master/.github/workflows/auto-review-and-merge.yml)\n- [check-pr.js](https://github.com/project-mirai/mirai-repo-mirror/blob/master/.script/check-pr.js)\n","slug":"gh/autoreview","published":1,"updated":"2022-03-12T13:52:41.943Z","_id":"ckzzmscpk0003b5oe152y02tc","comments":1,"layout":"post","photos":[],"link":"","content":"<p>众所周知, github actions 可以完成很多自动化任务, 比如代码持续CI, 版本发布自动化, new issue 内容检查等.</p>\n<p>当然，github actions 也可以用作 PR 自动审查合并, 不过, 要完成这些需要一些额外的配置..</p>\n<hr>\n<p>首先需要知道的是, <code>on: pull_request</code> 的 workflow 是只有 <code>readonly</code> 的权限的, 这也就意味着通过 <code>on: pull_request</code> 发起的 workflow 除了读取已公开的内容之外什么都干不了. 包括访问 <code>$&#123;&#123; secrets.XXXX &#125;&#125;</code> 也是不被允许的</p>\n<p>需要完成自动合并, 需要更高权限(也意味着更危险的) workflow, <a href=\"https://docs.github.com/en/actions/learn-github-actions/events-that-trigger-workflows#pull_request_target\">pull_request_target</a></p>\n<p><code>pull_request_target</code> 与 <code>pull_request</code> 的用法基本一致, 但是主要有以下的区别</p>\n<p><code>actions/checkout@v2</code> 会签出到被 PR 的分支(也就是源仓库的内容), 而不是经过 PR 修改后的内容</p>\n<p><code>pull_request_target</code> 拥有 write 权限, 可以写入源仓库, 访问 <code>$&#123;&#123; secrets.XXX &#125;&#125;</code> (这是 <code>pull_request</code> 所不允许的)</p>\n<hr>\n<p>知道以上的主要区别之后就可以编写 PR 自动审查了</p>\n<p>首先需要获取源仓库的内容 (当然绝对不可以直接 checkout!!!)</p>\n<p>可以选择在当前目录来获取修改，或者创建一个新文件夹来获取修改</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Way 1</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">uses:</span> <span class=\"string\">actions/checkout@v2</span></span><br><span class=\"line\">  <span class=\"attr\">with:</span></span><br><span class=\"line\">    <span class=\"attr\">ref:</span> <span class=\"string\">pull/$&#123;&#123;</span> <span class=\"string\">github.event.pull_request.number</span> <span class=\"string\">&#125;&#125;/head</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">the_pr</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Way 2</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">run:</span> <span class=\"string\">git</span> <span class=\"string\">fetch</span> <span class=\"string\">origin</span> <span class=\"string\">pull/$PR_NUM/head:THE_PR</span></span><br><span class=\"line\">  <span class=\"attr\">env:</span></span><br><span class=\"line\">    <span class=\"attr\">PR_NUM:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">github.event.pull_request.number</span> <span class=\"string\">&#125;&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>然后是提取该 PR 的修改</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BASE_SHA: $&#123;&#123; github.event.pull_request.base.sha &#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">git rev-list --count &quot;$BASE_SHA..THE_PR&quot; &gt; tmp/count</span><br><span class=\"line\">cat tmp/count</span><br><span class=\"line\">git --no-pager diff &quot;$BASE_SHA..THE_PR&quot; --no-color --output tmp/change-diff</span><br><span class=\"line\">git --no-pager diff &quot;$BASE_SHA..THE_PR&quot; --name-only --output tmp/name-changed</span><br></pre></td></tr></table></figure>\n\n<p>此时</p>\n<ul>\n<li><code>tmp/name-changed</code> 存储着该 PR 修改的全部文件的文件路径</li>\n<li><code>tmp/change-diff</code> 则为 PR 与 base 的 diff 文件</li>\n<li><code>tmp/count</code> 为一个数字, 该数字代表 base 与 pr 直接相差的 commit 数量</li>\n</ul>\n<hr>\n<p>在进行一系列 PR 审核之后, 需要将审核结果返回出去 (<code>Merge</code> 或者 <code>Reject(Request change)</code>)</p>\n<p>需要用到的两个 REST API 为 <a href=\"https://docs.github.com/en/rest/reference/pulls#create-a-review-for-a-pull-request\">Create a review for a pull request</a>, <a href=\"https://docs.github.com/en/rest/reference/pulls#merge-a-pull-request\">Merge a pull request</a></p>\n<p>通过 <code>Create a review for a pull request</code> 可以对一个 PR 进行自动审查, 可以是 <code>Approve</code> 或者 <code>Reject(Request changes)</code>, 亦或者只是简单的评论 <code>Comment</code></p>\n<p>然后就可以通过 <code>Merge a pull request</code> 完成全自动 PR 合并了, 唯一需要给定的参数 <code>sha</code> 为 PullRequest 的最后一个 commit 的 id, 可以通过执行 <code>git rev-parse THE_PR</code> 获得该参数的值</p>\n<hr>\n<p>额外话: 使用 <code>$&#123;&#123; secrets.GITHUB_TOKEN &#125;&#125;</code> 合并后, 不会触发 workflow <code>on: push</code><br>如果需要 merge commit 也执行 <code>on: push</code> 的, 请使用 <code>$&#123;&#123; secrets.PR_REVIEWER_TOKEN &#125;&#125;</code> 代替 <code>GITHUB_TOKEN</code></p>\n<hr>\n<p>参考与应用</p>\n<ul>\n<li><a href=\"https://github.com/project-mirai/mirai-repo-mirror/blob/master/.github/workflows/auto-review-and-merge.yml\">auto-review-and-merge.yml</a></li>\n<li><a href=\"https://github.com/project-mirai/mirai-repo-mirror/blob/master/.script/check-pr.js\">check-pr.js</a></li>\n</ul>\n","site":{"data":{"link":[{"class_name":"友情链接","class_desc":"友情链接","link_list":[{"name":"暂无","link":"","avatar":"","descr":"暂无"}]}]}},"cover":"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7","excerpt":"","more":"<p>众所周知, github actions 可以完成很多自动化任务, 比如代码持续CI, 版本发布自动化, new issue 内容检查等.</p>\n<p>当然，github actions 也可以用作 PR 自动审查合并, 不过, 要完成这些需要一些额外的配置..</p>\n<hr>\n<p>首先需要知道的是, <code>on: pull_request</code> 的 workflow 是只有 <code>readonly</code> 的权限的, 这也就意味着通过 <code>on: pull_request</code> 发起的 workflow 除了读取已公开的内容之外什么都干不了. 包括访问 <code>$&#123;&#123; secrets.XXXX &#125;&#125;</code> 也是不被允许的</p>\n<p>需要完成自动合并, 需要更高权限(也意味着更危险的) workflow, <a href=\"https://docs.github.com/en/actions/learn-github-actions/events-that-trigger-workflows#pull_request_target\">pull_request_target</a></p>\n<p><code>pull_request_target</code> 与 <code>pull_request</code> 的用法基本一致, 但是主要有以下的区别</p>\n<p><code>actions/checkout@v2</code> 会签出到被 PR 的分支(也就是源仓库的内容), 而不是经过 PR 修改后的内容</p>\n<p><code>pull_request_target</code> 拥有 write 权限, 可以写入源仓库, 访问 <code>$&#123;&#123; secrets.XXX &#125;&#125;</code> (这是 <code>pull_request</code> 所不允许的)</p>\n<hr>\n<p>知道以上的主要区别之后就可以编写 PR 自动审查了</p>\n<p>首先需要获取源仓库的内容 (当然绝对不可以直接 checkout!!!)</p>\n<p>可以选择在当前目录来获取修改，或者创建一个新文件夹来获取修改</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Way 1</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">uses:</span> <span class=\"string\">actions/checkout@v2</span></span><br><span class=\"line\">  <span class=\"attr\">with:</span></span><br><span class=\"line\">    <span class=\"attr\">ref:</span> <span class=\"string\">pull/$&#123;&#123;</span> <span class=\"string\">github.event.pull_request.number</span> <span class=\"string\">&#125;&#125;/head</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">the_pr</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Way 2</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">run:</span> <span class=\"string\">git</span> <span class=\"string\">fetch</span> <span class=\"string\">origin</span> <span class=\"string\">pull/$PR_NUM/head:THE_PR</span></span><br><span class=\"line\">  <span class=\"attr\">env:</span></span><br><span class=\"line\">    <span class=\"attr\">PR_NUM:</span> <span class=\"string\">$&#123;&#123;</span> <span class=\"string\">github.event.pull_request.number</span> <span class=\"string\">&#125;&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>然后是提取该 PR 的修改</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BASE_SHA: $&#123;&#123; github.event.pull_request.base.sha &#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">git rev-list --count &quot;$BASE_SHA..THE_PR&quot; &gt; tmp/count</span><br><span class=\"line\">cat tmp/count</span><br><span class=\"line\">git --no-pager diff &quot;$BASE_SHA..THE_PR&quot; --no-color --output tmp/change-diff</span><br><span class=\"line\">git --no-pager diff &quot;$BASE_SHA..THE_PR&quot; --name-only --output tmp/name-changed</span><br></pre></td></tr></table></figure>\n\n<p>此时</p>\n<ul>\n<li><code>tmp/name-changed</code> 存储着该 PR 修改的全部文件的文件路径</li>\n<li><code>tmp/change-diff</code> 则为 PR 与 base 的 diff 文件</li>\n<li><code>tmp/count</code> 为一个数字, 该数字代表 base 与 pr 直接相差的 commit 数量</li>\n</ul>\n<hr>\n<p>在进行一系列 PR 审核之后, 需要将审核结果返回出去 (<code>Merge</code> 或者 <code>Reject(Request change)</code>)</p>\n<p>需要用到的两个 REST API 为 <a href=\"https://docs.github.com/en/rest/reference/pulls#create-a-review-for-a-pull-request\">Create a review for a pull request</a>, <a href=\"https://docs.github.com/en/rest/reference/pulls#merge-a-pull-request\">Merge a pull request</a></p>\n<p>通过 <code>Create a review for a pull request</code> 可以对一个 PR 进行自动审查, 可以是 <code>Approve</code> 或者 <code>Reject(Request changes)</code>, 亦或者只是简单的评论 <code>Comment</code></p>\n<p>然后就可以通过 <code>Merge a pull request</code> 完成全自动 PR 合并了, 唯一需要给定的参数 <code>sha</code> 为 PullRequest 的最后一个 commit 的 id, 可以通过执行 <code>git rev-parse THE_PR</code> 获得该参数的值</p>\n<hr>\n<p>额外话: 使用 <code>$&#123;&#123; secrets.GITHUB_TOKEN &#125;&#125;</code> 合并后, 不会触发 workflow <code>on: push</code><br>如果需要 merge commit 也执行 <code>on: push</code> 的, 请使用 <code>$&#123;&#123; secrets.PR_REVIEWER_TOKEN &#125;&#125;</code> 代替 <code>GITHUB_TOKEN</code></p>\n<hr>\n<p>参考与应用</p>\n<ul>\n<li><a href=\"https://github.com/project-mirai/mirai-repo-mirror/blob/master/.github/workflows/auto-review-and-merge.yml\">auto-review-and-merge.yml</a></li>\n<li><a href=\"https://github.com/project-mirai/mirai-repo-mirror/blob/master/.script/check-pr.js\">check-pr.js</a></li>\n</ul>\n"},{"title":"Java 动态模块系统 | Java dynamic module system","date":"2022-02-22T16:01:00.000Z","_content":"\n## 前言\n\n在使用高版本的时候, 总会不可避免的接触到模块系统, 比如反射操作 `java.base` 已经十分困难. 既然 JDK 内部可以享受到模块的保护, 那么我们自己的代码是否也可以享受到模块系统的保护呢\n\n当然可以，而且也不是非常麻烦。\n\n使用模块，你将面对以下问题\n\n- <span style=\"color: green\">得到反射保护, 外部代码将不能通过反射强行修改/调用私有成员</span>\n- <span style=\"color: red\">更严格的访问控制, 不能直接访问非 required 的模块</span>\n- <span style=\"color: red\">失去 `--add-opens=....=ALL-UNNAMED` 的归属判断</span>\n- <span style=\"color: gray\">需要专门的 ClassLoader / 需要自行实现 ClassLoader</span>\n\n使用模块的适用情况\n\n- 需要编写严格的附属(插件)系统\n- 需要保护自身代码/保护自身内存空间\n- ~~觉得弄着好玩~~\n\n## 定义一个模块\n\n> 注: 此处的定义指的是, 通过运行时代码在运行时定义一个模块.\n> 而不是大多数资料说的直接写一个 `module-info.java`\n\n要定义一个模块, 首先需要一个模块的描述符文件 (`ModuleDescriptor`), 可以从以编码文件读取 (`ModuleDescriptor.read(InputStream) <- module-info.class`), 也可以在运行时动态生成一个(`ModuleDescriptor.newModule(\"name_of_module\").build()`)\n\njvm 通过包来区分模块, 而一个模块的全部包都需要提前指定, jvm 才会为这些包分配到一个模块内\n\n```java\nvar moduleDescriptor = ModuleDescriptor.newModule(\"my.custom_module\")\n    .packages(Set.of(\"io.github.karlatemp.jmse.main\"))\n    .exports(\"io.github.karlatemp.jmse.main\")\n    .build();\n```\n\n这里我们已经拥有了一个模块的描述符, 现在我们还需要一个模块描述的引用, 以及一个模块查找器以让 jvm 可以找到我们的模块\n\n```java\nvar myModuleReference = new ModuleReference(\n    moduleDescriptor, null\n) {\n    @Override public ModuleReader open() throws IOException {\n        throw new UnsupportedOperationException();\n    }\n}\nvar myModuleFinder = new ModuleFinder() {\n    @Override\n    public Optional<ModuleReference> find(String name) {\n        if (name.equals(moduleDescriptor.name())) {\n            return Optional.of(myModuleReference);\n        }\n        return Optional.empty();\n    }\n\n    @Override\n    public Set<ModuleReference> findAll() {\n        return Set.of(myModuleReference);\n     }\n};\n```\n\n最后，定义一个模块\n```java\nvar bootLayer = ModuleLayer.boot();\nvar myConfiguration = bootLayer.configuration().resolve(\n    myModuleFinder, ModuleFinder.of(), Set.of(moduleDescriptor.name())\n);\nvar classLoader = ClassLoader.getSystemClassLoader();\nvar controller = ModuleLayer.defineModules(\n    myConfiguration, List.of(bootLayer), $ -> classLoader\n);\n\nClass.forName(\"io.github.karlatemp.jmse.main.ModuleMain\", false, classLoader)\n    .getMethod(\"launch\")\n    .invoke(null);\n```\n\n## ServiceLoader / Class.forName(Module, String)\n\n还记得 `需要专门的 ClassLoader / 需要自行实现 ClassLoader` 吗, 虽然在上文已经成功定义了一个模块，但是只要使用 `ServiceLoader` / `Class.forName(Module, String)`, 那么将无法找到对应的类, 因为一般的 ClassLoader 并没有专门处理动态加载的模块\n\n### Analyze\n\n通过进行调用分析, 最终可以发现以上两个东西最终都进入到了下面的方法\n\n```java\npublic class ClassLoader {\n    final Class<?> loadClass(Module module, String name) {\n        synchronized (getClassLoadingLock(name)) {\n            // First, check if the class has already been loaded\n            Class<?> c = findLoadedClass(name);\n            if (c == null) {\n                c = findClass(module.getName(), name);\n            }\n            if (c != null && c.getModule() == module) {\n                return c;\n            } else {\n                return null;\n            }\n        }\n    }\n    protected Class<?> findClass(String moduleName, String name) {\n        if (moduleName == null) {\n            try {\n                return findClass(name);\n            } catch (ClassNotFoundException ignore) { }\n        }\n        return null;\n    }\n}\n```\n\n不难发现, 由于默认没有处理模块, 导致指定搜索模块的时候将搜索不到动态定义的模块\n\n而 `jdk.internal.loader.ClassLoader$AppClassLoader` 并没有处理通过 `ModuleLayer.defineModule` 定义的模块, 于是也不能直接将模块定义到系统类加载器\n\n### 自行实现类加载器\n\n自行实现类加载器十分简单，只需要\n\n```java\npublic class MyCustomClassLoader extends URLClassLoader {\n    String moduleName;\n\n    @Override\n    protected Class<?> findClass(String moduleName, String name) {\n        // System.out.println(\"Find class: \" + moduleName + \"/\" + name);\n        if (this.moduleName.equals(moduleName)) {\n            try {\n                return findClass(name);\n            } catch (ClassNotFoundException ignored) {\n            }\n        }\n        return super.findClass(moduleName, name);\n    }\n}\n```\n\n### 使用 JDK 内置的类加载器\n\n只需要实现 `ModuleReference.open(): ModuleReader`, 然后使用\n\n```java\nvar controller = ModuleLayer.defineModulesWithOneLoader(\n        myConfiguration,\n        List.of(bootLayer),\n        ClassLoader.getSystemClassLoader().getParent()\n);\nvar classLoader = controller.layer().findLoader(moduleDescriptor.name());\n```\n\n即可使用 JDK 内置的内加载器\n\n-----\n\n## 完整参考\n\n- [java-module-system-explore](https://github.com/Karlatemp/java-module-system-explore)\n  - [BootModuleByStandard.java](https://github.com/Karlatemp/java-module-system-explore/blob/master/src/main/java/io/github/karlatemp/jmse/boot/BootModuleByStandard.java)\n  - [MyCustomClassLoader.java](https://github.com/Karlatemp/java-module-system-explore/blob/master/src/main/java/io/github/karlatemp/jmse/boot/MyCustomClassLoader.java)","source":"_posts/jvm/dynmodule.md","raw":"---\ntitle: \"Java 动态模块系统 | Java dynamic module system\"\ncategories: [jvm]\ntags: [jvm, jdk9]\ndate: 2022-02-23 00:01:00\n---\n\n## 前言\n\n在使用高版本的时候, 总会不可避免的接触到模块系统, 比如反射操作 `java.base` 已经十分困难. 既然 JDK 内部可以享受到模块的保护, 那么我们自己的代码是否也可以享受到模块系统的保护呢\n\n当然可以，而且也不是非常麻烦。\n\n使用模块，你将面对以下问题\n\n- <span style=\"color: green\">得到反射保护, 外部代码将不能通过反射强行修改/调用私有成员</span>\n- <span style=\"color: red\">更严格的访问控制, 不能直接访问非 required 的模块</span>\n- <span style=\"color: red\">失去 `--add-opens=....=ALL-UNNAMED` 的归属判断</span>\n- <span style=\"color: gray\">需要专门的 ClassLoader / 需要自行实现 ClassLoader</span>\n\n使用模块的适用情况\n\n- 需要编写严格的附属(插件)系统\n- 需要保护自身代码/保护自身内存空间\n- ~~觉得弄着好玩~~\n\n## 定义一个模块\n\n> 注: 此处的定义指的是, 通过运行时代码在运行时定义一个模块.\n> 而不是大多数资料说的直接写一个 `module-info.java`\n\n要定义一个模块, 首先需要一个模块的描述符文件 (`ModuleDescriptor`), 可以从以编码文件读取 (`ModuleDescriptor.read(InputStream) <- module-info.class`), 也可以在运行时动态生成一个(`ModuleDescriptor.newModule(\"name_of_module\").build()`)\n\njvm 通过包来区分模块, 而一个模块的全部包都需要提前指定, jvm 才会为这些包分配到一个模块内\n\n```java\nvar moduleDescriptor = ModuleDescriptor.newModule(\"my.custom_module\")\n    .packages(Set.of(\"io.github.karlatemp.jmse.main\"))\n    .exports(\"io.github.karlatemp.jmse.main\")\n    .build();\n```\n\n这里我们已经拥有了一个模块的描述符, 现在我们还需要一个模块描述的引用, 以及一个模块查找器以让 jvm 可以找到我们的模块\n\n```java\nvar myModuleReference = new ModuleReference(\n    moduleDescriptor, null\n) {\n    @Override public ModuleReader open() throws IOException {\n        throw new UnsupportedOperationException();\n    }\n}\nvar myModuleFinder = new ModuleFinder() {\n    @Override\n    public Optional<ModuleReference> find(String name) {\n        if (name.equals(moduleDescriptor.name())) {\n            return Optional.of(myModuleReference);\n        }\n        return Optional.empty();\n    }\n\n    @Override\n    public Set<ModuleReference> findAll() {\n        return Set.of(myModuleReference);\n     }\n};\n```\n\n最后，定义一个模块\n```java\nvar bootLayer = ModuleLayer.boot();\nvar myConfiguration = bootLayer.configuration().resolve(\n    myModuleFinder, ModuleFinder.of(), Set.of(moduleDescriptor.name())\n);\nvar classLoader = ClassLoader.getSystemClassLoader();\nvar controller = ModuleLayer.defineModules(\n    myConfiguration, List.of(bootLayer), $ -> classLoader\n);\n\nClass.forName(\"io.github.karlatemp.jmse.main.ModuleMain\", false, classLoader)\n    .getMethod(\"launch\")\n    .invoke(null);\n```\n\n## ServiceLoader / Class.forName(Module, String)\n\n还记得 `需要专门的 ClassLoader / 需要自行实现 ClassLoader` 吗, 虽然在上文已经成功定义了一个模块，但是只要使用 `ServiceLoader` / `Class.forName(Module, String)`, 那么将无法找到对应的类, 因为一般的 ClassLoader 并没有专门处理动态加载的模块\n\n### Analyze\n\n通过进行调用分析, 最终可以发现以上两个东西最终都进入到了下面的方法\n\n```java\npublic class ClassLoader {\n    final Class<?> loadClass(Module module, String name) {\n        synchronized (getClassLoadingLock(name)) {\n            // First, check if the class has already been loaded\n            Class<?> c = findLoadedClass(name);\n            if (c == null) {\n                c = findClass(module.getName(), name);\n            }\n            if (c != null && c.getModule() == module) {\n                return c;\n            } else {\n                return null;\n            }\n        }\n    }\n    protected Class<?> findClass(String moduleName, String name) {\n        if (moduleName == null) {\n            try {\n                return findClass(name);\n            } catch (ClassNotFoundException ignore) { }\n        }\n        return null;\n    }\n}\n```\n\n不难发现, 由于默认没有处理模块, 导致指定搜索模块的时候将搜索不到动态定义的模块\n\n而 `jdk.internal.loader.ClassLoader$AppClassLoader` 并没有处理通过 `ModuleLayer.defineModule` 定义的模块, 于是也不能直接将模块定义到系统类加载器\n\n### 自行实现类加载器\n\n自行实现类加载器十分简单，只需要\n\n```java\npublic class MyCustomClassLoader extends URLClassLoader {\n    String moduleName;\n\n    @Override\n    protected Class<?> findClass(String moduleName, String name) {\n        // System.out.println(\"Find class: \" + moduleName + \"/\" + name);\n        if (this.moduleName.equals(moduleName)) {\n            try {\n                return findClass(name);\n            } catch (ClassNotFoundException ignored) {\n            }\n        }\n        return super.findClass(moduleName, name);\n    }\n}\n```\n\n### 使用 JDK 内置的类加载器\n\n只需要实现 `ModuleReference.open(): ModuleReader`, 然后使用\n\n```java\nvar controller = ModuleLayer.defineModulesWithOneLoader(\n        myConfiguration,\n        List.of(bootLayer),\n        ClassLoader.getSystemClassLoader().getParent()\n);\nvar classLoader = controller.layer().findLoader(moduleDescriptor.name());\n```\n\n即可使用 JDK 内置的内加载器\n\n-----\n\n## 完整参考\n\n- [java-module-system-explore](https://github.com/Karlatemp/java-module-system-explore)\n  - [BootModuleByStandard.java](https://github.com/Karlatemp/java-module-system-explore/blob/master/src/main/java/io/github/karlatemp/jmse/boot/BootModuleByStandard.java)\n  - [MyCustomClassLoader.java](https://github.com/Karlatemp/java-module-system-explore/blob/master/src/main/java/io/github/karlatemp/jmse/boot/MyCustomClassLoader.java)","slug":"jvm/dynmodule","published":1,"updated":"2022-03-12T13:52:41.943Z","_id":"ckzzmscpn0005b5oec39wes7w","comments":1,"layout":"post","photos":[],"link":"","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>在使用高版本的时候, 总会不可避免的接触到模块系统, 比如反射操作 <code>java.base</code> 已经十分困难. 既然 JDK 内部可以享受到模块的保护, 那么我们自己的代码是否也可以享受到模块系统的保护呢</p>\n<p>当然可以，而且也不是非常麻烦。</p>\n<p>使用模块，你将面对以下问题</p>\n<ul>\n<li><span style=\"color: green\">得到反射保护, 外部代码将不能通过反射强行修改&#x2F;调用私有成员</span></li>\n<li><span style=\"color: red\">更严格的访问控制, 不能直接访问非 required 的模块</span></li>\n<li><span style=\"color: red\">失去 <code>--add-opens=....=ALL-UNNAMED</code> 的归属判断</span></li>\n<li><span style=\"color: gray\">需要专门的 ClassLoader &#x2F; 需要自行实现 ClassLoader</span></li>\n</ul>\n<p>使用模块的适用情况</p>\n<ul>\n<li>需要编写严格的附属(插件)系统</li>\n<li>需要保护自身代码&#x2F;保护自身内存空间</li>\n<li><del>觉得弄着好玩</del></li>\n</ul>\n<h2 id=\"定义一个模块\"><a href=\"#定义一个模块\" class=\"headerlink\" title=\"定义一个模块\"></a>定义一个模块</h2><blockquote>\n<p>注: 此处的定义指的是, 通过运行时代码在运行时定义一个模块.<br>而不是大多数资料说的直接写一个 <code>module-info.java</code></p>\n</blockquote>\n<p>要定义一个模块, 首先需要一个模块的描述符文件 (<code>ModuleDescriptor</code>), 可以从以编码文件读取 (<code>ModuleDescriptor.read(InputStream) &lt;- module-info.class</code>), 也可以在运行时动态生成一个(<code>ModuleDescriptor.newModule(&quot;name_of_module&quot;).build()</code>)</p>\n<p>jvm 通过包来区分模块, 而一个模块的全部包都需要提前指定, jvm 才会为这些包分配到一个模块内</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">moduleDescriptor</span> <span class=\"operator\">=</span> ModuleDescriptor.newModule(<span class=\"string\">&quot;my.custom_module&quot;</span>)</span><br><span class=\"line\">    .packages(Set.of(<span class=\"string\">&quot;io.github.karlatemp.jmse.main&quot;</span>))</span><br><span class=\"line\">    .<span class=\"keyword\">exports</span>(<span class=\"string\">&quot;io.github.karlatemp.jmse.main&quot;</span>)</span><br><span class=\"line\">    .build();</span><br></pre></td></tr></table></figure>\n\n<p>这里我们已经拥有了一个模块的描述符, 现在我们还需要一个模块描述的引用, 以及一个模块查找器以让 jvm 可以找到我们的模块</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">myModuleReference</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ModuleReference</span>(</span><br><span class=\"line\">    moduleDescriptor, <span class=\"literal\">null</span></span><br><span class=\"line\">) &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span> <span class=\"keyword\">public</span> ModuleReader <span class=\"title function_\">open</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">UnsupportedOperationException</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">myModuleFinder</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ModuleFinder</span>() &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Optional&lt;ModuleReference&gt; <span class=\"title function_\">find</span><span class=\"params\">(String name)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (name.equals(moduleDescriptor.name())) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> Optional.of(myModuleReference);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Optional.empty();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Set&lt;ModuleReference&gt; <span class=\"title function_\">findAll</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Set.of(myModuleReference);</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>最后，定义一个模块</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">bootLayer</span> <span class=\"operator\">=</span> ModuleLayer.boot();</span><br><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">myConfiguration</span> <span class=\"operator\">=</span> bootLayer.configuration().resolve(</span><br><span class=\"line\">    myModuleFinder, ModuleFinder.of(), Set.of(moduleDescriptor.name())</span><br><span class=\"line\">);</span><br><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">classLoader</span> <span class=\"operator\">=</span> ClassLoader.getSystemClassLoader();</span><br><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">controller</span> <span class=\"operator\">=</span> ModuleLayer.defineModules(</span><br><span class=\"line\">    myConfiguration, List.of(bootLayer), $ -&gt; classLoader</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">Class.forName(<span class=\"string\">&quot;io.github.karlatemp.jmse.main.ModuleMain&quot;</span>, <span class=\"literal\">false</span>, classLoader)</span><br><span class=\"line\">    .getMethod(<span class=\"string\">&quot;launch&quot;</span>)</span><br><span class=\"line\">    .invoke(<span class=\"literal\">null</span>);</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ServiceLoader-x2F-Class-forName-Module-String\"><a href=\"#ServiceLoader-x2F-Class-forName-Module-String\" class=\"headerlink\" title=\"ServiceLoader &#x2F; Class.forName(Module, String)\"></a>ServiceLoader &#x2F; Class.forName(Module, String)</h2><p>还记得 <code>需要专门的 ClassLoader / 需要自行实现 ClassLoader</code> 吗, 虽然在上文已经成功定义了一个模块，但是只要使用 <code>ServiceLoader</code> &#x2F; <code>Class.forName(Module, String)</code>, 那么将无法找到对应的类, 因为一般的 ClassLoader 并没有专门处理动态加载的模块</p>\n<h3 id=\"Analyze\"><a href=\"#Analyze\" class=\"headerlink\" title=\"Analyze\"></a>Analyze</h3><p>通过进行调用分析, 最终可以发现以上两个东西最终都进入到了下面的方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ClassLoader</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> Class&lt;?&gt; loadClass(Module <span class=\"keyword\">module</span>, String name) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// First, check if the class has already been loaded</span></span><br><span class=\"line\">            Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (c == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                c = findClass(<span class=\"keyword\">module</span>.getName(), name);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (c != <span class=\"literal\">null</span> &amp;&amp; c.getModule() == <span class=\"keyword\">module</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> c;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> Class&lt;?&gt; findClass(String moduleName, String name) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (moduleName == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> findClass(name);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (ClassNotFoundException ignore) &#123; &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>不难发现, 由于默认没有处理模块, 导致指定搜索模块的时候将搜索不到动态定义的模块</p>\n<p>而 <code>jdk.internal.loader.ClassLoader$AppClassLoader</code> 并没有处理通过 <code>ModuleLayer.defineModule</code> 定义的模块, 于是也不能直接将模块定义到系统类加载器</p>\n<h3 id=\"自行实现类加载器\"><a href=\"#自行实现类加载器\" class=\"headerlink\" title=\"自行实现类加载器\"></a>自行实现类加载器</h3><p>自行实现类加载器十分简单，只需要</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyCustomClassLoader</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">URLClassLoader</span> &#123;</span><br><span class=\"line\">    String moduleName;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> Class&lt;?&gt; findClass(String moduleName, String name) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// System.out.println(&quot;Find class: &quot; + moduleName + &quot;/&quot; + name);</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"built_in\">this</span>.moduleName.equals(moduleName)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> findClass(name);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (ClassNotFoundException ignored) &#123;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">super</span>.findClass(moduleName, name);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"使用-JDK-内置的类加载器\"><a href=\"#使用-JDK-内置的类加载器\" class=\"headerlink\" title=\"使用 JDK 内置的类加载器\"></a>使用 JDK 内置的类加载器</h3><p>只需要实现 <code>ModuleReference.open(): ModuleReader</code>, 然后使用</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">controller</span> <span class=\"operator\">=</span> ModuleLayer.defineModulesWithOneLoader(</span><br><span class=\"line\">        myConfiguration,</span><br><span class=\"line\">        List.of(bootLayer),</span><br><span class=\"line\">        ClassLoader.getSystemClassLoader().getParent()</span><br><span class=\"line\">);</span><br><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">classLoader</span> <span class=\"operator\">=</span> controller.layer().findLoader(moduleDescriptor.name());</span><br></pre></td></tr></table></figure>\n\n<p>即可使用 JDK 内置的内加载器</p>\n<hr>\n<h2 id=\"完整参考\"><a href=\"#完整参考\" class=\"headerlink\" title=\"完整参考\"></a>完整参考</h2><ul>\n<li><a href=\"https://github.com/Karlatemp/java-module-system-explore\">java-module-system-explore</a><ul>\n<li><a href=\"https://github.com/Karlatemp/java-module-system-explore/blob/master/src/main/java/io/github/karlatemp/jmse/boot/BootModuleByStandard.java\">BootModuleByStandard.java</a></li>\n<li><a href=\"https://github.com/Karlatemp/java-module-system-explore/blob/master/src/main/java/io/github/karlatemp/jmse/boot/MyCustomClassLoader.java\">MyCustomClassLoader.java</a></li>\n</ul>\n</li>\n</ul>\n","site":{"data":{"link":[{"class_name":"友情链接","class_desc":"友情链接","link_list":[{"name":"暂无","link":"","avatar":"","descr":"暂无"}]}]}},"cover":"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7","excerpt":"","more":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>在使用高版本的时候, 总会不可避免的接触到模块系统, 比如反射操作 <code>java.base</code> 已经十分困难. 既然 JDK 内部可以享受到模块的保护, 那么我们自己的代码是否也可以享受到模块系统的保护呢</p>\n<p>当然可以，而且也不是非常麻烦。</p>\n<p>使用模块，你将面对以下问题</p>\n<ul>\n<li><span style=\"color: green\">得到反射保护, 外部代码将不能通过反射强行修改&#x2F;调用私有成员</span></li>\n<li><span style=\"color: red\">更严格的访问控制, 不能直接访问非 required 的模块</span></li>\n<li><span style=\"color: red\">失去 <code>--add-opens=....=ALL-UNNAMED</code> 的归属判断</span></li>\n<li><span style=\"color: gray\">需要专门的 ClassLoader &#x2F; 需要自行实现 ClassLoader</span></li>\n</ul>\n<p>使用模块的适用情况</p>\n<ul>\n<li>需要编写严格的附属(插件)系统</li>\n<li>需要保护自身代码&#x2F;保护自身内存空间</li>\n<li><del>觉得弄着好玩</del></li>\n</ul>\n<h2 id=\"定义一个模块\"><a href=\"#定义一个模块\" class=\"headerlink\" title=\"定义一个模块\"></a>定义一个模块</h2><blockquote>\n<p>注: 此处的定义指的是, 通过运行时代码在运行时定义一个模块.<br>而不是大多数资料说的直接写一个 <code>module-info.java</code></p>\n</blockquote>\n<p>要定义一个模块, 首先需要一个模块的描述符文件 (<code>ModuleDescriptor</code>), 可以从以编码文件读取 (<code>ModuleDescriptor.read(InputStream) &lt;- module-info.class</code>), 也可以在运行时动态生成一个(<code>ModuleDescriptor.newModule(&quot;name_of_module&quot;).build()</code>)</p>\n<p>jvm 通过包来区分模块, 而一个模块的全部包都需要提前指定, jvm 才会为这些包分配到一个模块内</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">moduleDescriptor</span> <span class=\"operator\">=</span> ModuleDescriptor.newModule(<span class=\"string\">&quot;my.custom_module&quot;</span>)</span><br><span class=\"line\">    .packages(Set.of(<span class=\"string\">&quot;io.github.karlatemp.jmse.main&quot;</span>))</span><br><span class=\"line\">    .<span class=\"keyword\">exports</span>(<span class=\"string\">&quot;io.github.karlatemp.jmse.main&quot;</span>)</span><br><span class=\"line\">    .build();</span><br></pre></td></tr></table></figure>\n\n<p>这里我们已经拥有了一个模块的描述符, 现在我们还需要一个模块描述的引用, 以及一个模块查找器以让 jvm 可以找到我们的模块</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">myModuleReference</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ModuleReference</span>(</span><br><span class=\"line\">    moduleDescriptor, <span class=\"literal\">null</span></span><br><span class=\"line\">) &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span> <span class=\"keyword\">public</span> ModuleReader <span class=\"title function_\">open</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">UnsupportedOperationException</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">myModuleFinder</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ModuleFinder</span>() &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Optional&lt;ModuleReference&gt; <span class=\"title function_\">find</span><span class=\"params\">(String name)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (name.equals(moduleDescriptor.name())) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> Optional.of(myModuleReference);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Optional.empty();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Set&lt;ModuleReference&gt; <span class=\"title function_\">findAll</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Set.of(myModuleReference);</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>最后，定义一个模块</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">bootLayer</span> <span class=\"operator\">=</span> ModuleLayer.boot();</span><br><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">myConfiguration</span> <span class=\"operator\">=</span> bootLayer.configuration().resolve(</span><br><span class=\"line\">    myModuleFinder, ModuleFinder.of(), Set.of(moduleDescriptor.name())</span><br><span class=\"line\">);</span><br><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">classLoader</span> <span class=\"operator\">=</span> ClassLoader.getSystemClassLoader();</span><br><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">controller</span> <span class=\"operator\">=</span> ModuleLayer.defineModules(</span><br><span class=\"line\">    myConfiguration, List.of(bootLayer), $ -&gt; classLoader</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">Class.forName(<span class=\"string\">&quot;io.github.karlatemp.jmse.main.ModuleMain&quot;</span>, <span class=\"literal\">false</span>, classLoader)</span><br><span class=\"line\">    .getMethod(<span class=\"string\">&quot;launch&quot;</span>)</span><br><span class=\"line\">    .invoke(<span class=\"literal\">null</span>);</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"ServiceLoader-x2F-Class-forName-Module-String\"><a href=\"#ServiceLoader-x2F-Class-forName-Module-String\" class=\"headerlink\" title=\"ServiceLoader &#x2F; Class.forName(Module, String)\"></a>ServiceLoader &#x2F; Class.forName(Module, String)</h2><p>还记得 <code>需要专门的 ClassLoader / 需要自行实现 ClassLoader</code> 吗, 虽然在上文已经成功定义了一个模块，但是只要使用 <code>ServiceLoader</code> &#x2F; <code>Class.forName(Module, String)</code>, 那么将无法找到对应的类, 因为一般的 ClassLoader 并没有专门处理动态加载的模块</p>\n<h3 id=\"Analyze\"><a href=\"#Analyze\" class=\"headerlink\" title=\"Analyze\"></a>Analyze</h3><p>通过进行调用分析, 最终可以发现以上两个东西最终都进入到了下面的方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ClassLoader</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> Class&lt;?&gt; loadClass(Module <span class=\"keyword\">module</span>, String name) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// First, check if the class has already been loaded</span></span><br><span class=\"line\">            Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (c == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">                c = findClass(<span class=\"keyword\">module</span>.getName(), name);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (c != <span class=\"literal\">null</span> &amp;&amp; c.getModule() == <span class=\"keyword\">module</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> c;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> Class&lt;?&gt; findClass(String moduleName, String name) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (moduleName == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> findClass(name);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (ClassNotFoundException ignore) &#123; &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>不难发现, 由于默认没有处理模块, 导致指定搜索模块的时候将搜索不到动态定义的模块</p>\n<p>而 <code>jdk.internal.loader.ClassLoader$AppClassLoader</code> 并没有处理通过 <code>ModuleLayer.defineModule</code> 定义的模块, 于是也不能直接将模块定义到系统类加载器</p>\n<h3 id=\"自行实现类加载器\"><a href=\"#自行实现类加载器\" class=\"headerlink\" title=\"自行实现类加载器\"></a>自行实现类加载器</h3><p>自行实现类加载器十分简单，只需要</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyCustomClassLoader</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">URLClassLoader</span> &#123;</span><br><span class=\"line\">    String moduleName;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> Class&lt;?&gt; findClass(String moduleName, String name) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// System.out.println(&quot;Find class: &quot; + moduleName + &quot;/&quot; + name);</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"built_in\">this</span>.moduleName.equals(moduleName)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> findClass(name);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (ClassNotFoundException ignored) &#123;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">super</span>.findClass(moduleName, name);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"使用-JDK-内置的类加载器\"><a href=\"#使用-JDK-内置的类加载器\" class=\"headerlink\" title=\"使用 JDK 内置的类加载器\"></a>使用 JDK 内置的类加载器</h3><p>只需要实现 <code>ModuleReference.open(): ModuleReader</code>, 然后使用</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">controller</span> <span class=\"operator\">=</span> ModuleLayer.defineModulesWithOneLoader(</span><br><span class=\"line\">        myConfiguration,</span><br><span class=\"line\">        List.of(bootLayer),</span><br><span class=\"line\">        ClassLoader.getSystemClassLoader().getParent()</span><br><span class=\"line\">);</span><br><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">classLoader</span> <span class=\"operator\">=</span> controller.layer().findLoader(moduleDescriptor.name());</span><br></pre></td></tr></table></figure>\n\n<p>即可使用 JDK 内置的内加载器</p>\n<hr>\n<h2 id=\"完整参考\"><a href=\"#完整参考\" class=\"headerlink\" title=\"完整参考\"></a>完整参考</h2><ul>\n<li><a href=\"https://github.com/Karlatemp/java-module-system-explore\">java-module-system-explore</a><ul>\n<li><a href=\"https://github.com/Karlatemp/java-module-system-explore/blob/master/src/main/java/io/github/karlatemp/jmse/boot/BootModuleByStandard.java\">BootModuleByStandard.java</a></li>\n<li><a href=\"https://github.com/Karlatemp/java-module-system-explore/blob/master/src/main/java/io/github/karlatemp/jmse/boot/MyCustomClassLoader.java\">MyCustomClassLoader.java</a></li>\n</ul>\n</li>\n</ul>\n"},{"title":"JVM 权限逃逸技术","date":"2022-02-22T16:01:00.000Z","_content":"\n*前言: 仅研究 JDK 9+, JDK 8- 无研究意义*\n\n\n从 `Java 9` 开始, Java 引入了一个新的概念, `模块(Module)`. 模块的存在, 限制了反射技术, 在 `JDK 16` 中, 直接反射越权修改 `java.base` 甚至会得到错误 `java.lang.reflect.InaccessibleObjectException`, 对于某些需要的 devops 而言意味着无法完成预期操作\n\n---\n\n在阅读 `java.lang.reflect.AccessibleObject` 源码后, 有如下代码片段\n\n```java\n\n   /**\n    * If the given AccessibleObject is a {@code Constructor}, {@code Method}\n    * or {@code Field} then checks that its declaring class is in a package\n    * that can be accessed by the given caller of setAccessible.\n    */\n    void checkCanSetAccessible(Class<?> caller) {\n        // do nothing, needs to be overridden by Constructor, Method, Field\n    }\n\n    final void checkCanSetAccessible(Class<?> caller, Class<?> declaringClass) {\n        checkCanSetAccessible(caller, declaringClass, true);\n    }\n\n    private boolean checkCanSetAccessible(Class<?> caller,\n                                          Class<?> declaringClass,\n                                          boolean throwExceptionIfDenied) {\n        if (caller == MethodHandle.class) {\n            throw new IllegalCallerException();   // should not happen\n        }\n\n        Module callerModule = caller.getModule();\n        Module declaringModule = declaringClass.getModule();\n\n        if (callerModule == declaringModule) return true;\n        if (callerModule == Object.class.getModule()) return true;\n        if (!declaringModule.isNamed()) return true;\n\n        String pn = declaringClass.getPackageName();\n        int modifiers;\n        if (this instanceof Executable) {\n            modifiers = ((Executable) this).getModifiers();\n        } else {\n            modifiers = ((Field) this).getModifiers();\n        }\n\n        // class is public and package is exported to caller\n        boolean isClassPublic = Modifier.isPublic(declaringClass.getModifiers());\n        if (isClassPublic && declaringModule.isExported(pn, callerModule)) {\n            // member is public\n            if (Modifier.isPublic(modifiers)) {\n                logIfExportedForIllegalAccess(caller, declaringClass);\n                return true;\n            }\n\n            // member is protected-static\n            if (Modifier.isProtected(modifiers)\n                && Modifier.isStatic(modifiers)\n                && isSubclassOf(caller, declaringClass)) {\n                logIfExportedForIllegalAccess(caller, declaringClass);\n                return true;\n            }\n        }\n\n        // package is open to caller\n        if (declaringModule.isOpen(pn, callerModule)) {\n            logIfOpenedForIllegalAccess(caller, declaringClass);\n            return true;\n        }\n\n        if (throwExceptionIfDenied) {\n            // not accessible\n            String msg = \"Unable to make \";\n            if (this instanceof Field)\n                msg += \"field \";\n            msg += this + \" accessible: \" + declaringModule + \" does not \\\"\";\n            if (isClassPublic && Modifier.isPublic(modifiers))\n                msg += \"exports\";\n            else\n                msg += \"opens\";\n            msg += \" \" + pn + \"\\\" to \" + callerModule;\n            InaccessibleObjectException e = new InaccessibleObjectException(msg);\n            if (printStackTraceWhenAccessFails()) {\n                e.printStackTrace(System.err);\n            }\n            throw e;\n        }\n        return false;\n    }\n\n```\n\n有两个关键判断逻辑: `declaringModule.isExported(pn, callerModule)`, `declaringModule.isOpen(pn, callerModule)`\n\n阅读 `Module.java` 后发现有 `implAddExports` 方法, 通过 `IDEA` 查找调用引用发现了 `java.lang.System` 有访问此方法的 `JDK Internal API`\n\n```java\n\n    private static void setJavaLangAccess() {\n        // Allow privileged classes outside of java.lang\n        SharedSecrets.setJavaLangAccess(new JavaLangAccess() {\n            public Module defineModule(ClassLoader loader,\n                                       ModuleDescriptor descriptor,\n                                       URI uri) {\n                return new Module(null, loader, descriptor, uri);\n            }\n            public Module defineUnnamedModule(ClassLoader loader) {\n                return new Module(loader);\n            }\n            public void addReads(Module m1, Module m2) {\n                m1.implAddReads(m2);\n            }\n            public void addReadsAllUnnamed(Module m) {\n                m.implAddReadsAllUnnamed();\n            }\n            public void addExports(Module m, String pn, Module other) {\n                m.implAddExports(pn, other);\n            }\n            public void addExportsToAllUnnamed(Module m, String pn) {\n                m.implAddExportsToAllUnnamed(pn);\n            }\n            public void addOpens(Module m, String pn, Module other) {\n                m.implAddOpens(pn, other);\n            }\n            public void addOpensToAllUnnamed(Module m, String pn) {\n                m.implAddOpensToAllUnnamed(pn);\n            }\n            public void addOpensToAllUnnamed(Module m, Set<String> concealedPackages, Set<String> exportedPackages) {\n                m.implAddOpensToAllUnnamed(concealedPackages, exportedPackages);\n            }\n            public void addUses(Module m, Class<?> service) {\n                m.implAddUses(service);\n            }\n        });\n    }\n```\n\n找到了 JDK 提供的后门之后, 我们只需要调用 `SharedSecrets.getJavaLangAccess().addExports` 就能开后门了....\n不对，目前还无法调用 `SharedSecrets`, 还需要一些手段....\n\n在 `java.lang.reflect` 中翻到了一个特别的东西, `java.lang.reflect.Proxy`, 她是破局的关键中心\n\n抱着好奇的心里, 我尝试了使用 `Proxy` 实现 `jdk.internal.access` 中的一个接口玩玩\n\n```java\n    public static void main(String[] args) throws Exception {\n        var obj = Proxy.newProxyInstance(\n                Usffsa.class.getClassLoader(),\n                new Class[]{Class.forName(\"jdk.internal.access.JavaLangAccess\")},\n                new InvocationHandler() {\n                    @Override\n                    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n                        return null;\n                    }\n                }\n        );\n        System.out.println(obj);\n    }\n```\n\n没想到, 运行成功了(eg: 没有对应权限(`Exported`)是不能实现对应接口的), 迎接着激动的心情, 输出了更多的详细信息\n\n```java\n        System.out.println(obj);\n        System.out.println(obj.getClass());\n        System.out.println(obj.getClass().getModule());\n        System.out.println(Object.class.getModule().isExported(\"jdk.internal.access\", obj.getClass().getModule()));\n```\n\n```\nnull\nclass com.sun.proxy.jdk.proxy1.$Proxy0\nmodule jdk.proxy1\ntrue\n```\n\n破局点找到了, `java.lang.reflect.Proxy` 拥有打开模块访问的权利, 然后尝试对该模块进行注入\n\n```java\n    public static void main(String[] args) throws Exception {\n        var ccl = new ClassLoader(Usffsa.class.getClassLoader()) {\n            Class<?> defineClass(byte[] code) {\n                return defineClass(null, code, 0, code.length);\n            }\n        };\n        var obj = Proxy.newProxyInstance(\n                ccl,\n                new Class[]{Class.forName(\"jdk.internal.access.JavaLangAccess\")},\n                (proxy, method, args1) -> null\n        );\n        var writer = new ClassWriter(0); // org.objectweb.asm.ClassWriter\n        writer.visit(Opcodes.V1_8, 0,\n                obj.getClass().getPackageName().replace('.', '/') + \"/Test0\",\n                null,\n                \"java/lang/Object\",\n                null\n        );\n        var injectedClass = ccl.defineClass(writer.toByteArray());\n        System.out.println(\"Proxy     Module  : \" + obj.getClass().getModule());\n        System.out.println(\"Injected  Module  : \" + injectedClass.getModule());\n        System.out.println(\"Is Same Module    : \" + (injectedClass.getModule() == obj.getClass().getModule()));\n    }\n```\n```\nProxy     Module  : module jdk.proxy1\nInjected  Module  : module jdk.proxy1\nIs Same Module    : true\n```\n\n至此已经破开了 JVM 的模块限制的死局, 实际应用可参考 [\\[Karlatemp/UnsafeAccessor\\]](https://github.com/Karlatemp/UnsafeAccessor)\n","source":"_posts/jvm-root/unsafe.md","raw":"---\ntitle: JVM 权限逃逸技术\ncategories: [jvm]\ntags: [jvm, root, jdk9]\ndate: 2022-02-23 00:01:00\n---\n\n*前言: 仅研究 JDK 9+, JDK 8- 无研究意义*\n\n\n从 `Java 9` 开始, Java 引入了一个新的概念, `模块(Module)`. 模块的存在, 限制了反射技术, 在 `JDK 16` 中, 直接反射越权修改 `java.base` 甚至会得到错误 `java.lang.reflect.InaccessibleObjectException`, 对于某些需要的 devops 而言意味着无法完成预期操作\n\n---\n\n在阅读 `java.lang.reflect.AccessibleObject` 源码后, 有如下代码片段\n\n```java\n\n   /**\n    * If the given AccessibleObject is a {@code Constructor}, {@code Method}\n    * or {@code Field} then checks that its declaring class is in a package\n    * that can be accessed by the given caller of setAccessible.\n    */\n    void checkCanSetAccessible(Class<?> caller) {\n        // do nothing, needs to be overridden by Constructor, Method, Field\n    }\n\n    final void checkCanSetAccessible(Class<?> caller, Class<?> declaringClass) {\n        checkCanSetAccessible(caller, declaringClass, true);\n    }\n\n    private boolean checkCanSetAccessible(Class<?> caller,\n                                          Class<?> declaringClass,\n                                          boolean throwExceptionIfDenied) {\n        if (caller == MethodHandle.class) {\n            throw new IllegalCallerException();   // should not happen\n        }\n\n        Module callerModule = caller.getModule();\n        Module declaringModule = declaringClass.getModule();\n\n        if (callerModule == declaringModule) return true;\n        if (callerModule == Object.class.getModule()) return true;\n        if (!declaringModule.isNamed()) return true;\n\n        String pn = declaringClass.getPackageName();\n        int modifiers;\n        if (this instanceof Executable) {\n            modifiers = ((Executable) this).getModifiers();\n        } else {\n            modifiers = ((Field) this).getModifiers();\n        }\n\n        // class is public and package is exported to caller\n        boolean isClassPublic = Modifier.isPublic(declaringClass.getModifiers());\n        if (isClassPublic && declaringModule.isExported(pn, callerModule)) {\n            // member is public\n            if (Modifier.isPublic(modifiers)) {\n                logIfExportedForIllegalAccess(caller, declaringClass);\n                return true;\n            }\n\n            // member is protected-static\n            if (Modifier.isProtected(modifiers)\n                && Modifier.isStatic(modifiers)\n                && isSubclassOf(caller, declaringClass)) {\n                logIfExportedForIllegalAccess(caller, declaringClass);\n                return true;\n            }\n        }\n\n        // package is open to caller\n        if (declaringModule.isOpen(pn, callerModule)) {\n            logIfOpenedForIllegalAccess(caller, declaringClass);\n            return true;\n        }\n\n        if (throwExceptionIfDenied) {\n            // not accessible\n            String msg = \"Unable to make \";\n            if (this instanceof Field)\n                msg += \"field \";\n            msg += this + \" accessible: \" + declaringModule + \" does not \\\"\";\n            if (isClassPublic && Modifier.isPublic(modifiers))\n                msg += \"exports\";\n            else\n                msg += \"opens\";\n            msg += \" \" + pn + \"\\\" to \" + callerModule;\n            InaccessibleObjectException e = new InaccessibleObjectException(msg);\n            if (printStackTraceWhenAccessFails()) {\n                e.printStackTrace(System.err);\n            }\n            throw e;\n        }\n        return false;\n    }\n\n```\n\n有两个关键判断逻辑: `declaringModule.isExported(pn, callerModule)`, `declaringModule.isOpen(pn, callerModule)`\n\n阅读 `Module.java` 后发现有 `implAddExports` 方法, 通过 `IDEA` 查找调用引用发现了 `java.lang.System` 有访问此方法的 `JDK Internal API`\n\n```java\n\n    private static void setJavaLangAccess() {\n        // Allow privileged classes outside of java.lang\n        SharedSecrets.setJavaLangAccess(new JavaLangAccess() {\n            public Module defineModule(ClassLoader loader,\n                                       ModuleDescriptor descriptor,\n                                       URI uri) {\n                return new Module(null, loader, descriptor, uri);\n            }\n            public Module defineUnnamedModule(ClassLoader loader) {\n                return new Module(loader);\n            }\n            public void addReads(Module m1, Module m2) {\n                m1.implAddReads(m2);\n            }\n            public void addReadsAllUnnamed(Module m) {\n                m.implAddReadsAllUnnamed();\n            }\n            public void addExports(Module m, String pn, Module other) {\n                m.implAddExports(pn, other);\n            }\n            public void addExportsToAllUnnamed(Module m, String pn) {\n                m.implAddExportsToAllUnnamed(pn);\n            }\n            public void addOpens(Module m, String pn, Module other) {\n                m.implAddOpens(pn, other);\n            }\n            public void addOpensToAllUnnamed(Module m, String pn) {\n                m.implAddOpensToAllUnnamed(pn);\n            }\n            public void addOpensToAllUnnamed(Module m, Set<String> concealedPackages, Set<String> exportedPackages) {\n                m.implAddOpensToAllUnnamed(concealedPackages, exportedPackages);\n            }\n            public void addUses(Module m, Class<?> service) {\n                m.implAddUses(service);\n            }\n        });\n    }\n```\n\n找到了 JDK 提供的后门之后, 我们只需要调用 `SharedSecrets.getJavaLangAccess().addExports` 就能开后门了....\n不对，目前还无法调用 `SharedSecrets`, 还需要一些手段....\n\n在 `java.lang.reflect` 中翻到了一个特别的东西, `java.lang.reflect.Proxy`, 她是破局的关键中心\n\n抱着好奇的心里, 我尝试了使用 `Proxy` 实现 `jdk.internal.access` 中的一个接口玩玩\n\n```java\n    public static void main(String[] args) throws Exception {\n        var obj = Proxy.newProxyInstance(\n                Usffsa.class.getClassLoader(),\n                new Class[]{Class.forName(\"jdk.internal.access.JavaLangAccess\")},\n                new InvocationHandler() {\n                    @Override\n                    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n                        return null;\n                    }\n                }\n        );\n        System.out.println(obj);\n    }\n```\n\n没想到, 运行成功了(eg: 没有对应权限(`Exported`)是不能实现对应接口的), 迎接着激动的心情, 输出了更多的详细信息\n\n```java\n        System.out.println(obj);\n        System.out.println(obj.getClass());\n        System.out.println(obj.getClass().getModule());\n        System.out.println(Object.class.getModule().isExported(\"jdk.internal.access\", obj.getClass().getModule()));\n```\n\n```\nnull\nclass com.sun.proxy.jdk.proxy1.$Proxy0\nmodule jdk.proxy1\ntrue\n```\n\n破局点找到了, `java.lang.reflect.Proxy` 拥有打开模块访问的权利, 然后尝试对该模块进行注入\n\n```java\n    public static void main(String[] args) throws Exception {\n        var ccl = new ClassLoader(Usffsa.class.getClassLoader()) {\n            Class<?> defineClass(byte[] code) {\n                return defineClass(null, code, 0, code.length);\n            }\n        };\n        var obj = Proxy.newProxyInstance(\n                ccl,\n                new Class[]{Class.forName(\"jdk.internal.access.JavaLangAccess\")},\n                (proxy, method, args1) -> null\n        );\n        var writer = new ClassWriter(0); // org.objectweb.asm.ClassWriter\n        writer.visit(Opcodes.V1_8, 0,\n                obj.getClass().getPackageName().replace('.', '/') + \"/Test0\",\n                null,\n                \"java/lang/Object\",\n                null\n        );\n        var injectedClass = ccl.defineClass(writer.toByteArray());\n        System.out.println(\"Proxy     Module  : \" + obj.getClass().getModule());\n        System.out.println(\"Injected  Module  : \" + injectedClass.getModule());\n        System.out.println(\"Is Same Module    : \" + (injectedClass.getModule() == obj.getClass().getModule()));\n    }\n```\n```\nProxy     Module  : module jdk.proxy1\nInjected  Module  : module jdk.proxy1\nIs Same Module    : true\n```\n\n至此已经破开了 JVM 的模块限制的死局, 实际应用可参考 [\\[Karlatemp/UnsafeAccessor\\]](https://github.com/Karlatemp/UnsafeAccessor)\n","slug":"jvm-root/unsafe","published":1,"updated":"2022-03-12T13:52:41.943Z","_id":"ckzzmscpq0009b5oe6vpg9k88","comments":1,"layout":"post","photos":[],"link":"","content":"<p><em>前言: 仅研究 JDK 9+, JDK 8- 无研究意义</em></p>\n<p>从 <code>Java 9</code> 开始, Java 引入了一个新的概念, <code>模块(Module)</code>. 模块的存在, 限制了反射技术, 在 <code>JDK 16</code> 中, 直接反射越权修改 <code>java.base</code> 甚至会得到错误 <code>java.lang.reflect.InaccessibleObjectException</code>, 对于某些需要的 devops 而言意味着无法完成预期操作</p>\n<hr>\n<p>在阅读 <code>java.lang.reflect.AccessibleObject</code> 源码后, 有如下代码片段</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * If the given AccessibleObject is a &#123;<span class=\"doctag\">@code</span> Constructor&#125;, &#123;<span class=\"doctag\">@code</span> Method&#125;</span></span><br><span class=\"line\"><span class=\"comment\"> * or &#123;<span class=\"doctag\">@code</span> Field&#125; then checks that its declaring class is in a package</span></span><br><span class=\"line\"><span class=\"comment\"> * that can be accessed by the given caller of setAccessible.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"> <span class=\"keyword\">void</span> <span class=\"title function_\">checkCanSetAccessible</span><span class=\"params\">(Class&lt;?&gt; caller)</span> &#123;</span><br><span class=\"line\">     <span class=\"comment\">// do nothing, needs to be overridden by Constructor, Method, Field</span></span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">checkCanSetAccessible</span><span class=\"params\">(Class&lt;?&gt; caller, Class&lt;?&gt; declaringClass)</span> &#123;</span><br><span class=\"line\">     checkCanSetAccessible(caller, declaringClass, <span class=\"literal\">true</span>);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"keyword\">private</span> <span class=\"type\">boolean</span> <span class=\"title function_\">checkCanSetAccessible</span><span class=\"params\">(Class&lt;?&gt; caller,</span></span><br><span class=\"line\"><span class=\"params\">                                       Class&lt;?&gt; declaringClass,</span></span><br><span class=\"line\"><span class=\"params\">                                       <span class=\"type\">boolean</span> throwExceptionIfDenied)</span> &#123;</span><br><span class=\"line\">     <span class=\"keyword\">if</span> (caller == MethodHandle.class) &#123;</span><br><span class=\"line\">         <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalCallerException</span>();   <span class=\"comment\">// should not happen</span></span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"type\">Module</span> <span class=\"variable\">callerModule</span> <span class=\"operator\">=</span> caller.getModule();</span><br><span class=\"line\">     <span class=\"type\">Module</span> <span class=\"variable\">declaringModule</span> <span class=\"operator\">=</span> declaringClass.getModule();</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"keyword\">if</span> (callerModule == declaringModule) <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">     <span class=\"keyword\">if</span> (callerModule == Object.class.getModule()) <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">     <span class=\"keyword\">if</span> (!declaringModule.isNamed()) <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"type\">String</span> <span class=\"variable\">pn</span> <span class=\"operator\">=</span> declaringClass.getPackageName();</span><br><span class=\"line\">     <span class=\"type\">int</span> modifiers;</span><br><span class=\"line\">     <span class=\"keyword\">if</span> (<span class=\"built_in\">this</span> <span class=\"keyword\">instanceof</span> Executable) &#123;</span><br><span class=\"line\">         modifiers = ((Executable) <span class=\"built_in\">this</span>).getModifiers();</span><br><span class=\"line\">     &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">         modifiers = ((Field) <span class=\"built_in\">this</span>).getModifiers();</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"comment\">// class is public and package is exported to caller</span></span><br><span class=\"line\">     <span class=\"type\">boolean</span> <span class=\"variable\">isClassPublic</span> <span class=\"operator\">=</span> Modifier.isPublic(declaringClass.getModifiers());</span><br><span class=\"line\">     <span class=\"keyword\">if</span> (isClassPublic &amp;&amp; declaringModule.isExported(pn, callerModule)) &#123;</span><br><span class=\"line\">         <span class=\"comment\">// member is public</span></span><br><span class=\"line\">         <span class=\"keyword\">if</span> (Modifier.isPublic(modifiers)) &#123;</span><br><span class=\"line\">             logIfExportedForIllegalAccess(caller, declaringClass);</span><br><span class=\"line\">             <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">         <span class=\"comment\">// member is protected-static</span></span><br><span class=\"line\">         <span class=\"keyword\">if</span> (Modifier.isProtected(modifiers)</span><br><span class=\"line\">             &amp;&amp; Modifier.isStatic(modifiers)</span><br><span class=\"line\">             &amp;&amp; isSubclassOf(caller, declaringClass)) &#123;</span><br><span class=\"line\">             logIfExportedForIllegalAccess(caller, declaringClass);</span><br><span class=\"line\">             <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"comment\">// package is open to caller</span></span><br><span class=\"line\">     <span class=\"keyword\">if</span> (declaringModule.isOpen(pn, callerModule)) &#123;</span><br><span class=\"line\">         logIfOpenedForIllegalAccess(caller, declaringClass);</span><br><span class=\"line\">         <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"keyword\">if</span> (throwExceptionIfDenied) &#123;</span><br><span class=\"line\">         <span class=\"comment\">// not accessible</span></span><br><span class=\"line\">         <span class=\"type\">String</span> <span class=\"variable\">msg</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;Unable to make &quot;</span>;</span><br><span class=\"line\">         <span class=\"keyword\">if</span> (<span class=\"built_in\">this</span> <span class=\"keyword\">instanceof</span> Field)</span><br><span class=\"line\">             msg += <span class=\"string\">&quot;field &quot;</span>;</span><br><span class=\"line\">         msg += <span class=\"built_in\">this</span> + <span class=\"string\">&quot; accessible: &quot;</span> + declaringModule + <span class=\"string\">&quot; does not \\&quot;&quot;</span>;</span><br><span class=\"line\">         <span class=\"keyword\">if</span> (isClassPublic &amp;&amp; Modifier.isPublic(modifiers))</span><br><span class=\"line\">             msg += <span class=\"string\">&quot;exports&quot;</span>;</span><br><span class=\"line\">         <span class=\"keyword\">else</span></span><br><span class=\"line\">             msg += <span class=\"string\">&quot;opens&quot;</span>;</span><br><span class=\"line\">         msg += <span class=\"string\">&quot; &quot;</span> + pn + <span class=\"string\">&quot;\\&quot; to &quot;</span> + callerModule;</span><br><span class=\"line\">         <span class=\"type\">InaccessibleObjectException</span> <span class=\"variable\">e</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">InaccessibleObjectException</span>(msg);</span><br><span class=\"line\">         <span class=\"keyword\">if</span> (printStackTraceWhenAccessFails()) &#123;</span><br><span class=\"line\">             e.printStackTrace(System.err);</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\">         <span class=\"keyword\">throw</span> e;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">     <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>有两个关键判断逻辑: <code>declaringModule.isExported(pn, callerModule)</code>, <code>declaringModule.isOpen(pn, callerModule)</code></p>\n<p>阅读 <code>Module.java</code> 后发现有 <code>implAddExports</code> 方法, 通过 <code>IDEA</code> 查找调用引用发现了 <code>java.lang.System</code> 有访问此方法的 <code>JDK Internal API</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setJavaLangAccess</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Allow privileged classes outside of java.lang</span></span><br><span class=\"line\">    SharedSecrets.setJavaLangAccess(<span class=\"keyword\">new</span> <span class=\"title class_\">JavaLangAccess</span>() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> Module <span class=\"title function_\">defineModule</span><span class=\"params\">(ClassLoader loader,</span></span><br><span class=\"line\"><span class=\"params\">                                   ModuleDescriptor descriptor,</span></span><br><span class=\"line\"><span class=\"params\">                                   URI uri)</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Module</span>(<span class=\"literal\">null</span>, loader, descriptor, uri);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> Module <span class=\"title function_\">defineUnnamedModule</span><span class=\"params\">(ClassLoader loader)</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Module</span>(loader);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addReads</span><span class=\"params\">(Module m1, Module m2)</span> &#123;</span><br><span class=\"line\">            m1.implAddReads(m2);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addReadsAllUnnamed</span><span class=\"params\">(Module m)</span> &#123;</span><br><span class=\"line\">            m.implAddReadsAllUnnamed();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addExports</span><span class=\"params\">(Module m, String pn, Module other)</span> &#123;</span><br><span class=\"line\">            m.implAddExports(pn, other);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addExportsToAllUnnamed</span><span class=\"params\">(Module m, String pn)</span> &#123;</span><br><span class=\"line\">            m.implAddExportsToAllUnnamed(pn);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addOpens</span><span class=\"params\">(Module m, String pn, Module other)</span> &#123;</span><br><span class=\"line\">            m.implAddOpens(pn, other);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addOpensToAllUnnamed</span><span class=\"params\">(Module m, String pn)</span> &#123;</span><br><span class=\"line\">            m.implAddOpensToAllUnnamed(pn);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addOpensToAllUnnamed</span><span class=\"params\">(Module m, Set&lt;String&gt; concealedPackages, Set&lt;String&gt; exportedPackages)</span> &#123;</span><br><span class=\"line\">            m.implAddOpensToAllUnnamed(concealedPackages, exportedPackages);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addUses</span><span class=\"params\">(Module m, Class&lt;?&gt; service)</span> &#123;</span><br><span class=\"line\">            m.implAddUses(service);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>找到了 JDK 提供的后门之后, 我们只需要调用 <code>SharedSecrets.getJavaLangAccess().addExports</code> 就能开后门了….<br>不对，目前还无法调用 <code>SharedSecrets</code>, 还需要一些手段….</p>\n<p>在 <code>java.lang.reflect</code> 中翻到了一个特别的东西, <code>java.lang.reflect.Proxy</code>, 她是破局的关键中心</p>\n<p>抱着好奇的心里, 我尝试了使用 <code>Proxy</code> 实现 <code>jdk.internal.access</code> 中的一个接口玩玩</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">    <span class=\"type\">var</span> <span class=\"variable\">obj</span> <span class=\"operator\">=</span> Proxy.newProxyInstance(</span><br><span class=\"line\">            Usffsa.class.getClassLoader(),</span><br><span class=\"line\">            <span class=\"keyword\">new</span> <span class=\"title class_\">Class</span>[]&#123;Class.forName(<span class=\"string\">&quot;jdk.internal.access.JavaLangAccess&quot;</span>)&#125;,</span><br><span class=\"line\">            <span class=\"keyword\">new</span> <span class=\"title class_\">InvocationHandler</span>() &#123;</span><br><span class=\"line\">                <span class=\"meta\">@Override</span></span><br><span class=\"line\">                <span class=\"keyword\">public</span> Object <span class=\"title function_\">invoke</span><span class=\"params\">(Object proxy, Method method, Object[] args)</span> <span class=\"keyword\">throws</span> Throwable &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    );</span><br><span class=\"line\">    System.out.println(obj);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>没想到, 运行成功了(eg: 没有对应权限(<code>Exported</code>)是不能实现对应接口的), 迎接着激动的心情, 输出了更多的详细信息</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">System.out.println(obj);</span><br><span class=\"line\">System.out.println(obj.getClass());</span><br><span class=\"line\">System.out.println(obj.getClass().getModule());</span><br><span class=\"line\">System.out.println(Object.class.getModule().isExported(<span class=\"string\">&quot;jdk.internal.access&quot;</span>, obj.getClass().getModule()));</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">null</span><br><span class=\"line\">class com.sun.proxy.jdk.proxy1.$Proxy0</span><br><span class=\"line\">module jdk.proxy1</span><br><span class=\"line\">true</span><br></pre></td></tr></table></figure>\n\n<p>破局点找到了, <code>java.lang.reflect.Proxy</code> 拥有打开模块访问的权利, 然后尝试对该模块进行注入</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">    <span class=\"type\">var</span> <span class=\"variable\">ccl</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ClassLoader</span>(Usffsa.class.getClassLoader()) &#123;</span><br><span class=\"line\">        Class&lt;?&gt; defineClass(<span class=\"type\">byte</span>[] code) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> defineClass(<span class=\"literal\">null</span>, code, <span class=\"number\">0</span>, code.length);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    <span class=\"type\">var</span> <span class=\"variable\">obj</span> <span class=\"operator\">=</span> Proxy.newProxyInstance(</span><br><span class=\"line\">            ccl,</span><br><span class=\"line\">            <span class=\"keyword\">new</span> <span class=\"title class_\">Class</span>[]&#123;Class.forName(<span class=\"string\">&quot;jdk.internal.access.JavaLangAccess&quot;</span>)&#125;,</span><br><span class=\"line\">            (proxy, method, args1) -&gt; <span class=\"literal\">null</span></span><br><span class=\"line\">    );</span><br><span class=\"line\">    <span class=\"type\">var</span> <span class=\"variable\">writer</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ClassWriter</span>(<span class=\"number\">0</span>); <span class=\"comment\">// org.objectweb.asm.ClassWriter</span></span><br><span class=\"line\">    writer.visit(Opcodes.V1_8, <span class=\"number\">0</span>,</span><br><span class=\"line\">            obj.getClass().getPackageName().replace(<span class=\"string\">&#x27;.&#x27;</span>, <span class=\"string\">&#x27;/&#x27;</span>) + <span class=\"string\">&quot;/Test0&quot;</span>,</span><br><span class=\"line\">            <span class=\"literal\">null</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;java/lang/Object&quot;</span>,</span><br><span class=\"line\">            <span class=\"literal\">null</span></span><br><span class=\"line\">    );</span><br><span class=\"line\">    <span class=\"type\">var</span> <span class=\"variable\">injectedClass</span> <span class=\"operator\">=</span> ccl.defineClass(writer.toByteArray());</span><br><span class=\"line\">    System.out.println(<span class=\"string\">&quot;Proxy     Module  : &quot;</span> + obj.getClass().getModule());</span><br><span class=\"line\">    System.out.println(<span class=\"string\">&quot;Injected  Module  : &quot;</span> + injectedClass.getModule());</span><br><span class=\"line\">    System.out.println(<span class=\"string\">&quot;Is Same Module    : &quot;</span> + (injectedClass.getModule() == obj.getClass().getModule()));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Proxy     Module  : module jdk.proxy1</span><br><span class=\"line\">Injected  Module  : module jdk.proxy1</span><br><span class=\"line\">Is Same Module    : true</span><br></pre></td></tr></table></figure>\n\n<p>至此已经破开了 JVM 的模块限制的死局, 实际应用可参考 <a href=\"https://github.com/Karlatemp/UnsafeAccessor\">[Karlatemp&#x2F;UnsafeAccessor]</a></p>\n","site":{"data":{"link":[{"class_name":"友情链接","class_desc":"友情链接","link_list":[{"name":"暂无","link":"","avatar":"","descr":"暂无"}]}]}},"cover":"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7","excerpt":"","more":"<p><em>前言: 仅研究 JDK 9+, JDK 8- 无研究意义</em></p>\n<p>从 <code>Java 9</code> 开始, Java 引入了一个新的概念, <code>模块(Module)</code>. 模块的存在, 限制了反射技术, 在 <code>JDK 16</code> 中, 直接反射越权修改 <code>java.base</code> 甚至会得到错误 <code>java.lang.reflect.InaccessibleObjectException</code>, 对于某些需要的 devops 而言意味着无法完成预期操作</p>\n<hr>\n<p>在阅读 <code>java.lang.reflect.AccessibleObject</code> 源码后, 有如下代码片段</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * If the given AccessibleObject is a &#123;<span class=\"doctag\">@code</span> Constructor&#125;, &#123;<span class=\"doctag\">@code</span> Method&#125;</span></span><br><span class=\"line\"><span class=\"comment\"> * or &#123;<span class=\"doctag\">@code</span> Field&#125; then checks that its declaring class is in a package</span></span><br><span class=\"line\"><span class=\"comment\"> * that can be accessed by the given caller of setAccessible.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"> <span class=\"keyword\">void</span> <span class=\"title function_\">checkCanSetAccessible</span><span class=\"params\">(Class&lt;?&gt; caller)</span> &#123;</span><br><span class=\"line\">     <span class=\"comment\">// do nothing, needs to be overridden by Constructor, Method, Field</span></span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title function_\">checkCanSetAccessible</span><span class=\"params\">(Class&lt;?&gt; caller, Class&lt;?&gt; declaringClass)</span> &#123;</span><br><span class=\"line\">     checkCanSetAccessible(caller, declaringClass, <span class=\"literal\">true</span>);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"keyword\">private</span> <span class=\"type\">boolean</span> <span class=\"title function_\">checkCanSetAccessible</span><span class=\"params\">(Class&lt;?&gt; caller,</span></span><br><span class=\"line\"><span class=\"params\">                                       Class&lt;?&gt; declaringClass,</span></span><br><span class=\"line\"><span class=\"params\">                                       <span class=\"type\">boolean</span> throwExceptionIfDenied)</span> &#123;</span><br><span class=\"line\">     <span class=\"keyword\">if</span> (caller == MethodHandle.class) &#123;</span><br><span class=\"line\">         <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">IllegalCallerException</span>();   <span class=\"comment\">// should not happen</span></span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"type\">Module</span> <span class=\"variable\">callerModule</span> <span class=\"operator\">=</span> caller.getModule();</span><br><span class=\"line\">     <span class=\"type\">Module</span> <span class=\"variable\">declaringModule</span> <span class=\"operator\">=</span> declaringClass.getModule();</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"keyword\">if</span> (callerModule == declaringModule) <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">     <span class=\"keyword\">if</span> (callerModule == Object.class.getModule()) <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">     <span class=\"keyword\">if</span> (!declaringModule.isNamed()) <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"type\">String</span> <span class=\"variable\">pn</span> <span class=\"operator\">=</span> declaringClass.getPackageName();</span><br><span class=\"line\">     <span class=\"type\">int</span> modifiers;</span><br><span class=\"line\">     <span class=\"keyword\">if</span> (<span class=\"built_in\">this</span> <span class=\"keyword\">instanceof</span> Executable) &#123;</span><br><span class=\"line\">         modifiers = ((Executable) <span class=\"built_in\">this</span>).getModifiers();</span><br><span class=\"line\">     &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">         modifiers = ((Field) <span class=\"built_in\">this</span>).getModifiers();</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"comment\">// class is public and package is exported to caller</span></span><br><span class=\"line\">     <span class=\"type\">boolean</span> <span class=\"variable\">isClassPublic</span> <span class=\"operator\">=</span> Modifier.isPublic(declaringClass.getModifiers());</span><br><span class=\"line\">     <span class=\"keyword\">if</span> (isClassPublic &amp;&amp; declaringModule.isExported(pn, callerModule)) &#123;</span><br><span class=\"line\">         <span class=\"comment\">// member is public</span></span><br><span class=\"line\">         <span class=\"keyword\">if</span> (Modifier.isPublic(modifiers)) &#123;</span><br><span class=\"line\">             logIfExportedForIllegalAccess(caller, declaringClass);</span><br><span class=\"line\">             <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">         <span class=\"comment\">// member is protected-static</span></span><br><span class=\"line\">         <span class=\"keyword\">if</span> (Modifier.isProtected(modifiers)</span><br><span class=\"line\">             &amp;&amp; Modifier.isStatic(modifiers)</span><br><span class=\"line\">             &amp;&amp; isSubclassOf(caller, declaringClass)) &#123;</span><br><span class=\"line\">             logIfExportedForIllegalAccess(caller, declaringClass);</span><br><span class=\"line\">             <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"comment\">// package is open to caller</span></span><br><span class=\"line\">     <span class=\"keyword\">if</span> (declaringModule.isOpen(pn, callerModule)) &#123;</span><br><span class=\"line\">         logIfOpenedForIllegalAccess(caller, declaringClass);</span><br><span class=\"line\">         <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"keyword\">if</span> (throwExceptionIfDenied) &#123;</span><br><span class=\"line\">         <span class=\"comment\">// not accessible</span></span><br><span class=\"line\">         <span class=\"type\">String</span> <span class=\"variable\">msg</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;Unable to make &quot;</span>;</span><br><span class=\"line\">         <span class=\"keyword\">if</span> (<span class=\"built_in\">this</span> <span class=\"keyword\">instanceof</span> Field)</span><br><span class=\"line\">             msg += <span class=\"string\">&quot;field &quot;</span>;</span><br><span class=\"line\">         msg += <span class=\"built_in\">this</span> + <span class=\"string\">&quot; accessible: &quot;</span> + declaringModule + <span class=\"string\">&quot; does not \\&quot;&quot;</span>;</span><br><span class=\"line\">         <span class=\"keyword\">if</span> (isClassPublic &amp;&amp; Modifier.isPublic(modifiers))</span><br><span class=\"line\">             msg += <span class=\"string\">&quot;exports&quot;</span>;</span><br><span class=\"line\">         <span class=\"keyword\">else</span></span><br><span class=\"line\">             msg += <span class=\"string\">&quot;opens&quot;</span>;</span><br><span class=\"line\">         msg += <span class=\"string\">&quot; &quot;</span> + pn + <span class=\"string\">&quot;\\&quot; to &quot;</span> + callerModule;</span><br><span class=\"line\">         <span class=\"type\">InaccessibleObjectException</span> <span class=\"variable\">e</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">InaccessibleObjectException</span>(msg);</span><br><span class=\"line\">         <span class=\"keyword\">if</span> (printStackTraceWhenAccessFails()) &#123;</span><br><span class=\"line\">             e.printStackTrace(System.err);</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\">         <span class=\"keyword\">throw</span> e;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">     <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>有两个关键判断逻辑: <code>declaringModule.isExported(pn, callerModule)</code>, <code>declaringModule.isOpen(pn, callerModule)</code></p>\n<p>阅读 <code>Module.java</code> 后发现有 <code>implAddExports</code> 方法, 通过 <code>IDEA</code> 查找调用引用发现了 <code>java.lang.System</code> 有访问此方法的 <code>JDK Internal API</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">setJavaLangAccess</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Allow privileged classes outside of java.lang</span></span><br><span class=\"line\">    SharedSecrets.setJavaLangAccess(<span class=\"keyword\">new</span> <span class=\"title class_\">JavaLangAccess</span>() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> Module <span class=\"title function_\">defineModule</span><span class=\"params\">(ClassLoader loader,</span></span><br><span class=\"line\"><span class=\"params\">                                   ModuleDescriptor descriptor,</span></span><br><span class=\"line\"><span class=\"params\">                                   URI uri)</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Module</span>(<span class=\"literal\">null</span>, loader, descriptor, uri);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> Module <span class=\"title function_\">defineUnnamedModule</span><span class=\"params\">(ClassLoader loader)</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Module</span>(loader);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addReads</span><span class=\"params\">(Module m1, Module m2)</span> &#123;</span><br><span class=\"line\">            m1.implAddReads(m2);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addReadsAllUnnamed</span><span class=\"params\">(Module m)</span> &#123;</span><br><span class=\"line\">            m.implAddReadsAllUnnamed();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addExports</span><span class=\"params\">(Module m, String pn, Module other)</span> &#123;</span><br><span class=\"line\">            m.implAddExports(pn, other);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addExportsToAllUnnamed</span><span class=\"params\">(Module m, String pn)</span> &#123;</span><br><span class=\"line\">            m.implAddExportsToAllUnnamed(pn);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addOpens</span><span class=\"params\">(Module m, String pn, Module other)</span> &#123;</span><br><span class=\"line\">            m.implAddOpens(pn, other);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addOpensToAllUnnamed</span><span class=\"params\">(Module m, String pn)</span> &#123;</span><br><span class=\"line\">            m.implAddOpensToAllUnnamed(pn);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addOpensToAllUnnamed</span><span class=\"params\">(Module m, Set&lt;String&gt; concealedPackages, Set&lt;String&gt; exportedPackages)</span> &#123;</span><br><span class=\"line\">            m.implAddOpensToAllUnnamed(concealedPackages, exportedPackages);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addUses</span><span class=\"params\">(Module m, Class&lt;?&gt; service)</span> &#123;</span><br><span class=\"line\">            m.implAddUses(service);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>找到了 JDK 提供的后门之后, 我们只需要调用 <code>SharedSecrets.getJavaLangAccess().addExports</code> 就能开后门了….<br>不对，目前还无法调用 <code>SharedSecrets</code>, 还需要一些手段….</p>\n<p>在 <code>java.lang.reflect</code> 中翻到了一个特别的东西, <code>java.lang.reflect.Proxy</code>, 她是破局的关键中心</p>\n<p>抱着好奇的心里, 我尝试了使用 <code>Proxy</code> 实现 <code>jdk.internal.access</code> 中的一个接口玩玩</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">    <span class=\"type\">var</span> <span class=\"variable\">obj</span> <span class=\"operator\">=</span> Proxy.newProxyInstance(</span><br><span class=\"line\">            Usffsa.class.getClassLoader(),</span><br><span class=\"line\">            <span class=\"keyword\">new</span> <span class=\"title class_\">Class</span>[]&#123;Class.forName(<span class=\"string\">&quot;jdk.internal.access.JavaLangAccess&quot;</span>)&#125;,</span><br><span class=\"line\">            <span class=\"keyword\">new</span> <span class=\"title class_\">InvocationHandler</span>() &#123;</span><br><span class=\"line\">                <span class=\"meta\">@Override</span></span><br><span class=\"line\">                <span class=\"keyword\">public</span> Object <span class=\"title function_\">invoke</span><span class=\"params\">(Object proxy, Method method, Object[] args)</span> <span class=\"keyword\">throws</span> Throwable &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    );</span><br><span class=\"line\">    System.out.println(obj);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>没想到, 运行成功了(eg: 没有对应权限(<code>Exported</code>)是不能实现对应接口的), 迎接着激动的心情, 输出了更多的详细信息</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">System.out.println(obj);</span><br><span class=\"line\">System.out.println(obj.getClass());</span><br><span class=\"line\">System.out.println(obj.getClass().getModule());</span><br><span class=\"line\">System.out.println(Object.class.getModule().isExported(<span class=\"string\">&quot;jdk.internal.access&quot;</span>, obj.getClass().getModule()));</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">null</span><br><span class=\"line\">class com.sun.proxy.jdk.proxy1.$Proxy0</span><br><span class=\"line\">module jdk.proxy1</span><br><span class=\"line\">true</span><br></pre></td></tr></table></figure>\n\n<p>破局点找到了, <code>java.lang.reflect.Proxy</code> 拥有打开模块访问的权利, 然后尝试对该模块进行注入</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">    <span class=\"type\">var</span> <span class=\"variable\">ccl</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ClassLoader</span>(Usffsa.class.getClassLoader()) &#123;</span><br><span class=\"line\">        Class&lt;?&gt; defineClass(<span class=\"type\">byte</span>[] code) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> defineClass(<span class=\"literal\">null</span>, code, <span class=\"number\">0</span>, code.length);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    <span class=\"type\">var</span> <span class=\"variable\">obj</span> <span class=\"operator\">=</span> Proxy.newProxyInstance(</span><br><span class=\"line\">            ccl,</span><br><span class=\"line\">            <span class=\"keyword\">new</span> <span class=\"title class_\">Class</span>[]&#123;Class.forName(<span class=\"string\">&quot;jdk.internal.access.JavaLangAccess&quot;</span>)&#125;,</span><br><span class=\"line\">            (proxy, method, args1) -&gt; <span class=\"literal\">null</span></span><br><span class=\"line\">    );</span><br><span class=\"line\">    <span class=\"type\">var</span> <span class=\"variable\">writer</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ClassWriter</span>(<span class=\"number\">0</span>); <span class=\"comment\">// org.objectweb.asm.ClassWriter</span></span><br><span class=\"line\">    writer.visit(Opcodes.V1_8, <span class=\"number\">0</span>,</span><br><span class=\"line\">            obj.getClass().getPackageName().replace(<span class=\"string\">&#x27;.&#x27;</span>, <span class=\"string\">&#x27;/&#x27;</span>) + <span class=\"string\">&quot;/Test0&quot;</span>,</span><br><span class=\"line\">            <span class=\"literal\">null</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;java/lang/Object&quot;</span>,</span><br><span class=\"line\">            <span class=\"literal\">null</span></span><br><span class=\"line\">    );</span><br><span class=\"line\">    <span class=\"type\">var</span> <span class=\"variable\">injectedClass</span> <span class=\"operator\">=</span> ccl.defineClass(writer.toByteArray());</span><br><span class=\"line\">    System.out.println(<span class=\"string\">&quot;Proxy     Module  : &quot;</span> + obj.getClass().getModule());</span><br><span class=\"line\">    System.out.println(<span class=\"string\">&quot;Injected  Module  : &quot;</span> + injectedClass.getModule());</span><br><span class=\"line\">    System.out.println(<span class=\"string\">&quot;Is Same Module    : &quot;</span> + (injectedClass.getModule() == obj.getClass().getModule()));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Proxy     Module  : module jdk.proxy1</span><br><span class=\"line\">Injected  Module  : module jdk.proxy1</span><br><span class=\"line\">Is Same Module    : true</span><br></pre></td></tr></table></figure>\n\n<p>至此已经破开了 JVM 的模块限制的死局, 实际应用可参考 <a href=\"https://github.com/Karlatemp/UnsafeAccessor\">[Karlatemp&#x2F;UnsafeAccessor]</a></p>\n"},{"title":"使用 jdk.foreign 访问本机代码","date":"2022-03-12T12:54:00.000Z","_content":"\n{% note blue %}\n\n`jdk.foreign` 与 `JDK 16` 开始可用, 并处于<span style=\"color:red\">**测试**</span>状态.\n\n代码在\n`Windows 10 Enterprise; 1909 (OS Build 18363.1679)`\n`openjdk 17 2021-09-14; 64-Bit Server VM (build 17+35-2724, mixed mode, sharing)`\n下测试通过\n\n{% endnote %}\n\n## Environment prepare\n\n开始一切之前, 需要准备好所有的一切东西\n\n- Java IDE\n- JDK 16+\n- C/CPP IDE (Optional)\n\n### Project initiation\n\n首先，新建文件夹, ~~然后点击 Win, 点击关机~~, 使用 Java IDE 打开该文件夹.\n\n创建以下文件\n\n```properties \n## gradle/wrapper/gradle-wrapper.properties\ndistributionBase=GRADLE_USER_HOME\ndistributionPath=wrapper/dists\ndistributionUrl=https\\://services.gradle.org/distributions/gradle-7.3.3-all.zip\nzipStoreBase=GRADLE_USER_HOME\nzipStorePath=wrapper/dists\n```\n\n```groovy\n// settings.gradle\n// <Empty file>\n```\n\n```groovy\n// build.gradle\nplugins {\n    id 'java'\n    id 'java-plugin'\n}\nrepositories {\n    mavenCentral()\n}\ndependencies {}\ncompileJava {\n    options.compilerArgs += ['--add-modules', 'ALL-SYSTEM']\n}\n```\n\n```java\n// src/main/java/pkg/Boot.java\npackage pkg;\npublic class Boot {\n    public static void main(String[] $$$$$$$$$$$$$$$$) throws Throwable {\n    }\n}\n```\n\n进入 `Project Structure > Project` 将 `Project SDK` 切换至 `JDK 16+`\n右键 `build.gradle` 导入 gradle 项目, 等待导入完成后\n右键 `pkg.Boot` 的入口点, 添加 jvm 参数 `--add-modules ALL-SYSTEM --enable-native-access ALL-UNNAMED`\n\n\n## Code\n\n根据 [JEP 419: Foreign Function & Memory API](https://openjdk.java.net/jeps/419) 的 Example, 可以很快写出看上去可以运行的代码.\n使用 `jdk.foreign` 调用本机代码的步骤共三步, `本机方法寻址`, `方法签名拼接`, `执行`.\n\n### Setup\n\n第一步需要先获得相关的 api 对象, 以供我们完成桥接.\n\n```java\nvar linker = CLinker.getInstance();\nvar symbolLookup = SymbolLookup.loaderLookup();\nvar systemLookup = CLinker.systemLookup();\n```\n\n### Native function symbol lookup\n\n需要先拿到方法地址 (指针), 才能执行本机方法, JDK 提供了搜索方法符号的 api.\n\n{% note yellow %}\n寻址时需要的是实际名字, 而不是在 `****.h` 中使用 `#define` 定义的别名 (比如 `SetWindowLong` 实际应该为 `SetWindowLongA`)\n{% endnote %}\n\n```java\nvar system =\n        systemLookup.lookup(\"system\")\n        .or(() -> symbolLookup.lookup(\"system\"))\n        .orElseThrow();\nSystem.out.println(system);\n```\n\n### Function description mapping.\n\n只有正确告诉 JVM 我们要执行的方法的签名是什么样的, JVM 才能正确处理相关的访问, 否则 `JVM Crashed`.\n\n{% note blue %}\n如无必要，切勿直接使用 MemoryLayout 中的定义\n{% endnote %}\n\n```java\n// _DCRTIMP int __cdecl system(_In_opt_z_ char const* _Command)\nvar funcDesc = FunctionDescriptor.of(\n    /* return */ CLinker.C_INT,\n    /* argv...*/ CLinker.C_POINTER\n);\nvar mh = linker.downcallHandle(\n    // Java 眼中的方法签名\n    MethodType.methodType(\n        int.class, MemoryAddress.class\n    ),\n    funcDesc\n);\nSystem.out.println(mh); // MethodHandle(Addressable, MemoryAddress)int\n                        //              |              `- 方法参数 ( char const* _Command )\n                        //              |- 此参数为本机方法指针\n```\n\n### Invoke native function\n\n`system` 方法需要一个指针 (char*), 由于 jdk 不允许直接获得一个方法对象的指针, 所以需要将相关内容拷贝到堆外内存.\n\n其中 `jdk.foreign` 提供了 `ResourceScope` 防止内存泄露.\n\n```java\ntry (var scope = ResourceScope.newConfinedScope()) {\n    var allocator = SegmentAllocator.ofScope(scope);\n    var cmd_java = \"whoami\".getBytes(StandardCharsets.UTF_8); // 如果有中文, 可能不是 utf8\n    var cmd_cnative = allocator.allocate(cmd_java.length + 1);\n    cmd_cnative.copyFrom(MemorySegment.ofArray(cmd_java));\n    MemoryAccess.setByAtOffset(cmd_cnative, cmd_java.length, (byte) 0 /* \\x00 */);\n\n    var $ = (int) mh.invokeExact((Addressable) system, cmd_cnative.address());\n    System.out.println($);\n}\n```\n\n### Full code\n\n```java\npackage pkg;\n\nimport jdk.incubator.foreign.*;\n\nimport java.lang.invoke.MethodType;\nimport java.nio.charset.StandardCharsets;\n\npublic class Boot {\n    public static void main(String[] args) throws Throwable {\n        var linker = CLinker.getInstance();\n        var symbolLookup = SymbolLookup.loaderLookup();\n        var systemLookup = CLinker.systemLookup();\n        var system = systemLookup\n                .lookup(\"system\")\n                .or(() -> symbolLookup.lookup(\"system\"))\n                .orElseThrow();\n        System.out.println(system);\n        // _DCRTIMP int __cdecl system(_In_opt_z_ char const* _Command)\n        var funcDesc = FunctionDescriptor.of(\n                CLinker.C_INT,\n                CLinker.C_POINTER\n        );\n        var mh = linker.downcallHandle(MethodType.methodType(\n                int.class, MemoryAddress.class\n        ), funcDesc);\n        System.out.println(mh);\n        try (var scope = ResourceScope.newConfinedScope()) {\n            var allocator = SegmentAllocator.ofScope(scope);\n            var cmd_java = \"whoami\".getBytes(StandardCharsets.UTF_8);\n            var cmd_cnative = allocator.allocate(cmd_java.length + 1);\n            cmd_cnative.copyFrom(MemorySegment.ofArray(cmd_java));\n            MemoryAccess.setByteAtOffset(cmd_cnative, cmd_java.length, (byte) 0 /* \\u0000 */);\n\n            var $ = (int) mh.invokeExact((Addressable) system, cmd_cnative.address());\n            System.out.println($);\n        }\n    }\n}\n\n```\n","source":"_posts/jvm/jdk-foreign.md","raw":"---\ntitle: 使用 jdk.foreign 访问本机代码\ntags: [jvm, jdk.foreign]\ncategories: [jvm]\ndate: 2022-3-12 20:54:00\n---\n\n{% note blue %}\n\n`jdk.foreign` 与 `JDK 16` 开始可用, 并处于<span style=\"color:red\">**测试**</span>状态.\n\n代码在\n`Windows 10 Enterprise; 1909 (OS Build 18363.1679)`\n`openjdk 17 2021-09-14; 64-Bit Server VM (build 17+35-2724, mixed mode, sharing)`\n下测试通过\n\n{% endnote %}\n\n## Environment prepare\n\n开始一切之前, 需要准备好所有的一切东西\n\n- Java IDE\n- JDK 16+\n- C/CPP IDE (Optional)\n\n### Project initiation\n\n首先，新建文件夹, ~~然后点击 Win, 点击关机~~, 使用 Java IDE 打开该文件夹.\n\n创建以下文件\n\n```properties \n## gradle/wrapper/gradle-wrapper.properties\ndistributionBase=GRADLE_USER_HOME\ndistributionPath=wrapper/dists\ndistributionUrl=https\\://services.gradle.org/distributions/gradle-7.3.3-all.zip\nzipStoreBase=GRADLE_USER_HOME\nzipStorePath=wrapper/dists\n```\n\n```groovy\n// settings.gradle\n// <Empty file>\n```\n\n```groovy\n// build.gradle\nplugins {\n    id 'java'\n    id 'java-plugin'\n}\nrepositories {\n    mavenCentral()\n}\ndependencies {}\ncompileJava {\n    options.compilerArgs += ['--add-modules', 'ALL-SYSTEM']\n}\n```\n\n```java\n// src/main/java/pkg/Boot.java\npackage pkg;\npublic class Boot {\n    public static void main(String[] $$$$$$$$$$$$$$$$) throws Throwable {\n    }\n}\n```\n\n进入 `Project Structure > Project` 将 `Project SDK` 切换至 `JDK 16+`\n右键 `build.gradle` 导入 gradle 项目, 等待导入完成后\n右键 `pkg.Boot` 的入口点, 添加 jvm 参数 `--add-modules ALL-SYSTEM --enable-native-access ALL-UNNAMED`\n\n\n## Code\n\n根据 [JEP 419: Foreign Function & Memory API](https://openjdk.java.net/jeps/419) 的 Example, 可以很快写出看上去可以运行的代码.\n使用 `jdk.foreign` 调用本机代码的步骤共三步, `本机方法寻址`, `方法签名拼接`, `执行`.\n\n### Setup\n\n第一步需要先获得相关的 api 对象, 以供我们完成桥接.\n\n```java\nvar linker = CLinker.getInstance();\nvar symbolLookup = SymbolLookup.loaderLookup();\nvar systemLookup = CLinker.systemLookup();\n```\n\n### Native function symbol lookup\n\n需要先拿到方法地址 (指针), 才能执行本机方法, JDK 提供了搜索方法符号的 api.\n\n{% note yellow %}\n寻址时需要的是实际名字, 而不是在 `****.h` 中使用 `#define` 定义的别名 (比如 `SetWindowLong` 实际应该为 `SetWindowLongA`)\n{% endnote %}\n\n```java\nvar system =\n        systemLookup.lookup(\"system\")\n        .or(() -> symbolLookup.lookup(\"system\"))\n        .orElseThrow();\nSystem.out.println(system);\n```\n\n### Function description mapping.\n\n只有正确告诉 JVM 我们要执行的方法的签名是什么样的, JVM 才能正确处理相关的访问, 否则 `JVM Crashed`.\n\n{% note blue %}\n如无必要，切勿直接使用 MemoryLayout 中的定义\n{% endnote %}\n\n```java\n// _DCRTIMP int __cdecl system(_In_opt_z_ char const* _Command)\nvar funcDesc = FunctionDescriptor.of(\n    /* return */ CLinker.C_INT,\n    /* argv...*/ CLinker.C_POINTER\n);\nvar mh = linker.downcallHandle(\n    // Java 眼中的方法签名\n    MethodType.methodType(\n        int.class, MemoryAddress.class\n    ),\n    funcDesc\n);\nSystem.out.println(mh); // MethodHandle(Addressable, MemoryAddress)int\n                        //              |              `- 方法参数 ( char const* _Command )\n                        //              |- 此参数为本机方法指针\n```\n\n### Invoke native function\n\n`system` 方法需要一个指针 (char*), 由于 jdk 不允许直接获得一个方法对象的指针, 所以需要将相关内容拷贝到堆外内存.\n\n其中 `jdk.foreign` 提供了 `ResourceScope` 防止内存泄露.\n\n```java\ntry (var scope = ResourceScope.newConfinedScope()) {\n    var allocator = SegmentAllocator.ofScope(scope);\n    var cmd_java = \"whoami\".getBytes(StandardCharsets.UTF_8); // 如果有中文, 可能不是 utf8\n    var cmd_cnative = allocator.allocate(cmd_java.length + 1);\n    cmd_cnative.copyFrom(MemorySegment.ofArray(cmd_java));\n    MemoryAccess.setByAtOffset(cmd_cnative, cmd_java.length, (byte) 0 /* \\x00 */);\n\n    var $ = (int) mh.invokeExact((Addressable) system, cmd_cnative.address());\n    System.out.println($);\n}\n```\n\n### Full code\n\n```java\npackage pkg;\n\nimport jdk.incubator.foreign.*;\n\nimport java.lang.invoke.MethodType;\nimport java.nio.charset.StandardCharsets;\n\npublic class Boot {\n    public static void main(String[] args) throws Throwable {\n        var linker = CLinker.getInstance();\n        var symbolLookup = SymbolLookup.loaderLookup();\n        var systemLookup = CLinker.systemLookup();\n        var system = systemLookup\n                .lookup(\"system\")\n                .or(() -> symbolLookup.lookup(\"system\"))\n                .orElseThrow();\n        System.out.println(system);\n        // _DCRTIMP int __cdecl system(_In_opt_z_ char const* _Command)\n        var funcDesc = FunctionDescriptor.of(\n                CLinker.C_INT,\n                CLinker.C_POINTER\n        );\n        var mh = linker.downcallHandle(MethodType.methodType(\n                int.class, MemoryAddress.class\n        ), funcDesc);\n        System.out.println(mh);\n        try (var scope = ResourceScope.newConfinedScope()) {\n            var allocator = SegmentAllocator.ofScope(scope);\n            var cmd_java = \"whoami\".getBytes(StandardCharsets.UTF_8);\n            var cmd_cnative = allocator.allocate(cmd_java.length + 1);\n            cmd_cnative.copyFrom(MemorySegment.ofArray(cmd_java));\n            MemoryAccess.setByteAtOffset(cmd_cnative, cmd_java.length, (byte) 0 /* \\u0000 */);\n\n            var $ = (int) mh.invokeExact((Addressable) system, cmd_cnative.address());\n            System.out.println($);\n        }\n    }\n}\n\n```\n","slug":"jvm/jdk-foreign","published":1,"updated":"2022-03-12T13:52:41.943Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl0nwr8hv0000a8oq3i3ueqk2","content":"<div class=\"note blue flat\"><p><code>jdk.foreign</code> 与 <code>JDK 16</code> 开始可用, 并处于<span style=\"color:red\"><strong>测试</strong></span>状态.</p>\n<p>代码在<br><code>Windows 10 Enterprise; 1909 (OS Build 18363.1679)</code><br><code>openjdk 17 2021-09-14; 64-Bit Server VM (build 17+35-2724, mixed mode, sharing)</code><br>下测试通过</p>\n</div>\n\n<h2 id=\"Environment-prepare\"><a href=\"#Environment-prepare\" class=\"headerlink\" title=\"Environment prepare\"></a>Environment prepare</h2><p>开始一切之前, 需要准备好所有的一切东西</p>\n<ul>\n<li>Java IDE</li>\n<li>JDK 16+</li>\n<li>C&#x2F;CPP IDE (Optional)</li>\n</ul>\n<h3 id=\"Project-initiation\"><a href=\"#Project-initiation\" class=\"headerlink\" title=\"Project initiation\"></a>Project initiation</h3><p>首先，新建文件夹, <del>然后点击 Win, 点击关机</del>, 使用 Java IDE 打开该文件夹.</p>\n<p>创建以下文件</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## gradle/wrapper/gradle-wrapper.properties</span></span><br><span class=\"line\"><span class=\"attr\">distributionBase</span>=<span class=\"string\">GRADLE_USER_HOME</span></span><br><span class=\"line\"><span class=\"attr\">distributionPath</span>=<span class=\"string\">wrapper/dists</span></span><br><span class=\"line\"><span class=\"attr\">distributionUrl</span>=<span class=\"string\">https\\://services.gradle.org/distributions/gradle-7.3.3-all.zip</span></span><br><span class=\"line\"><span class=\"attr\">zipStoreBase</span>=<span class=\"string\">GRADLE_USER_HOME</span></span><br><span class=\"line\"><span class=\"attr\">zipStorePath</span>=<span class=\"string\">wrapper/dists</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// settings.gradle</span></span><br><span class=\"line\"><span class=\"comment\">// &lt;Empty file&gt;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// build.gradle</span></span><br><span class=\"line\">plugins &#123;</span><br><span class=\"line\">    id <span class=\"string\">&#x27;java&#x27;</span></span><br><span class=\"line\">    id <span class=\"string\">&#x27;java-plugin&#x27;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">repositories &#123;</span><br><span class=\"line\">    mavenCentral()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">dependencies &#123;&#125;</span><br><span class=\"line\">compileJava &#123;</span><br><span class=\"line\">    options.compilerArgs += [<span class=\"string\">&#x27;--add-modules&#x27;</span>, <span class=\"string\">&#x27;ALL-SYSTEM&#x27;</span>]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// src/main/java/pkg/Boot.java</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> pkg;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Boot</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] $$$$$$$$$$$$$$$$)</span> <span class=\"keyword\">throws</span> Throwable &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>进入 <code>Project Structure &gt; Project</code> 将 <code>Project SDK</code> 切换至 <code>JDK 16+</code><br>右键 <code>build.gradle</code> 导入 gradle 项目, 等待导入完成后<br>右键 <code>pkg.Boot</code> 的入口点, 添加 jvm 参数 <code>--add-modules ALL-SYSTEM --enable-native-access ALL-UNNAMED</code></p>\n<h2 id=\"Code\"><a href=\"#Code\" class=\"headerlink\" title=\"Code\"></a>Code</h2><p>根据 <a href=\"https://openjdk.java.net/jeps/419\">JEP 419: Foreign Function &amp; Memory API</a> 的 Example, 可以很快写出看上去可以运行的代码.<br>使用 <code>jdk.foreign</code> 调用本机代码的步骤共三步, <code>本机方法寻址</code>, <code>方法签名拼接</code>, <code>执行</code>.</p>\n<h3 id=\"Setup\"><a href=\"#Setup\" class=\"headerlink\" title=\"Setup\"></a>Setup</h3><p>第一步需要先获得相关的 api 对象, 以供我们完成桥接.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">linker</span> <span class=\"operator\">=</span> CLinker.getInstance();</span><br><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">symbolLookup</span> <span class=\"operator\">=</span> SymbolLookup.loaderLookup();</span><br><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">systemLookup</span> <span class=\"operator\">=</span> CLinker.systemLookup();</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Native-function-symbol-lookup\"><a href=\"#Native-function-symbol-lookup\" class=\"headerlink\" title=\"Native function symbol lookup\"></a>Native function symbol lookup</h3><p>需要先拿到方法地址 (指针), 才能执行本机方法, JDK 提供了搜索方法符号的 api.</p>\n<div class=\"note yellow flat\"><p>寻址时需要的是实际名字, 而不是在 <code>****.h</code> 中使用 <code>#define</code> 定义的别名 (比如 <code>SetWindowLong</code> 实际应该为 <code>SetWindowLongA</code>)</p>\n</div>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">system</span> <span class=\"operator\">=</span></span><br><span class=\"line\">        systemLookup.lookup(<span class=\"string\">&quot;system&quot;</span>)</span><br><span class=\"line\">        .or(() -&gt; symbolLookup.lookup(<span class=\"string\">&quot;system&quot;</span>))</span><br><span class=\"line\">        .orElseThrow();</span><br><span class=\"line\">System.out.println(system);</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Function-description-mapping\"><a href=\"#Function-description-mapping\" class=\"headerlink\" title=\"Function description mapping.\"></a>Function description mapping.</h3><p>只有正确告诉 JVM 我们要执行的方法的签名是什么样的, JVM 才能正确处理相关的访问, 否则 <code>JVM Crashed</code>.</p>\n<div class=\"note blue flat\"><p>如无必要，切勿直接使用 MemoryLayout 中的定义</p>\n</div>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// _DCRTIMP int __cdecl system(_In_opt_z_ char const* _Command)</span></span><br><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">funcDesc</span> <span class=\"operator\">=</span> FunctionDescriptor.of(</span><br><span class=\"line\">    <span class=\"comment\">/* return */</span> CLinker.C_INT,</span><br><span class=\"line\">    <span class=\"comment\">/* argv...*/</span> CLinker.C_POINTER</span><br><span class=\"line\">);</span><br><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">mh</span> <span class=\"operator\">=</span> linker.downcallHandle(</span><br><span class=\"line\">    <span class=\"comment\">// Java 眼中的方法签名</span></span><br><span class=\"line\">    MethodType.methodType(</span><br><span class=\"line\">        <span class=\"type\">int</span>.class, MemoryAddress.class</span><br><span class=\"line\">    ),</span><br><span class=\"line\">    funcDesc</span><br><span class=\"line\">);</span><br><span class=\"line\">System.out.println(mh); <span class=\"comment\">// MethodHandle(Addressable, MemoryAddress)int</span></span><br><span class=\"line\">                        <span class=\"comment\">//              |              `- 方法参数 ( char const* _Command )</span></span><br><span class=\"line\">                        <span class=\"comment\">//              |- 此参数为本机方法指针</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Invoke-native-function\"><a href=\"#Invoke-native-function\" class=\"headerlink\" title=\"Invoke native function\"></a>Invoke native function</h3><p><code>system</code> 方法需要一个指针 (char*), 由于 jdk 不允许直接获得一个方法对象的指针, 所以需要将相关内容拷贝到堆外内存.</p>\n<p>其中 <code>jdk.foreign</code> 提供了 <code>ResourceScope</code> 防止内存泄露.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">try</span> (<span class=\"type\">var</span> <span class=\"variable\">scope</span> <span class=\"operator\">=</span> ResourceScope.newConfinedScope()) &#123;</span><br><span class=\"line\">    <span class=\"type\">var</span> <span class=\"variable\">allocator</span> <span class=\"operator\">=</span> SegmentAllocator.ofScope(scope);</span><br><span class=\"line\">    <span class=\"type\">var</span> <span class=\"variable\">cmd_java</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;whoami&quot;</span>.getBytes(StandardCharsets.UTF_8); <span class=\"comment\">// 如果有中文, 可能不是 utf8</span></span><br><span class=\"line\">    <span class=\"type\">var</span> <span class=\"variable\">cmd_cnative</span> <span class=\"operator\">=</span> allocator.allocate(cmd_java.length + <span class=\"number\">1</span>);</span><br><span class=\"line\">    cmd_cnative.copyFrom(MemorySegment.ofArray(cmd_java));</span><br><span class=\"line\">    MemoryAccess.setByAtOffset(cmd_cnative, cmd_java.length, (<span class=\"type\">byte</span>) <span class=\"number\">0</span> <span class=\"comment\">/* \\x00 */</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">var</span> <span class=\"variable\">$</span> <span class=\"operator\">=</span> (<span class=\"type\">int</span>) mh.invokeExact((Addressable) system, cmd_cnative.address());</span><br><span class=\"line\">    System.out.println($);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Full-code\"><a href=\"#Full-code\" class=\"headerlink\" title=\"Full code\"></a>Full code</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> pkg;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> jdk.incubator.foreign.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.invoke.MethodType;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.charset.StandardCharsets;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Boot</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Throwable &#123;</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">linker</span> <span class=\"operator\">=</span> CLinker.getInstance();</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">symbolLookup</span> <span class=\"operator\">=</span> SymbolLookup.loaderLookup();</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">systemLookup</span> <span class=\"operator\">=</span> CLinker.systemLookup();</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">system</span> <span class=\"operator\">=</span> systemLookup</span><br><span class=\"line\">                .lookup(<span class=\"string\">&quot;system&quot;</span>)</span><br><span class=\"line\">                .or(() -&gt; symbolLookup.lookup(<span class=\"string\">&quot;system&quot;</span>))</span><br><span class=\"line\">                .orElseThrow();</span><br><span class=\"line\">        System.out.println(system);</span><br><span class=\"line\">        <span class=\"comment\">// _DCRTIMP int __cdecl system(_In_opt_z_ char const* _Command)</span></span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">funcDesc</span> <span class=\"operator\">=</span> FunctionDescriptor.of(</span><br><span class=\"line\">                CLinker.C_INT,</span><br><span class=\"line\">                CLinker.C_POINTER</span><br><span class=\"line\">        );</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">mh</span> <span class=\"operator\">=</span> linker.downcallHandle(MethodType.methodType(</span><br><span class=\"line\">                <span class=\"type\">int</span>.class, MemoryAddress.class</span><br><span class=\"line\">        ), funcDesc);</span><br><span class=\"line\">        System.out.println(mh);</span><br><span class=\"line\">        <span class=\"keyword\">try</span> (<span class=\"type\">var</span> <span class=\"variable\">scope</span> <span class=\"operator\">=</span> ResourceScope.newConfinedScope()) &#123;</span><br><span class=\"line\">            <span class=\"type\">var</span> <span class=\"variable\">allocator</span> <span class=\"operator\">=</span> SegmentAllocator.ofScope(scope);</span><br><span class=\"line\">            <span class=\"type\">var</span> <span class=\"variable\">cmd_java</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;whoami&quot;</span>.getBytes(StandardCharsets.UTF_8);</span><br><span class=\"line\">            <span class=\"type\">var</span> <span class=\"variable\">cmd_cnative</span> <span class=\"operator\">=</span> allocator.allocate(cmd_java.length + <span class=\"number\">1</span>);</span><br><span class=\"line\">            cmd_cnative.copyFrom(MemorySegment.ofArray(cmd_java));</span><br><span class=\"line\">            MemoryAccess.setByteAtOffset(cmd_cnative, cmd_java.length, (<span class=\"type\">byte</span>) <span class=\"number\">0</span> <span class=\"comment\">/* \\u0000 */</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"type\">var</span> <span class=\"variable\">$</span> <span class=\"operator\">=</span> (<span class=\"type\">int</span>) mh.invokeExact((Addressable) system, cmd_cnative.address());</span><br><span class=\"line\">            System.out.println($);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n","site":{"data":{"link":[{"class_name":"友情链接","class_desc":"友情链接","link_list":[{"name":"暂无","link":"","avatar":"","descr":"暂无"}]}]}},"cover":"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7","excerpt":"","more":"<div class=\"note blue flat\"><p><code>jdk.foreign</code> 与 <code>JDK 16</code> 开始可用, 并处于<span style=\"color:red\"><strong>测试</strong></span>状态.</p>\n<p>代码在<br><code>Windows 10 Enterprise; 1909 (OS Build 18363.1679)</code><br><code>openjdk 17 2021-09-14; 64-Bit Server VM (build 17+35-2724, mixed mode, sharing)</code><br>下测试通过</p>\n</div>\n\n<h2 id=\"Environment-prepare\"><a href=\"#Environment-prepare\" class=\"headerlink\" title=\"Environment prepare\"></a>Environment prepare</h2><p>开始一切之前, 需要准备好所有的一切东西</p>\n<ul>\n<li>Java IDE</li>\n<li>JDK 16+</li>\n<li>C&#x2F;CPP IDE (Optional)</li>\n</ul>\n<h3 id=\"Project-initiation\"><a href=\"#Project-initiation\" class=\"headerlink\" title=\"Project initiation\"></a>Project initiation</h3><p>首先，新建文件夹, <del>然后点击 Win, 点击关机</del>, 使用 Java IDE 打开该文件夹.</p>\n<p>创建以下文件</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## gradle/wrapper/gradle-wrapper.properties</span></span><br><span class=\"line\"><span class=\"attr\">distributionBase</span>=<span class=\"string\">GRADLE_USER_HOME</span></span><br><span class=\"line\"><span class=\"attr\">distributionPath</span>=<span class=\"string\">wrapper/dists</span></span><br><span class=\"line\"><span class=\"attr\">distributionUrl</span>=<span class=\"string\">https\\://services.gradle.org/distributions/gradle-7.3.3-all.zip</span></span><br><span class=\"line\"><span class=\"attr\">zipStoreBase</span>=<span class=\"string\">GRADLE_USER_HOME</span></span><br><span class=\"line\"><span class=\"attr\">zipStorePath</span>=<span class=\"string\">wrapper/dists</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// settings.gradle</span></span><br><span class=\"line\"><span class=\"comment\">// &lt;Empty file&gt;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// build.gradle</span></span><br><span class=\"line\">plugins &#123;</span><br><span class=\"line\">    id <span class=\"string\">&#x27;java&#x27;</span></span><br><span class=\"line\">    id <span class=\"string\">&#x27;java-plugin&#x27;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">repositories &#123;</span><br><span class=\"line\">    mavenCentral()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">dependencies &#123;&#125;</span><br><span class=\"line\">compileJava &#123;</span><br><span class=\"line\">    options.compilerArgs += [<span class=\"string\">&#x27;--add-modules&#x27;</span>, <span class=\"string\">&#x27;ALL-SYSTEM&#x27;</span>]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// src/main/java/pkg/Boot.java</span></span><br><span class=\"line\"><span class=\"keyword\">package</span> pkg;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Boot</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] $$$$$$$$$$$$$$$$)</span> <span class=\"keyword\">throws</span> Throwable &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>进入 <code>Project Structure &gt; Project</code> 将 <code>Project SDK</code> 切换至 <code>JDK 16+</code><br>右键 <code>build.gradle</code> 导入 gradle 项目, 等待导入完成后<br>右键 <code>pkg.Boot</code> 的入口点, 添加 jvm 参数 <code>--add-modules ALL-SYSTEM --enable-native-access ALL-UNNAMED</code></p>\n<h2 id=\"Code\"><a href=\"#Code\" class=\"headerlink\" title=\"Code\"></a>Code</h2><p>根据 <a href=\"https://openjdk.java.net/jeps/419\">JEP 419: Foreign Function &amp; Memory API</a> 的 Example, 可以很快写出看上去可以运行的代码.<br>使用 <code>jdk.foreign</code> 调用本机代码的步骤共三步, <code>本机方法寻址</code>, <code>方法签名拼接</code>, <code>执行</code>.</p>\n<h3 id=\"Setup\"><a href=\"#Setup\" class=\"headerlink\" title=\"Setup\"></a>Setup</h3><p>第一步需要先获得相关的 api 对象, 以供我们完成桥接.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">linker</span> <span class=\"operator\">=</span> CLinker.getInstance();</span><br><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">symbolLookup</span> <span class=\"operator\">=</span> SymbolLookup.loaderLookup();</span><br><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">systemLookup</span> <span class=\"operator\">=</span> CLinker.systemLookup();</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Native-function-symbol-lookup\"><a href=\"#Native-function-symbol-lookup\" class=\"headerlink\" title=\"Native function symbol lookup\"></a>Native function symbol lookup</h3><p>需要先拿到方法地址 (指针), 才能执行本机方法, JDK 提供了搜索方法符号的 api.</p>\n<div class=\"note yellow flat\"><p>寻址时需要的是实际名字, 而不是在 <code>****.h</code> 中使用 <code>#define</code> 定义的别名 (比如 <code>SetWindowLong</code> 实际应该为 <code>SetWindowLongA</code>)</p>\n</div>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">system</span> <span class=\"operator\">=</span></span><br><span class=\"line\">        systemLookup.lookup(<span class=\"string\">&quot;system&quot;</span>)</span><br><span class=\"line\">        .or(() -&gt; symbolLookup.lookup(<span class=\"string\">&quot;system&quot;</span>))</span><br><span class=\"line\">        .orElseThrow();</span><br><span class=\"line\">System.out.println(system);</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Function-description-mapping\"><a href=\"#Function-description-mapping\" class=\"headerlink\" title=\"Function description mapping.\"></a>Function description mapping.</h3><p>只有正确告诉 JVM 我们要执行的方法的签名是什么样的, JVM 才能正确处理相关的访问, 否则 <code>JVM Crashed</code>.</p>\n<div class=\"note blue flat\"><p>如无必要，切勿直接使用 MemoryLayout 中的定义</p>\n</div>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// _DCRTIMP int __cdecl system(_In_opt_z_ char const* _Command)</span></span><br><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">funcDesc</span> <span class=\"operator\">=</span> FunctionDescriptor.of(</span><br><span class=\"line\">    <span class=\"comment\">/* return */</span> CLinker.C_INT,</span><br><span class=\"line\">    <span class=\"comment\">/* argv...*/</span> CLinker.C_POINTER</span><br><span class=\"line\">);</span><br><span class=\"line\"><span class=\"type\">var</span> <span class=\"variable\">mh</span> <span class=\"operator\">=</span> linker.downcallHandle(</span><br><span class=\"line\">    <span class=\"comment\">// Java 眼中的方法签名</span></span><br><span class=\"line\">    MethodType.methodType(</span><br><span class=\"line\">        <span class=\"type\">int</span>.class, MemoryAddress.class</span><br><span class=\"line\">    ),</span><br><span class=\"line\">    funcDesc</span><br><span class=\"line\">);</span><br><span class=\"line\">System.out.println(mh); <span class=\"comment\">// MethodHandle(Addressable, MemoryAddress)int</span></span><br><span class=\"line\">                        <span class=\"comment\">//              |              `- 方法参数 ( char const* _Command )</span></span><br><span class=\"line\">                        <span class=\"comment\">//              |- 此参数为本机方法指针</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Invoke-native-function\"><a href=\"#Invoke-native-function\" class=\"headerlink\" title=\"Invoke native function\"></a>Invoke native function</h3><p><code>system</code> 方法需要一个指针 (char*), 由于 jdk 不允许直接获得一个方法对象的指针, 所以需要将相关内容拷贝到堆外内存.</p>\n<p>其中 <code>jdk.foreign</code> 提供了 <code>ResourceScope</code> 防止内存泄露.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">try</span> (<span class=\"type\">var</span> <span class=\"variable\">scope</span> <span class=\"operator\">=</span> ResourceScope.newConfinedScope()) &#123;</span><br><span class=\"line\">    <span class=\"type\">var</span> <span class=\"variable\">allocator</span> <span class=\"operator\">=</span> SegmentAllocator.ofScope(scope);</span><br><span class=\"line\">    <span class=\"type\">var</span> <span class=\"variable\">cmd_java</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;whoami&quot;</span>.getBytes(StandardCharsets.UTF_8); <span class=\"comment\">// 如果有中文, 可能不是 utf8</span></span><br><span class=\"line\">    <span class=\"type\">var</span> <span class=\"variable\">cmd_cnative</span> <span class=\"operator\">=</span> allocator.allocate(cmd_java.length + <span class=\"number\">1</span>);</span><br><span class=\"line\">    cmd_cnative.copyFrom(MemorySegment.ofArray(cmd_java));</span><br><span class=\"line\">    MemoryAccess.setByAtOffset(cmd_cnative, cmd_java.length, (<span class=\"type\">byte</span>) <span class=\"number\">0</span> <span class=\"comment\">/* \\x00 */</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"type\">var</span> <span class=\"variable\">$</span> <span class=\"operator\">=</span> (<span class=\"type\">int</span>) mh.invokeExact((Addressable) system, cmd_cnative.address());</span><br><span class=\"line\">    System.out.println($);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Full-code\"><a href=\"#Full-code\" class=\"headerlink\" title=\"Full code\"></a>Full code</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> pkg;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> jdk.incubator.foreign.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.invoke.MethodType;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.charset.StandardCharsets;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Boot</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Throwable &#123;</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">linker</span> <span class=\"operator\">=</span> CLinker.getInstance();</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">symbolLookup</span> <span class=\"operator\">=</span> SymbolLookup.loaderLookup();</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">systemLookup</span> <span class=\"operator\">=</span> CLinker.systemLookup();</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">system</span> <span class=\"operator\">=</span> systemLookup</span><br><span class=\"line\">                .lookup(<span class=\"string\">&quot;system&quot;</span>)</span><br><span class=\"line\">                .or(() -&gt; symbolLookup.lookup(<span class=\"string\">&quot;system&quot;</span>))</span><br><span class=\"line\">                .orElseThrow();</span><br><span class=\"line\">        System.out.println(system);</span><br><span class=\"line\">        <span class=\"comment\">// _DCRTIMP int __cdecl system(_In_opt_z_ char const* _Command)</span></span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">funcDesc</span> <span class=\"operator\">=</span> FunctionDescriptor.of(</span><br><span class=\"line\">                CLinker.C_INT,</span><br><span class=\"line\">                CLinker.C_POINTER</span><br><span class=\"line\">        );</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">mh</span> <span class=\"operator\">=</span> linker.downcallHandle(MethodType.methodType(</span><br><span class=\"line\">                <span class=\"type\">int</span>.class, MemoryAddress.class</span><br><span class=\"line\">        ), funcDesc);</span><br><span class=\"line\">        System.out.println(mh);</span><br><span class=\"line\">        <span class=\"keyword\">try</span> (<span class=\"type\">var</span> <span class=\"variable\">scope</span> <span class=\"operator\">=</span> ResourceScope.newConfinedScope()) &#123;</span><br><span class=\"line\">            <span class=\"type\">var</span> <span class=\"variable\">allocator</span> <span class=\"operator\">=</span> SegmentAllocator.ofScope(scope);</span><br><span class=\"line\">            <span class=\"type\">var</span> <span class=\"variable\">cmd_java</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;whoami&quot;</span>.getBytes(StandardCharsets.UTF_8);</span><br><span class=\"line\">            <span class=\"type\">var</span> <span class=\"variable\">cmd_cnative</span> <span class=\"operator\">=</span> allocator.allocate(cmd_java.length + <span class=\"number\">1</span>);</span><br><span class=\"line\">            cmd_cnative.copyFrom(MemorySegment.ofArray(cmd_java));</span><br><span class=\"line\">            MemoryAccess.setByteAtOffset(cmd_cnative, cmd_java.length, (<span class=\"type\">byte</span>) <span class=\"number\">0</span> <span class=\"comment\">/* \\u0000 */</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"type\">var</span> <span class=\"variable\">$</span> <span class=\"operator\">=</span> (<span class=\"type\">int</span>) mh.invokeExact((Addressable) system, cmd_cnative.address());</span><br><span class=\"line\">            System.out.println($);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n"},{"title":"使用自定义 CA 生成 HTTPS 证书","date":"2022-06-01T16:00:01.000Z","categates":["TLS"],"description":"Raw JavaCode","_content":"\n```java\npackage io.github.karlatemp.jmse.kit;\n\nimport org.bouncycastle.asn1.*;\nimport org.bouncycastle.asn1.x509.*;\nimport org.bouncycastle.jce.X509Principal;\nimport org.bouncycastle.jce.provider.BouncyCastleProvider;\nimport org.bouncycastle.util.io.pem.PemObject;\nimport org.bouncycastle.util.io.pem.PemWriter;\nimport org.bouncycastle.x509.X509V3CertificateGenerator;\n\nimport java.io.File;\nimport java.io.FileInputStream;\nimport java.math.BigInteger;\nimport java.net.InetAddress;\nimport java.nio.charset.StandardCharsets;\nimport java.nio.file.Files;\nimport java.security.KeyFactory;\nimport java.security.KeyPairGenerator;\nimport java.security.Security;\nimport java.security.cert.CertificateFactory;\nimport java.security.cert.X509Certificate;\nimport java.security.spec.PKCS8EncodedKeySpec;\nimport java.util.Date;\nimport java.util.HashMap;\nimport java.util.Hashtable;\nimport java.util.concurrent.TimeUnit;\nimport java.util.random.RandomGenerator;\n\n@SuppressWarnings(\"resource\")\npublic class SubKeyCreation {\n    public static void main(String[] args) throws Throwable {\n        var webname = \"localhost\";\n        var outDir = new File(\"B:/ootx\").toPath();\n        var provider = new BouncyCastleProvider();\n        Security.addProvider(provider);\n        var caRootFile = new File(\"Karlatemp.ssl.crt\");\n        var caRootCert = (X509Certificate) CertificateFactory.getInstance(\"X.509\", provider)\n                .generateCertificate(new FileInputStream(caRootFile));\n        System.out.println(caRootCert);\n        var caRootPwd = KeyFactory.getInstance(\"RSA\", provider)\n                .generatePrivate(new PKCS8EncodedKeySpec(\n                        new FileInputStream(\"Karlatemp.ssl.private.pem\").readAllBytes()\n                ));\n        System.out.println(caRootPwd);\n\n\n        X509V3CertificateGenerator generator = new X509V3CertificateGenerator();\n        generator.setIssuerDN(caRootCert.getSubjectX500Principal());\n        {\n            var num = new StringBuilder();\n            var rand = RandomGenerator.getDefault();\n            while (num.length() < 32) {\n                num.append(Integer.toHexString(rand.nextInt() & 0xF));\n            }\n            generator.setSerialNumber(new BigInteger(num.toString(), 16));\n        }\n        {\n            var mp = new HashMap<>();\n            mp.put(X509Name.C, \"AU\");\n            mp.put(X509Name.ST, \"Some-State\");\n            mp.put(X509Name.O, \"Internet SK ROX Ltd\");\n            mp.put(X509Name.CN, \"localhost\");\n            mp.put(X509Name.E, \"noreply@noreply.github.com\");\n\n            generator.setSubjectDN(new X509Principal(\n                    new Hashtable<>(mp)\n            ));\n        }\n        var generateKeyPair = KeyPairGenerator.getInstance(\"RSA\", provider).generateKeyPair();\n        {\n            // System.out.println(kp);\n            generator.setPublicKey(generateKeyPair.getPublic());\n            generator.setSignatureAlgorithm(\"SHA256withRSA\");\n        }\n        var now = System.currentTimeMillis();\n        generator.setNotBefore(new Date(now - TimeUnit.DAYS.toMillis(3)));\n        generator.setNotAfter(new Date(now + TimeUnit.DAYS.toMillis(365 * 5)));\n\n        {\n            generator.addExtension(Extension.keyUsage, false, new KeyUsage(\n                    KeyUsage.digitalSignature | KeyUsage.nonRepudiation | KeyUsage.keyEncipherment\n            ));\n            generator.addExtension(Extension.extendedKeyUsage, false, ExtendedKeyUsage.getInstance(\n                    new DERSequence(new ASN1Encodable[]{\n                            KeyPurposeId.id_kp_serverAuth,\n                            KeyPurposeId.id_kp_clientAuth,\n                            KeyPurposeId.id_kp_codeSigning,\n                            KeyPurposeId.id_kp_emailProtection,\n                            KeyPurposeId.id_kp_timeStamping,\n                    })\n            ));\n            generator.addExtension(Extension.subjectAlternativeName, false, new DERSequence(\n                    new ASN1Encodable[]{\n                            // IPv4\n                            new DERTaggedObject(false, BERTags.CONTEXT_SPECIFIC, 7, new DEROctetString(\n                                    InetAddress.getByName(\"192.168.1.103\").getAddress()\n                            )),\n                            // DNS Name\n                            new DERTaggedObject(false, BERTags.CONTEXT_SPECIFIC, 2, new DEROctetString(\n                                    webname.getBytes(StandardCharsets.UTF_8)\n                            )),\n                    }\n            ));\n        }\n        var out = generator.generate(caRootPwd);\n        System.out.println(out);\n\n        {\n            Files.createDirectories(outDir);\n            Files.write(outDir.resolve(webname + \".der\"), out.getEncoded());\n            Files.write(outDir.resolve(webname + \".pubkey\"), generateKeyPair.getPublic().getEncoded());\n            Files.write(outDir.resolve(webname + \".key\"), generateKeyPair.getPrivate().getEncoded());\n            try (var writer = new PemWriter(\n                    Files.newBufferedWriter(outDir.resolve(webname + \".crt\"))\n            )) {\n                writer.writeObject(new PemObject(\"CERTIFICATE\", out.getEncoded()));\n            }\n            try (var writer = new PemWriter(\n                    Files.newBufferedWriter(outDir.resolve(webname + \".crt.key\"))\n            )) {\n                writer.writeObject(new PemObject(\"PRIVATE KEY\", generateKeyPair.getPrivate().getEncoded()));\n            }\n        }\n    }\n}\n\n```\n","source":"_posts/tls/sub-cert-with-ca.md","raw":"---\ntitle: 使用自定义 CA 生成 HTTPS 证书\ndate: 2022-06-02 00:00:01\ncategates: [TLS]\ndescription: Raw JavaCode\n---\n\n```java\npackage io.github.karlatemp.jmse.kit;\n\nimport org.bouncycastle.asn1.*;\nimport org.bouncycastle.asn1.x509.*;\nimport org.bouncycastle.jce.X509Principal;\nimport org.bouncycastle.jce.provider.BouncyCastleProvider;\nimport org.bouncycastle.util.io.pem.PemObject;\nimport org.bouncycastle.util.io.pem.PemWriter;\nimport org.bouncycastle.x509.X509V3CertificateGenerator;\n\nimport java.io.File;\nimport java.io.FileInputStream;\nimport java.math.BigInteger;\nimport java.net.InetAddress;\nimport java.nio.charset.StandardCharsets;\nimport java.nio.file.Files;\nimport java.security.KeyFactory;\nimport java.security.KeyPairGenerator;\nimport java.security.Security;\nimport java.security.cert.CertificateFactory;\nimport java.security.cert.X509Certificate;\nimport java.security.spec.PKCS8EncodedKeySpec;\nimport java.util.Date;\nimport java.util.HashMap;\nimport java.util.Hashtable;\nimport java.util.concurrent.TimeUnit;\nimport java.util.random.RandomGenerator;\n\n@SuppressWarnings(\"resource\")\npublic class SubKeyCreation {\n    public static void main(String[] args) throws Throwable {\n        var webname = \"localhost\";\n        var outDir = new File(\"B:/ootx\").toPath();\n        var provider = new BouncyCastleProvider();\n        Security.addProvider(provider);\n        var caRootFile = new File(\"Karlatemp.ssl.crt\");\n        var caRootCert = (X509Certificate) CertificateFactory.getInstance(\"X.509\", provider)\n                .generateCertificate(new FileInputStream(caRootFile));\n        System.out.println(caRootCert);\n        var caRootPwd = KeyFactory.getInstance(\"RSA\", provider)\n                .generatePrivate(new PKCS8EncodedKeySpec(\n                        new FileInputStream(\"Karlatemp.ssl.private.pem\").readAllBytes()\n                ));\n        System.out.println(caRootPwd);\n\n\n        X509V3CertificateGenerator generator = new X509V3CertificateGenerator();\n        generator.setIssuerDN(caRootCert.getSubjectX500Principal());\n        {\n            var num = new StringBuilder();\n            var rand = RandomGenerator.getDefault();\n            while (num.length() < 32) {\n                num.append(Integer.toHexString(rand.nextInt() & 0xF));\n            }\n            generator.setSerialNumber(new BigInteger(num.toString(), 16));\n        }\n        {\n            var mp = new HashMap<>();\n            mp.put(X509Name.C, \"AU\");\n            mp.put(X509Name.ST, \"Some-State\");\n            mp.put(X509Name.O, \"Internet SK ROX Ltd\");\n            mp.put(X509Name.CN, \"localhost\");\n            mp.put(X509Name.E, \"noreply@noreply.github.com\");\n\n            generator.setSubjectDN(new X509Principal(\n                    new Hashtable<>(mp)\n            ));\n        }\n        var generateKeyPair = KeyPairGenerator.getInstance(\"RSA\", provider).generateKeyPair();\n        {\n            // System.out.println(kp);\n            generator.setPublicKey(generateKeyPair.getPublic());\n            generator.setSignatureAlgorithm(\"SHA256withRSA\");\n        }\n        var now = System.currentTimeMillis();\n        generator.setNotBefore(new Date(now - TimeUnit.DAYS.toMillis(3)));\n        generator.setNotAfter(new Date(now + TimeUnit.DAYS.toMillis(365 * 5)));\n\n        {\n            generator.addExtension(Extension.keyUsage, false, new KeyUsage(\n                    KeyUsage.digitalSignature | KeyUsage.nonRepudiation | KeyUsage.keyEncipherment\n            ));\n            generator.addExtension(Extension.extendedKeyUsage, false, ExtendedKeyUsage.getInstance(\n                    new DERSequence(new ASN1Encodable[]{\n                            KeyPurposeId.id_kp_serverAuth,\n                            KeyPurposeId.id_kp_clientAuth,\n                            KeyPurposeId.id_kp_codeSigning,\n                            KeyPurposeId.id_kp_emailProtection,\n                            KeyPurposeId.id_kp_timeStamping,\n                    })\n            ));\n            generator.addExtension(Extension.subjectAlternativeName, false, new DERSequence(\n                    new ASN1Encodable[]{\n                            // IPv4\n                            new DERTaggedObject(false, BERTags.CONTEXT_SPECIFIC, 7, new DEROctetString(\n                                    InetAddress.getByName(\"192.168.1.103\").getAddress()\n                            )),\n                            // DNS Name\n                            new DERTaggedObject(false, BERTags.CONTEXT_SPECIFIC, 2, new DEROctetString(\n                                    webname.getBytes(StandardCharsets.UTF_8)\n                            )),\n                    }\n            ));\n        }\n        var out = generator.generate(caRootPwd);\n        System.out.println(out);\n\n        {\n            Files.createDirectories(outDir);\n            Files.write(outDir.resolve(webname + \".der\"), out.getEncoded());\n            Files.write(outDir.resolve(webname + \".pubkey\"), generateKeyPair.getPublic().getEncoded());\n            Files.write(outDir.resolve(webname + \".key\"), generateKeyPair.getPrivate().getEncoded());\n            try (var writer = new PemWriter(\n                    Files.newBufferedWriter(outDir.resolve(webname + \".crt\"))\n            )) {\n                writer.writeObject(new PemObject(\"CERTIFICATE\", out.getEncoded()));\n            }\n            try (var writer = new PemWriter(\n                    Files.newBufferedWriter(outDir.resolve(webname + \".crt.key\"))\n            )) {\n                writer.writeObject(new PemObject(\"PRIVATE KEY\", generateKeyPair.getPrivate().getEncoded()));\n            }\n        }\n    }\n}\n\n```\n","slug":"tls/sub-cert-with-ca","published":1,"updated":"2022-06-02T09:01:03.978Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl3wsg2ca0000bvn5akoc94wb","content":"<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> io.github.karlatemp.jmse.kit;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.bouncycastle.asn1.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.bouncycastle.asn1.x509.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.bouncycastle.jce.X509Principal;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.bouncycastle.jce.provider.BouncyCastleProvider;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.bouncycastle.util.io.pem.PemObject;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.bouncycastle.util.io.pem.PemWriter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.bouncycastle.x509.X509V3CertificateGenerator;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.File;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.FileInputStream;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.math.BigInteger;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.InetAddress;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.charset.StandardCharsets;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.file.Files;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.KeyFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.KeyPairGenerator;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.Security;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.cert.CertificateFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.cert.X509Certificate;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.spec.PKCS8EncodedKeySpec;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Date;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Hashtable;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.TimeUnit;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.random.RandomGenerator;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@SuppressWarnings(&quot;resource&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">SubKeyCreation</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Throwable &#123;</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">webname</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;localhost&quot;</span>;</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">outDir</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">File</span>(<span class=\"string\">&quot;B:/ootx&quot;</span>).toPath();</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">provider</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">BouncyCastleProvider</span>();</span><br><span class=\"line\">        Security.addProvider(provider);</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">caRootFile</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">File</span>(<span class=\"string\">&quot;Karlatemp.ssl.crt&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">caRootCert</span> <span class=\"operator\">=</span> (X509Certificate) CertificateFactory.getInstance(<span class=\"string\">&quot;X.509&quot;</span>, provider)</span><br><span class=\"line\">                .generateCertificate(<span class=\"keyword\">new</span> <span class=\"title class_\">FileInputStream</span>(caRootFile));</span><br><span class=\"line\">        System.out.println(caRootCert);</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">caRootPwd</span> <span class=\"operator\">=</span> KeyFactory.getInstance(<span class=\"string\">&quot;RSA&quot;</span>, provider)</span><br><span class=\"line\">                .generatePrivate(<span class=\"keyword\">new</span> <span class=\"title class_\">PKCS8EncodedKeySpec</span>(</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> <span class=\"title class_\">FileInputStream</span>(<span class=\"string\">&quot;Karlatemp.ssl.private.pem&quot;</span>).readAllBytes()</span><br><span class=\"line\">                ));</span><br><span class=\"line\">        System.out.println(caRootPwd);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">X509V3CertificateGenerator</span> <span class=\"variable\">generator</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">X509V3CertificateGenerator</span>();</span><br><span class=\"line\">        generator.setIssuerDN(caRootCert.getSubjectX500Principal());</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"type\">var</span> <span class=\"variable\">num</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">StringBuilder</span>();</span><br><span class=\"line\">            <span class=\"type\">var</span> <span class=\"variable\">rand</span> <span class=\"operator\">=</span> RandomGenerator.getDefault();</span><br><span class=\"line\">            <span class=\"keyword\">while</span> (num.length() &lt; <span class=\"number\">32</span>) &#123;</span><br><span class=\"line\">                num.append(Integer.toHexString(rand.nextInt() &amp; <span class=\"number\">0xF</span>));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            generator.setSerialNumber(<span class=\"keyword\">new</span> <span class=\"title class_\">BigInteger</span>(num.toString(), <span class=\"number\">16</span>));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"type\">var</span> <span class=\"variable\">mp</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();</span><br><span class=\"line\">            mp.put(X509Name.C, <span class=\"string\">&quot;AU&quot;</span>);</span><br><span class=\"line\">            mp.put(X509Name.ST, <span class=\"string\">&quot;Some-State&quot;</span>);</span><br><span class=\"line\">            mp.put(X509Name.O, <span class=\"string\">&quot;Internet SK ROX Ltd&quot;</span>);</span><br><span class=\"line\">            mp.put(X509Name.CN, <span class=\"string\">&quot;localhost&quot;</span>);</span><br><span class=\"line\">            mp.put(X509Name.E, <span class=\"string\">&quot;noreply@noreply.github.com&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            generator.setSubjectDN(<span class=\"keyword\">new</span> <span class=\"title class_\">X509Principal</span>(</span><br><span class=\"line\">                    <span class=\"keyword\">new</span> <span class=\"title class_\">Hashtable</span>&lt;&gt;(mp)</span><br><span class=\"line\">            ));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">generateKeyPair</span> <span class=\"operator\">=</span> KeyPairGenerator.getInstance(<span class=\"string\">&quot;RSA&quot;</span>, provider).generateKeyPair();</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"comment\">// System.out.println(kp);</span></span><br><span class=\"line\">            generator.setPublicKey(generateKeyPair.getPublic());</span><br><span class=\"line\">            generator.setSignatureAlgorithm(<span class=\"string\">&quot;SHA256withRSA&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">now</span> <span class=\"operator\">=</span> System.currentTimeMillis();</span><br><span class=\"line\">        generator.setNotBefore(<span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>(now - TimeUnit.DAYS.toMillis(<span class=\"number\">3</span>)));</span><br><span class=\"line\">        generator.setNotAfter(<span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>(now + TimeUnit.DAYS.toMillis(<span class=\"number\">365</span> * <span class=\"number\">5</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            generator.addExtension(Extension.keyUsage, <span class=\"literal\">false</span>, <span class=\"keyword\">new</span> <span class=\"title class_\">KeyUsage</span>(</span><br><span class=\"line\">                    KeyUsage.digitalSignature | KeyUsage.nonRepudiation | KeyUsage.keyEncipherment</span><br><span class=\"line\">            ));</span><br><span class=\"line\">            generator.addExtension(Extension.extendedKeyUsage, <span class=\"literal\">false</span>, ExtendedKeyUsage.getInstance(</span><br><span class=\"line\">                    <span class=\"keyword\">new</span> <span class=\"title class_\">DERSequence</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">ASN1Encodable</span>[]&#123;</span><br><span class=\"line\">                            KeyPurposeId.id_kp_serverAuth,</span><br><span class=\"line\">                            KeyPurposeId.id_kp_clientAuth,</span><br><span class=\"line\">                            KeyPurposeId.id_kp_codeSigning,</span><br><span class=\"line\">                            KeyPurposeId.id_kp_emailProtection,</span><br><span class=\"line\">                            KeyPurposeId.id_kp_timeStamping,</span><br><span class=\"line\">                    &#125;)</span><br><span class=\"line\">            ));</span><br><span class=\"line\">            generator.addExtension(Extension.subjectAlternativeName, <span class=\"literal\">false</span>, <span class=\"keyword\">new</span> <span class=\"title class_\">DERSequence</span>(</span><br><span class=\"line\">                    <span class=\"keyword\">new</span> <span class=\"title class_\">ASN1Encodable</span>[]&#123;</span><br><span class=\"line\">                            <span class=\"comment\">// IPv4</span></span><br><span class=\"line\">                            <span class=\"keyword\">new</span> <span class=\"title class_\">DERTaggedObject</span>(<span class=\"literal\">false</span>, BERTags.CONTEXT_SPECIFIC, <span class=\"number\">7</span>, <span class=\"keyword\">new</span> <span class=\"title class_\">DEROctetString</span>(</span><br><span class=\"line\">                                    InetAddress.getByName(<span class=\"string\">&quot;192.168.1.103&quot;</span>).getAddress()</span><br><span class=\"line\">                            )),</span><br><span class=\"line\">                            <span class=\"comment\">// DNS Name</span></span><br><span class=\"line\">                            <span class=\"keyword\">new</span> <span class=\"title class_\">DERTaggedObject</span>(<span class=\"literal\">false</span>, BERTags.CONTEXT_SPECIFIC, <span class=\"number\">2</span>, <span class=\"keyword\">new</span> <span class=\"title class_\">DEROctetString</span>(</span><br><span class=\"line\">                                    webname.getBytes(StandardCharsets.UTF_8)</span><br><span class=\"line\">                            )),</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">            ));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">out</span> <span class=\"operator\">=</span> generator.generate(caRootPwd);</span><br><span class=\"line\">        System.out.println(out);</span><br><span class=\"line\"></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Files.createDirectories(outDir);</span><br><span class=\"line\">            Files.write(outDir.resolve(webname + <span class=\"string\">&quot;.der&quot;</span>), out.getEncoded());</span><br><span class=\"line\">            Files.write(outDir.resolve(webname + <span class=\"string\">&quot;.pubkey&quot;</span>), generateKeyPair.getPublic().getEncoded());</span><br><span class=\"line\">            Files.write(outDir.resolve(webname + <span class=\"string\">&quot;.key&quot;</span>), generateKeyPair.getPrivate().getEncoded());</span><br><span class=\"line\">            <span class=\"keyword\">try</span> (<span class=\"type\">var</span> <span class=\"variable\">writer</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">PemWriter</span>(</span><br><span class=\"line\">                    Files.newBufferedWriter(outDir.resolve(webname + <span class=\"string\">&quot;.crt&quot;</span>))</span><br><span class=\"line\">            )) &#123;</span><br><span class=\"line\">                writer.writeObject(<span class=\"keyword\">new</span> <span class=\"title class_\">PemObject</span>(<span class=\"string\">&quot;CERTIFICATE&quot;</span>, out.getEncoded()));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> (<span class=\"type\">var</span> <span class=\"variable\">writer</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">PemWriter</span>(</span><br><span class=\"line\">                    Files.newBufferedWriter(outDir.resolve(webname + <span class=\"string\">&quot;.crt.key&quot;</span>))</span><br><span class=\"line\">            )) &#123;</span><br><span class=\"line\">                writer.writeObject(<span class=\"keyword\">new</span> <span class=\"title class_\">PemObject</span>(<span class=\"string\">&quot;PRIVATE KEY&quot;</span>, generateKeyPair.getPrivate().getEncoded()));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n","site":{"data":{"link":[{"class_name":"友情链接","class_desc":"友情链接","link_list":[{"name":"暂无","link":"","avatar":"","descr":"暂无"}]}]}},"cover":"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7","excerpt":"","more":"<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> io.github.karlatemp.jmse.kit;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.bouncycastle.asn1.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.bouncycastle.asn1.x509.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.bouncycastle.jce.X509Principal;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.bouncycastle.jce.provider.BouncyCastleProvider;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.bouncycastle.util.io.pem.PemObject;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.bouncycastle.util.io.pem.PemWriter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.bouncycastle.x509.X509V3CertificateGenerator;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.File;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.FileInputStream;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.math.BigInteger;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.net.InetAddress;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.charset.StandardCharsets;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.nio.file.Files;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.KeyFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.KeyPairGenerator;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.Security;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.cert.CertificateFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.cert.X509Certificate;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.security.spec.PKCS8EncodedKeySpec;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Date;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.HashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Hashtable;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.TimeUnit;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.random.RandomGenerator;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@SuppressWarnings(&quot;resource&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">SubKeyCreation</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Throwable &#123;</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">webname</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;localhost&quot;</span>;</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">outDir</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">File</span>(<span class=\"string\">&quot;B:/ootx&quot;</span>).toPath();</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">provider</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">BouncyCastleProvider</span>();</span><br><span class=\"line\">        Security.addProvider(provider);</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">caRootFile</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">File</span>(<span class=\"string\">&quot;Karlatemp.ssl.crt&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">caRootCert</span> <span class=\"operator\">=</span> (X509Certificate) CertificateFactory.getInstance(<span class=\"string\">&quot;X.509&quot;</span>, provider)</span><br><span class=\"line\">                .generateCertificate(<span class=\"keyword\">new</span> <span class=\"title class_\">FileInputStream</span>(caRootFile));</span><br><span class=\"line\">        System.out.println(caRootCert);</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">caRootPwd</span> <span class=\"operator\">=</span> KeyFactory.getInstance(<span class=\"string\">&quot;RSA&quot;</span>, provider)</span><br><span class=\"line\">                .generatePrivate(<span class=\"keyword\">new</span> <span class=\"title class_\">PKCS8EncodedKeySpec</span>(</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> <span class=\"title class_\">FileInputStream</span>(<span class=\"string\">&quot;Karlatemp.ssl.private.pem&quot;</span>).readAllBytes()</span><br><span class=\"line\">                ));</span><br><span class=\"line\">        System.out.println(caRootPwd);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">X509V3CertificateGenerator</span> <span class=\"variable\">generator</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">X509V3CertificateGenerator</span>();</span><br><span class=\"line\">        generator.setIssuerDN(caRootCert.getSubjectX500Principal());</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"type\">var</span> <span class=\"variable\">num</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">StringBuilder</span>();</span><br><span class=\"line\">            <span class=\"type\">var</span> <span class=\"variable\">rand</span> <span class=\"operator\">=</span> RandomGenerator.getDefault();</span><br><span class=\"line\">            <span class=\"keyword\">while</span> (num.length() &lt; <span class=\"number\">32</span>) &#123;</span><br><span class=\"line\">                num.append(Integer.toHexString(rand.nextInt() &amp; <span class=\"number\">0xF</span>));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            generator.setSerialNumber(<span class=\"keyword\">new</span> <span class=\"title class_\">BigInteger</span>(num.toString(), <span class=\"number\">16</span>));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"type\">var</span> <span class=\"variable\">mp</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">HashMap</span>&lt;&gt;();</span><br><span class=\"line\">            mp.put(X509Name.C, <span class=\"string\">&quot;AU&quot;</span>);</span><br><span class=\"line\">            mp.put(X509Name.ST, <span class=\"string\">&quot;Some-State&quot;</span>);</span><br><span class=\"line\">            mp.put(X509Name.O, <span class=\"string\">&quot;Internet SK ROX Ltd&quot;</span>);</span><br><span class=\"line\">            mp.put(X509Name.CN, <span class=\"string\">&quot;localhost&quot;</span>);</span><br><span class=\"line\">            mp.put(X509Name.E, <span class=\"string\">&quot;noreply@noreply.github.com&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            generator.setSubjectDN(<span class=\"keyword\">new</span> <span class=\"title class_\">X509Principal</span>(</span><br><span class=\"line\">                    <span class=\"keyword\">new</span> <span class=\"title class_\">Hashtable</span>&lt;&gt;(mp)</span><br><span class=\"line\">            ));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">generateKeyPair</span> <span class=\"operator\">=</span> KeyPairGenerator.getInstance(<span class=\"string\">&quot;RSA&quot;</span>, provider).generateKeyPair();</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"comment\">// System.out.println(kp);</span></span><br><span class=\"line\">            generator.setPublicKey(generateKeyPair.getPublic());</span><br><span class=\"line\">            generator.setSignatureAlgorithm(<span class=\"string\">&quot;SHA256withRSA&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">now</span> <span class=\"operator\">=</span> System.currentTimeMillis();</span><br><span class=\"line\">        generator.setNotBefore(<span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>(now - TimeUnit.DAYS.toMillis(<span class=\"number\">3</span>)));</span><br><span class=\"line\">        generator.setNotAfter(<span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>(now + TimeUnit.DAYS.toMillis(<span class=\"number\">365</span> * <span class=\"number\">5</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            generator.addExtension(Extension.keyUsage, <span class=\"literal\">false</span>, <span class=\"keyword\">new</span> <span class=\"title class_\">KeyUsage</span>(</span><br><span class=\"line\">                    KeyUsage.digitalSignature | KeyUsage.nonRepudiation | KeyUsage.keyEncipherment</span><br><span class=\"line\">            ));</span><br><span class=\"line\">            generator.addExtension(Extension.extendedKeyUsage, <span class=\"literal\">false</span>, ExtendedKeyUsage.getInstance(</span><br><span class=\"line\">                    <span class=\"keyword\">new</span> <span class=\"title class_\">DERSequence</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">ASN1Encodable</span>[]&#123;</span><br><span class=\"line\">                            KeyPurposeId.id_kp_serverAuth,</span><br><span class=\"line\">                            KeyPurposeId.id_kp_clientAuth,</span><br><span class=\"line\">                            KeyPurposeId.id_kp_codeSigning,</span><br><span class=\"line\">                            KeyPurposeId.id_kp_emailProtection,</span><br><span class=\"line\">                            KeyPurposeId.id_kp_timeStamping,</span><br><span class=\"line\">                    &#125;)</span><br><span class=\"line\">            ));</span><br><span class=\"line\">            generator.addExtension(Extension.subjectAlternativeName, <span class=\"literal\">false</span>, <span class=\"keyword\">new</span> <span class=\"title class_\">DERSequence</span>(</span><br><span class=\"line\">                    <span class=\"keyword\">new</span> <span class=\"title class_\">ASN1Encodable</span>[]&#123;</span><br><span class=\"line\">                            <span class=\"comment\">// IPv4</span></span><br><span class=\"line\">                            <span class=\"keyword\">new</span> <span class=\"title class_\">DERTaggedObject</span>(<span class=\"literal\">false</span>, BERTags.CONTEXT_SPECIFIC, <span class=\"number\">7</span>, <span class=\"keyword\">new</span> <span class=\"title class_\">DEROctetString</span>(</span><br><span class=\"line\">                                    InetAddress.getByName(<span class=\"string\">&quot;192.168.1.103&quot;</span>).getAddress()</span><br><span class=\"line\">                            )),</span><br><span class=\"line\">                            <span class=\"comment\">// DNS Name</span></span><br><span class=\"line\">                            <span class=\"keyword\">new</span> <span class=\"title class_\">DERTaggedObject</span>(<span class=\"literal\">false</span>, BERTags.CONTEXT_SPECIFIC, <span class=\"number\">2</span>, <span class=\"keyword\">new</span> <span class=\"title class_\">DEROctetString</span>(</span><br><span class=\"line\">                                    webname.getBytes(StandardCharsets.UTF_8)</span><br><span class=\"line\">                            )),</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">            ));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">var</span> <span class=\"variable\">out</span> <span class=\"operator\">=</span> generator.generate(caRootPwd);</span><br><span class=\"line\">        System.out.println(out);</span><br><span class=\"line\"></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            Files.createDirectories(outDir);</span><br><span class=\"line\">            Files.write(outDir.resolve(webname + <span class=\"string\">&quot;.der&quot;</span>), out.getEncoded());</span><br><span class=\"line\">            Files.write(outDir.resolve(webname + <span class=\"string\">&quot;.pubkey&quot;</span>), generateKeyPair.getPublic().getEncoded());</span><br><span class=\"line\">            Files.write(outDir.resolve(webname + <span class=\"string\">&quot;.key&quot;</span>), generateKeyPair.getPrivate().getEncoded());</span><br><span class=\"line\">            <span class=\"keyword\">try</span> (<span class=\"type\">var</span> <span class=\"variable\">writer</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">PemWriter</span>(</span><br><span class=\"line\">                    Files.newBufferedWriter(outDir.resolve(webname + <span class=\"string\">&quot;.crt&quot;</span>))</span><br><span class=\"line\">            )) &#123;</span><br><span class=\"line\">                writer.writeObject(<span class=\"keyword\">new</span> <span class=\"title class_\">PemObject</span>(<span class=\"string\">&quot;CERTIFICATE&quot;</span>, out.getEncoded()));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> (<span class=\"type\">var</span> <span class=\"variable\">writer</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">PemWriter</span>(</span><br><span class=\"line\">                    Files.newBufferedWriter(outDir.resolve(webname + <span class=\"string\">&quot;.crt.key&quot;</span>))</span><br><span class=\"line\">            )) &#123;</span><br><span class=\"line\">                writer.writeObject(<span class=\"keyword\">new</span> <span class=\"title class_\">PemObject</span>(<span class=\"string\">&quot;PRIVATE KEY&quot;</span>, generateKeyPair.getPrivate().getEncoded()));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"ckzzmscpk0003b5oe152y02tc","category_id":"ckzzmscpo0006b5oe2asi27ok","_id":"ckzzmscpt000db5oefk438ldm"},{"post_id":"ckzzmscpn0005b5oec39wes7w","category_id":"ckzzmscps000bb5oe1chj0is9","_id":"ckzzmscpv000gb5oehbp8h9z1"},{"post_id":"ckzzmscpq0009b5oe6vpg9k88","category_id":"ckzzmscps000bb5oe1chj0is9","_id":"ckzzmscpv000jb5oe06gd1qcz"},{"post_id":"cl0nwr8hv0000a8oq3i3ueqk2","category_id":"ckzzmscps000bb5oe1chj0is9","_id":"cl0nwr8i30002a8oq1egxb8sh"}],"PostTag":[{"post_id":"ckzzmscpk0003b5oe152y02tc","tag_id":"ckzzmscpp0007b5oectx60uvs","_id":"ckzzmscpv000ib5oe5r5969wl"},{"post_id":"ckzzmscpk0003b5oe152y02tc","tag_id":"ckzzmscps000cb5oef9hz0ety","_id":"ckzzmscpv000kb5oedek2hsej"},{"post_id":"ckzzmscpk0003b5oe152y02tc","tag_id":"ckzzmscpt000fb5oe63m85e0j","_id":"ckzzmscpw000mb5oe4tx52zlp"},{"post_id":"ckzzmscpn0005b5oec39wes7w","tag_id":"ckzzmscpv000hb5oe8i8583fq","_id":"ckzzmscpw000ob5oebos5br34"},{"post_id":"ckzzmscpn0005b5oec39wes7w","tag_id":"ckzzmscpw000lb5oe9ni9e8xa","_id":"ckzzmscpw000pb5oegc9lfsc6"},{"post_id":"ckzzmscpq0009b5oe6vpg9k88","tag_id":"ckzzmscpv000hb5oe8i8583fq","_id":"ckzzmscpy000sb5oe96l74b70"},{"post_id":"ckzzmscpq0009b5oe6vpg9k88","tag_id":"ckzzmscpx000qb5oe3pf2b4hh","_id":"ckzzmscpz000tb5oe5tet4t80"},{"post_id":"ckzzmscpq0009b5oe6vpg9k88","tag_id":"ckzzmscpw000lb5oe9ni9e8xa","_id":"ckzzmscpz000ub5oe6vof8ucd"},{"post_id":"cl0nwr8hv0000a8oq3i3ueqk2","tag_id":"ckzzmscpv000hb5oe8i8583fq","_id":"cl0nwr8i40003a8oqg2zi6iou"},{"post_id":"cl0nwr8hv0000a8oq3i3ueqk2","tag_id":"cl0nwr8i10001a8oq7yn51ma9","_id":"cl0nwr8i40004a8oqgjp224ph"}],"Tag":[{"name":"github","_id":"ckzzmscpp0007b5oectx60uvs"},{"name":"pr","_id":"ckzzmscps000cb5oef9hz0ety"},{"name":"review","_id":"ckzzmscpt000fb5oe63m85e0j"},{"name":"jvm","_id":"ckzzmscpv000hb5oe8i8583fq"},{"name":"jdk9","_id":"ckzzmscpw000lb5oe9ni9e8xa"},{"name":"root","_id":"ckzzmscpx000qb5oe3pf2b4hh"},{"name":"jdk.foreign","_id":"cl0nwr8i10001a8oq7yn51ma9"}]}}